<!doctype html>
<html lang="pt-BR">
<head>
<meta charset="utf-8"/>
<meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1, user-scalable=no">
<title>Equilibra 5.0</title>
<link rel="preconnect" href="https://fonts.googleapis.com">
<link href="https://fonts.googleapis.com/css2?family=Fraunces:opsz,wght@9..144,300;9..144,500;9..144,600&family=Plus+Jakarta+Sans:wght@400;500;600;700&display=swap" rel="stylesheet">
<script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.1/dist/chart.umd.min.js"></script>
<style>
:root{
  --g800:#14532d;--g700:#166534;--g600:#16a34a;--g500:#22c55e;
  --g400:#4ade80;--g300:#86efac;--g200:#bbf7d0;--g100:#dcfce7;--g50:#f0fdf4;
  --cream:#fafaf8;--cream2:#f4f3ee;--cream3:#e0ddd4;
  --ink:#0f1a13;--ink3:#3d6b4f;--muted:#6b8f77;
  --warn:#d97706;--warn-bg:#fffbeb;--warn-brd:#fcd34d;
  --red:#dc2626;--red-bg:#fef2f2;--red-brd:#fca5a5;
  --blue:#2563eb;--blue-bg:#eff6ff;--blue-brd:#bfdbfe;
  --r:14px;--rsm:9px;--rlg:22px;
  --sh:0 1px 3px rgba(15,26,19,.07);
  --shmd:0 4px 16px rgba(15,26,19,.09);
  --fs:'Fraunces',serif;--ss:'Plus Jakarta Sans',sans-serif;
}
*,*::before,*::after{box-sizing:border-box;margin:0;padding:0}
body{font-family:var(--ss);background:var(--cream);color:var(--ink);min-height:100vh;-webkit-font-smoothing:antialiased}

/* ANAMNESE */
.ana-ov{position:fixed;inset:0;z-index:900;background:#030f06;display:flex;flex-direction:column;overflow:hidden}
.ana-bg{position:absolute;inset:0;background:radial-gradient(ellipse at 30% 20%,rgba(22,163,74,.15),transparent 60%),radial-gradient(ellipse at 70% 80%,rgba(20,83,45,.3),transparent 60%);pointer-events:none}
.ana-prog{position:absolute;top:0;left:0;right:0;height:3px;background:rgba(255,255,255,.08)}
.ana-prog-fill{height:100%;background:linear-gradient(90deg,var(--g600),var(--g400));transition:width .5s ease}
.ana-body{flex:1;display:flex;flex-direction:column;padding:0;position:relative;z-index:1;max-width:560px;margin:0 auto;width:100%;overflow:hidden}
.ana-msgs{flex:1;overflow-y:auto;padding:60px 20px 16px;display:flex;flex-direction:column;gap:14px;scrollbar-width:none}
.ana-msgs::-webkit-scrollbar{display:none}
.msg{display:flex;gap:10px;animation:msgIn .35s ease}
@keyframes msgIn{from{opacity:0;transform:translateY(10px)}to{opacity:1;transform:none}}
.msg.usr{flex-direction:row-reverse}
.msg-av{width:34px;height:34px;border-radius:50%;flex-shrink:0;display:flex;align-items:center;justify-content:center;font-size:16px}
.msg-av.bot{background:linear-gradient(135deg,var(--g700),var(--g600))}
.msg-av.usr{background:rgba(255,255,255,.1)}
.msg-bubble{max-width:82%;padding:12px 15px;border-radius:18px;font-size:14px;line-height:1.65}
.msg-bubble.bot{background:rgba(255,255,255,.07);border:1px solid rgba(255,255,255,.08);color:rgba(255,255,255,.92);border-bottom-left-radius:4px}
.msg-bubble.usr{background:var(--g600);color:#fff;border-bottom-right-radius:4px}
.msg-bubble.clinical{background:rgba(74,222,128,.08);border:1px solid rgba(74,222,128,.2);color:rgba(255,255,255,.88)}
.msg-bubble strong{color:#fff}
.hint{font-size:12px;color:rgba(255,255,255,.45);margin-top:4px;display:block;font-style:italic}
.typing{display:flex;gap:4px;padding:14px 16px;background:rgba(255,255,255,.07);border:1px solid rgba(255,255,255,.08);border-radius:18px;border-bottom-left-radius:4px;width:fit-content}
.typing span{width:7px;height:7px;border-radius:50%;background:rgba(255,255,255,.4);animation:ty 1.2s infinite}
.typing span:nth-child(2){animation-delay:.2s}
.typing span:nth-child(3){animation-delay:.4s}
@keyframes ty{0%,60%,100%{transform:translateY(0)}30%{transform:translateY(-6px)}}
.ana-opts{display:flex;flex-direction:column;gap:8px;margin-top:4px}
.ana-opt{padding:12px 16px;border-radius:12px;border:1.5px solid rgba(255,255,255,.12);background:rgba(255,255,255,.04);color:rgba(255,255,255,.88);font-family:var(--ss);font-size:14px;font-weight:500;cursor:pointer;transition:all .18s;text-align:left;display:flex;align-items:center;gap:10px}
.ana-opt:hover,.ana-opt:active{border-color:var(--g400);background:rgba(74,222,128,.08);color:#fff}
.ana-opt-ic{font-size:18px;flex-shrink:0}
.ana-opt-sub{font-size:11px;color:rgba(255,255,255,.45);margin-top:1px}
.ana-opts-h{display:flex;flex-wrap:wrap;gap:7px;margin-top:4px}
.ana-chip{padding:8px 14px;border-radius:999px;border:1.5px solid rgba(255,255,255,.12);background:rgba(255,255,255,.04);color:rgba(255,255,255,.8);font-family:var(--ss);font-size:13px;font-weight:500;cursor:pointer;transition:all .18s}
.ana-chip.sel{border-color:var(--g500);background:rgba(74,222,128,.12);color:#fff}
.ana-num-inp{width:100%;padding:14px;border-radius:12px;border:1.5px solid rgba(255,255,255,.12);background:rgba(255,255,255,.06);color:#fff;font-family:var(--ss);font-size:20px;font-weight:600;outline:none;text-align:center;transition:border-color .18s;margin-bottom:6px}
.ana-num-inp:focus{border-color:var(--g400)}
.ana-num-inp::placeholder{color:rgba(255,255,255,.25);font-size:14px;font-weight:400}
.ana-num-confirm{width:100%;padding:13px;border-radius:12px;background:var(--g600);border:none;color:#fff;font-family:var(--ss);font-size:14px;font-weight:700;cursor:pointer;transition:all .18s}
.ana-num-confirm:hover{background:var(--g500)}
.ana-num-confirm:disabled{opacity:.35;cursor:not-allowed}
#anaInput{position:sticky;bottom:0;background:linear-gradient(to top,#030f06 80%,transparent);padding:12px 20px 24px;}
.ana-voice{width:100%;padding:10px;border-radius:12px;background:rgba(255,255,255,.04);border:1.5px solid rgba(255,255,255,.08);color:rgba(255,255,255,.5);font-family:var(--ss);font-size:12px;cursor:pointer;display:flex;align-items:center;justify-content:center;gap:6px;transition:all .18s;margin-top:6px}
.ana-voice:hover{border-color:var(--g400);color:var(--g300)}
.ana-voice.listening{border-color:#ef4444;color:#f87171;animation:pulse 1s infinite}
@keyframes pulse{0%,100%{opacity:1}50%{opacity:.5}}
.ana-done{flex:1;display:flex;flex-direction:column;align-items:center;justify-content:center;text-align:center;padding:28px 20px;position:relative;z-index:1}
.ana-done-ic{font-size:54px;margin-bottom:16px;animation:pop .5s ease}
@keyframes pop{0%{transform:scale(.5)}70%{transform:scale(1.15)}100%{transform:scale(1)}}
.ana-done-title{font-family:var(--fs);font-size:24px;color:#fff;font-weight:500;margin-bottom:10px;line-height:1.3}
.ana-done-sub{font-size:14px;color:var(--g200);line-height:1.7;max-width:320px;margin:0 auto 24px}
.ana-done-card{background:rgba(255,255,255,.06);border:1px solid rgba(255,255,255,.1);border-radius:14px;padding:16px 18px;width:100%;max-width:340px;text-align:left;margin-bottom:22px}
.ana-done-row{display:flex;justify-content:space-between;align-items:center;padding:5px 0;border-bottom:1px solid rgba(255,255,255,.06)}
.ana-done-row:last-child{border-bottom:none}
.ana-done-lbl{font-size:11px;color:rgba(255,255,255,.4);text-transform:uppercase;letter-spacing:.4px}
.ana-done-val{font-size:13px;font-weight:700;color:#fff}
.ana-done-val.green{color:var(--g400)}
.ana-done-btn{padding:14px 36px;border-radius:14px;background:linear-gradient(135deg,var(--g600),var(--g500));color:#fff;font-family:var(--ss);font-size:15px;font-weight:700;border:none;cursor:pointer;box-shadow:0 6px 24px rgba(34,197,94,.35);transition:all .2s}
.ana-done-btn:hover{transform:translateY(-2px);box-shadow:0 10px 30px rgba(34,197,94,.45)}

/* HEADER */
.hdr{background:var(--g800);position:sticky;top:0;z-index:200;box-shadow:0 2px 20px rgba(0,0,0,.25)}
.hdr-in{max-width:1100px;margin:0 auto;padding:0 18px;height:56px;display:flex;align-items:center;gap:12px}
.logo{display:flex;align-items:center;gap:10px;flex-shrink:0;cursor:pointer}
.logo-ic{width:34px;height:34px;background:linear-gradient(135deg,var(--g500),var(--g400));border-radius:10px;display:flex;align-items:center;justify-content:center;font-size:16px}
.logo-nm{font-family:var(--fs);font-size:19px;color:#fff;font-weight:500}
.logo-vr{font-size:9px;color:var(--g300);letter-spacing:.8px;text-transform:uppercase;margin-top:1px}
.nav{display:none}
.nb{display:none}
/* TAB BAR INFERIOR */
.tab-bar{position:fixed;bottom:0;left:0;right:0;z-index:500;background:var(--g800);border-top:1px solid rgba(255,255,255,.1);display:none;padding-bottom:env(safe-area-inset-bottom)}
.tab-bar-in{display:flex;max-width:600px;margin:0 auto}
.tb{flex:1;display:flex;flex-direction:column;align-items:center;justify-content:center;padding:8px 4px 10px;border:none;background:transparent;color:rgba(255,255,255,.45);font-family:var(--ss);font-size:10px;font-weight:600;cursor:pointer;transition:all .17s;gap:3px;min-height:56px}
.tb:hover{color:rgba(255,255,255,.75)}
.tb.on{color:var(--g400)}
.tb-ic{font-size:20px;line-height:1}
.tb-dot{width:4px;height:4px;border-radius:50%;background:var(--g400);margin-top:2px;opacity:0;transition:opacity .17s}
.tb.on .tb-dot{opacity:1}
/* ajuste wrap para nÃ£o ficar atrÃ¡s da tab bar */

/* LAYOUT */
.wrap{max-width:1100px;margin:0 auto;padding:20px 18px 90px}
.sec{display:none}
.sec.on{display:block;animation:fi .25s ease}
@keyframes fi{from{opacity:0;transform:translateY(6px)}to{opacity:1;transform:none}}
.pg-title{font-family:var(--fs);font-size:24px;color:var(--ink);margin-bottom:4px;font-weight:500}
.pg-sub{font-size:14px;color:var(--muted);margin-bottom:18px}

/* CARDS */
.narr{background:linear-gradient(135deg,var(--g800),var(--g700));border-radius:var(--rlg);padding:22px 24px;color:#fff;margin-bottom:14px}
.narr-tag{font-size:10px;text-transform:uppercase;letter-spacing:.8px;color:var(--g300);margin-bottom:6px;font-weight:700}
.narr-msg{font-family:var(--fs);font-size:19px;color:#fff;line-height:1.4;font-weight:500;margin-bottom:8px}
.narr-det{font-size:13px;color:var(--g200);line-height:1.6}
.narr-btn{display:inline-flex;align-items:center;gap:6px;margin-top:14px;padding:8px 15px;background:rgba(255,255,255,.12);border-radius:8px;font-size:13px;font-weight:600;color:#fff;border:none;cursor:pointer;font-family:var(--ss);transition:background .17s}
.narr-btn:hover{background:rgba(255,255,255,.2)}
.card{background:#fff;border-radius:var(--r);padding:20px 22px;box-shadow:var(--sh);border:1px solid rgba(15,26,19,.05);margin-bottom:14px}
.ct{font-family:var(--fs);font-size:18px;color:var(--ink);margin-bottom:3px;font-weight:500}
.cs{font-size:13px;color:var(--muted);margin-bottom:14px;line-height:1.5}

/* PROGRESSO HERO */
.prog-hero{background:linear-gradient(145deg,var(--g800) 0%,#0d3320 60%,#0a2018 100%);border-radius:var(--rlg);padding:22px;color:#fff;margin-bottom:14px;overflow:hidden;position:relative}
.prog-hero::after{content:'';position:absolute;top:-40px;right:-40px;width:200px;height:200px;border-radius:50%;background:radial-gradient(circle,rgba(34,197,94,.12),transparent 70%);pointer-events:none}
.prog-top{display:flex;align-items:center;gap:18px;margin-bottom:20px}
.prog-ring-wrap{position:relative;flex-shrink:0;width:90px;height:90px}
.prog-ring-wrap svg{transform:rotate(-90deg)}
.prog-ring-center{position:absolute;inset:0;display:flex;flex-direction:column;align-items:center;justify-content:center;text-align:center}
.prog-ring-pct{font-family:var(--fs);font-size:20px;font-weight:600;color:#fff;line-height:1}
.prog-ring-lbl{font-size:9px;text-transform:uppercase;letter-spacing:.5px;color:var(--g300);margin-top:2px}
.prog-info{flex:1}
.prog-tag{font-size:10px;text-transform:uppercase;letter-spacing:.8px;color:var(--g300);margin-bottom:4px;font-weight:700}
.prog-weight{font-family:var(--fs);font-size:36px;font-weight:500;color:#fff;line-height:1;margin-bottom:2px}
.prog-delta{font-size:13px;font-weight:700;color:var(--g400);margin-bottom:4px}
.prog-moti{font-size:12px;color:rgba(255,255,255,.6);line-height:1.45}
.prog-journey{margin-bottom:18px}
.prog-journey-lbl{font-size:10px;text-transform:uppercase;letter-spacing:.6px;color:rgba(255,255,255,.4);margin-bottom:8px}
.prog-road{position:relative;height:6px;background:rgba(255,255,255,.1);border-radius:999px;margin:0 4px}
.prog-road-fill{position:absolute;left:0;top:0;height:100%;border-radius:999px;background:linear-gradient(90deg,var(--g600),var(--g400));transition:width .8s cubic-bezier(.34,1.56,.64,1)}
.prog-dots{display:flex;justify-content:space-between;margin-top:8px}
.prog-dot-wrap{display:flex;flex-direction:column;align-items:center;gap:3px}
.prog-dot{width:12px;height:12px;border-radius:50%;border:2px solid rgba(255,255,255,.3);background:rgba(255,255,255,.1)}
.prog-dot.start{background:rgba(255,255,255,.4);border-color:rgba(255,255,255,.6)}
.prog-dot.current{background:var(--g400);border-color:var(--g400);box-shadow:0 0 0 3px rgba(74,222,128,.25);width:14px;height:14px}
.prog-dot.goal{background:transparent;border-color:rgba(255,255,255,.4);border-style:dashed}
.prog-dot-lbl{font-size:9px;color:rgba(255,255,255,.45);text-align:center;max-width:50px;line-height:1.3}
.prog-dot-val{font-size:11px;font-weight:700;color:rgba(255,255,255,.75)}
.prog-kpis{display:grid;grid-template-columns:1fr 1fr 1fr;gap:8px;margin-bottom:14px}
.prog-kpi{background:rgba(255,255,255,.06);border:1px solid rgba(255,255,255,.08);border-radius:10px;padding:10px 12px;text-align:center}
.prog-kpi.highlight{background:rgba(74,222,128,.1);border-color:rgba(74,222,128,.25)}
.prog-kpl{font-size:9px;text-transform:uppercase;letter-spacing:.5px;color:rgba(255,255,255,.4);margin-bottom:3px}
.prog-kpv{font-size:16px;font-weight:700;color:#fff}
.prog-kph{font-size:10px;color:rgba(255,255,255,.35);margin-top:1px}
.prog-no-goal{background:rgba(255,255,255,.05);border:1.5px dashed rgba(255,255,255,.15);border-radius:10px;padding:12px;text-align:center;font-size:13px;color:rgba(255,255,255,.5);cursor:pointer;transition:all .18s}
.prog-no-goal:hover{border-color:var(--g400);color:var(--g300)}
.prog-chart-wrap{background:rgba(255,255,255,.04);border:1px solid rgba(255,255,255,.08);border-radius:12px;padding:12px;margin-top:2px}
.prog-chart-empty{text-align:center;padding:20px;font-size:12px;color:rgba(255,255,255,.35);line-height:1.6}
.prog-urine{display:inline-flex;align-items:center;gap:6px;margin-top:8px;padding:4px 10px;border-radius:999px;font-size:11px;font-weight:600;background:rgba(255,255,255,.08);border:1px solid rgba(255,255,255,.1);color:rgba(255,255,255,.7)}

/* KPIS */
.kg{display:grid;grid-template-columns:repeat(auto-fill,minmax(145px,1fr));gap:10px;margin-bottom:6px}
.kb{background:var(--g50);border:1px solid var(--g200);border-radius:var(--rsm);padding:12px 14px}
.kl{font-size:10px;font-weight:700;text-transform:uppercase;letter-spacing:.6px;color:var(--muted);margin-bottom:5px}
.kv{font-size:22px;font-weight:700;color:var(--ink);line-height:1}
.kh{font-size:12px;color:var(--muted);margin-top:4px}
.exp-btn{display:inline-flex;align-items:center;gap:3px;margin-top:7px;padding:3px 8px;border-radius:999px;border:1.5px solid var(--g300);background:transparent;color:var(--g700);font-family:var(--ss);font-size:11px;font-weight:600;cursor:pointer}
.exp-arr{transition:transform .2s;display:inline-block}
.exp-btn.open .exp-arr{transform:rotate(180deg)}
.exp-box{display:none;margin-top:8px;padding:9px 11px;background:var(--g50);border:1px solid var(--g200);border-radius:var(--rsm);font-size:12px;color:var(--ink3);line-height:1.65}
.exp-box.open{display:block}

/* STATUS / ALERTS */
.streak{display:flex;align-items:center;gap:10px;background:linear-gradient(135deg,var(--g800),var(--g700));border-radius:var(--rsm);padding:12px 16px;margin-bottom:14px;color:#fff}
.streak-num{font-family:var(--fs);font-size:22px;color:#fff;font-weight:500}
.streak-lbl{font-size:10px;color:var(--g300)}
.milestone{background:linear-gradient(135deg,#1e3a6e,#1d4ed8);border-radius:var(--rsm);padding:14px 18px;color:#fff;display:flex;align-items:center;gap:14px;margin-bottom:14px}
.tag{display:inline-flex;align-items:center;padding:4px 10px;border-radius:999px;font-size:12px;font-weight:600}
.tg{background:var(--g100);color:var(--g700);border:1px solid var(--g300)}
.tw{background:#fef9c3;color:#854d0e;border:1px solid #fde047}
.tr{background:var(--red-bg);color:var(--red);border:1px solid var(--red-brd)}
.tb{background:var(--blue-bg);color:var(--blue);border:1px solid var(--blue-brd)}
.alert{border-radius:var(--rsm);padding:12px 14px;font-size:13px;font-weight:500;margin-bottom:12px}
.alert-r{background:var(--red-bg);border:1px solid var(--red-brd);color:var(--red)}
.alert-w{background:var(--warn-bg);border:1px solid var(--warn-brd);color:var(--warn)}
.alert-g{background:var(--g50);border:1px solid var(--g300);color:var(--g700)}
.sbar{border-radius:var(--r);padding:14px 20px;display:flex;align-items:center;gap:14px;flex-wrap:wrap;margin-bottom:14px}
.sbar-green{background:linear-gradient(135deg,var(--g800),var(--g700))}
.sbar-warn{background:linear-gradient(135deg,#78350f,#92400e)}
.sbar-red{background:linear-gradient(135deg,#7f1d1d,#991b1b)}
.sl{font-family:var(--fs);font-size:17px;color:#fff;font-weight:500}
.sm{font-size:13px;color:rgba(255,255,255,.75);margin-top:2px}

/* FORMS */
.fg{display:grid;grid-template-columns:repeat(auto-fill,minmax(178px,1fr));gap:14px}
.fi{display:flex;flex-direction:column;gap:5px}
.fi label{font-size:11px;font-weight:700;color:var(--ink3);text-transform:uppercase;letter-spacing:.5px}
.fi input,.fi select,.fi textarea{padding:10px 12px;border-radius:var(--rsm);border:1.5px solid var(--cream3);background:var(--cream);color:var(--ink);font-family:var(--ss);font-size:14px;outline:none;transition:border-color .18s}
.fi input:focus,.fi select:focus,.fi textarea:focus{border-color:var(--g500);background:#fff}
.btn{display:inline-flex;align-items:center;justify-content:center;gap:6px;padding:10px 18px;border-radius:var(--rsm);border:none;font-family:var(--ss);font-size:14px;font-weight:600;cursor:pointer;transition:all .18s;white-space:nowrap}
.bp{background:linear-gradient(135deg,var(--g600),var(--g500));color:#fff}
.bp:hover{transform:translateY(-1px);box-shadow:0 4px 14px rgba(34,197,94,.35)}
.bg2{background:transparent;color:var(--ink3);border:1.5px solid var(--cream3)}
.bg2:hover{border-color:var(--g400);color:var(--g700);background:var(--g50)}
.bdanger{background:transparent;color:var(--muted);border:1.5px solid var(--cream3);font-size:12px;padding:7px 12px}
.bdanger:hover{border-color:var(--red-brd);color:var(--red);background:var(--red-bg)}
.row{display:flex;gap:10px;flex-wrap:wrap;align-items:center}
.ml{margin-left:auto}
.divider{height:1px;background:var(--cream2);margin:18px 0}
.note{font-size:13px;color:var(--muted);line-height:1.6}

/* CHECK-IN */
.ci-grid{display:grid;grid-template-columns:1fr 1fr;gap:12px;margin-bottom:12px}
.ci-card{border-radius:var(--rsm);padding:15px;border:2px solid var(--cream3);background:var(--cream);cursor:pointer;transition:all .18s;text-align:center}
.ci-card.good{border-color:var(--g500);background:var(--g50)}
.ci-card.bad{border-color:var(--warn);background:var(--warn-bg)}
.ci-icon{font-size:26px;margin-bottom:6px}
.ci-lbl{font-size:13px;font-weight:600;color:var(--ink)}
.ci-sub{font-size:11px;color:var(--muted);margin-top:3px}
.ci-act{background:var(--g50);border:1px solid var(--g200);border-radius:var(--rsm);padding:12px 14px;font-size:13px;color:var(--ink3);line-height:1.6;margin-top:10px;display:none}
.ci-act.show{display:block}
.chips{display:flex;gap:7px;flex-wrap:wrap;margin-top:10px}
.chip{padding:5px 12px;border-radius:999px;border:1.5px solid var(--cream3);background:#fff;font-size:12px;font-weight:600;cursor:pointer;color:var(--ink3);transition:all .15s}
.chip.on{border-color:var(--warn);background:var(--warn-bg);color:var(--warn)}
.chip-act{margin-top:10px;font-size:12px;color:var(--ink3);line-height:1.65;padding:10px 12px;background:var(--warn-bg);border:1px solid var(--warn-brd);border-radius:var(--rsm);display:none}
.chip-act.show{display:block}
.wbs{display:flex;gap:7px;flex-wrap:wrap;margin-top:7px}
.wb{padding:5px 11px;border-radius:999px;border:1.5px solid var(--g300);background:var(--g50);color:var(--g700);font-family:var(--ss);font-size:12px;font-weight:600;cursor:pointer}
.wb:hover{background:var(--g200)}

/* FASE SACIEDADE */
.fase-opts{display:flex;flex-direction:column;gap:8px;margin:10px 0}
.fase-opt{padding:12px 14px;border-radius:var(--rsm);border:2px solid var(--cream3);background:var(--cream);cursor:pointer;transition:all .17s;display:flex;align-items:flex-start;gap:11px}
.fase-opt.ok{border-color:var(--g500);background:var(--g50)}
.fase-opt.warn{border-color:var(--warn);background:var(--warn-bg)}
.fase-opt.danger{border-color:var(--red);background:var(--red-bg)}
.fase-dot{width:10px;height:10px;border-radius:50%;flex-shrink:0;margin-top:4px}
.fase-ttl{font-size:14px;font-weight:700;color:var(--ink)}
.fase-sub{font-size:12px;color:var(--muted);margin-top:2px;line-height:1.45}
.fase-fb{border-radius:var(--rsm);padding:12px 14px;font-size:13px;line-height:1.65;display:none;margin-top:8px}
.fase-fb.show{display:block}
.fb-ok{background:var(--g50);border:1px solid var(--g200);color:var(--ink3)}
.fb-warn{background:var(--warn-bg);border:1px solid var(--warn-brd);color:#78350f}
.fb-danger{background:var(--red-bg);border:1px solid var(--red-brd);color:var(--red)}

/* CANETA HERO */
.ch-hero{background:linear-gradient(135deg,var(--g800),var(--g700),var(--g600));border-radius:var(--rlg);padding:22px;color:#fff;margin-bottom:14px;position:relative;overflow:hidden}
.ch-hero::before{content:'ğŸ’‰';position:absolute;right:16px;top:50%;transform:translateY(-50%);font-size:58px;opacity:.1}
.ch-tag{font-size:10px;text-transform:uppercase;letter-spacing:.8px;color:var(--g300);margin-bottom:6px;font-weight:700}
.ch-drug{font-family:var(--fs);font-size:23px;color:#fff;font-weight:500}
.ch-dose{font-size:15px;color:var(--g200);margin-top:3px}
.ch-row{display:flex;gap:11px;flex-wrap:wrap;margin-top:13px}
.ch-kpi{background:rgba(255,255,255,.1);border-radius:10px;padding:9px 13px}
.ch-kl{font-size:10px;text-transform:uppercase;letter-spacing:.5px;color:var(--g300)}
.ch-kv{font-size:16px;font-weight:700;color:#fff;margin-top:2px}
.nd{background:linear-gradient(135deg,var(--g100),var(--g50));border:1px solid var(--g300);border-radius:var(--rsm);padding:13px 15px;display:flex;align-items:center;gap:12px}
.nd-lbl{font-size:10px;text-transform:uppercase;letter-spacing:.6px;color:var(--muted)}
.nd-val{font-size:16px;font-weight:700;color:var(--g700)}

/* TIMELINE */
.tl{position:relative;padding-left:22px}
.tl::before{content:'';position:absolute;left:8px;top:0;bottom:0;width:2px;background:var(--g200)}
.tl-step{position:relative;margin-bottom:12px}
.tl-step::before{content:'';position:absolute;left:-18px;top:5px;width:10px;height:10px;border-radius:50%;background:var(--g300);border:2px solid #fff;box-shadow:0 0 0 2px var(--g300)}
.tl-step.active::before{background:var(--g600);box-shadow:0 0 0 2px var(--g600)}
.tl-dose{font-size:14px;font-weight:700;color:var(--ink)}
.tl-info{font-size:12px;color:var(--muted);margin-top:2px;line-height:1.5}
.tl-step.active .tl-dose{color:var(--g600)}

/* CALCULADORA DILUIÃ‡ÃƒO */
.calc-hero{background:linear-gradient(135deg,#1e1b4b,#312e81);border-radius:var(--rlg);padding:22px;color:#fff;margin-bottom:14px}
.calc-tag{font-size:10px;text-transform:uppercase;letter-spacing:.8px;color:#a5b4fc;margin-bottom:6px;font-weight:700}
.calc-title{font-family:var(--fs);font-size:20px;color:#fff;font-weight:500;margin-bottom:4px}
.calc-sub{font-size:13px;color:#c7d2fe;line-height:1.5}
.calc-form{display:grid;grid-template-columns:1fr 1fr;gap:10px;margin-top:14px}
.calc-fi label{font-size:11px;font-weight:700;text-transform:uppercase;letter-spacing:.5px;color:#a5b4fc;display:block;margin-bottom:4px}
.calc-fi select,.calc-fi input{width:100%;padding:10px 12px;border-radius:var(--rsm);border:1.5px solid rgba(255,255,255,.15);background:rgba(255,255,255,.08);color:#fff;font-family:var(--ss);font-size:14px;outline:none}
.calc-fi select option{background:#312e81;color:#fff}
.calc-result{background:rgba(255,255,255,.08);border:1px solid rgba(255,255,255,.15);border-radius:14px;padding:20px;margin-top:14px;text-align:center}
.calc-big{font-family:var(--fs);font-size:52px;color:#fff;font-weight:500;line-height:1}
.calc-big-lbl{font-size:13px;color:#a5b4fc;margin-top:4px}
.calc-row{display:flex;justify-content:center;gap:24px;margin-top:16px;flex-wrap:wrap}
.calc-item-val{font-size:18px;font-weight:700;color:#fff}
.calc-item-lbl{font-size:11px;color:#a5b4fc;margin-top:2px;text-align:center}
.calc-warn{background:rgba(251,191,36,.1);border:1px solid rgba(251,191,36,.3);border-radius:var(--rsm);padding:12px 14px;font-size:12px;color:#fde68a;margin-top:12px;line-height:1.6}
.calc-empty{text-align:center;padding:24px;color:rgba(255,255,255,.4);font-size:14px}

/* COMO ESTOU */
.ce-fab{position:fixed;bottom:24px;right:20px;z-index:300;background:linear-gradient(135deg,var(--g700),var(--g600));color:#fff;border:none;border-radius:999px;padding:13px 22px;font-family:var(--ss);font-size:14px;font-weight:700;cursor:pointer;box-shadow:0 6px 24px rgba(22,163,74,.45);display:flex;align-items:center;gap:8px;transition:all .2s}
.ce-fab:hover{transform:translateY(-2px);box-shadow:0 10px 30px rgba(22,163,74,.5)}
.ce-ov{position:fixed;inset:0;background:rgba(5,46,22,.92);z-index:800;display:none;align-items:flex-end;justify-content:center}
.ce-ov.open{display:flex}
.ce-sheet{width:100%;max-width:600px;background:linear-gradient(160deg,#052e16,var(--g800));border-radius:28px 28px 0 0;padding:28px 24px 40px;max-height:92vh;overflow-y:auto;position:relative}
.ce-handle{width:40px;height:4px;background:rgba(255,255,255,.2);border-radius:999px;margin:0 auto 24px}
.ce-close{position:absolute;top:18px;right:18px;background:rgba(255,255,255,.1);border:none;color:#fff;width:32px;height:32px;border-radius:50%;font-size:16px;cursor:pointer;display:flex;align-items:center;justify-content:center}
.ce-tag{font-size:10px;text-transform:uppercase;letter-spacing:1px;color:var(--g300);margin-bottom:8px;font-weight:700}
.ce-title{font-family:var(--fs);font-size:22px;color:#fff;font-weight:500;margin-bottom:6px;line-height:1.25}
.ce-sub{font-size:14px;color:var(--g200);margin-bottom:20px;line-height:1.5}
.ce-grid{display:grid;grid-template-columns:1fr 1fr;gap:10px;margin-bottom:20px}
.ce-kpi{background:rgba(255,255,255,.07);border-radius:14px;padding:14px 16px;border:1px solid rgba(255,255,255,.07)}
.ce-kpi.ok{border-color:rgba(74,222,128,.3);background:rgba(74,222,128,.07)}
.ce-kpi.warn{border-color:rgba(251,191,36,.3);background:rgba(251,191,36,.07)}
.ce-kpi.danger{border-color:rgba(248,113,113,.3);background:rgba(248,113,113,.07)}
.ce-kl{font-size:10px;text-transform:uppercase;letter-spacing:.6px;color:var(--g300);margin-bottom:5px;font-weight:700}
.ce-kv{font-size:18px;font-weight:700;color:#fff}
.ce-kh{font-size:12px;color:rgba(255,255,255,.5);margin-top:4px;line-height:1.4}
.ce-foco{background:rgba(255,255,255,.06);border:1px solid rgba(255,255,255,.1);border-radius:14px;padding:16px 18px;margin-bottom:20px}
.ce-foco-tag{font-size:10px;text-transform:uppercase;letter-spacing:.8px;color:var(--g300);margin-bottom:8px;font-weight:700}
.ce-foco-msg{font-family:var(--fs);font-size:18px;color:#fff;font-weight:500;line-height:1.4}
.ce-foco-sub{font-size:13px;color:var(--g200);margin-top:6px;line-height:1.55}
.ce-voice-btn{width:100%;padding:11px;border-radius:12px;background:rgba(255,255,255,.05);border:1.5px solid rgba(255,255,255,.12);color:var(--g200);font-family:var(--ss);font-size:13px;cursor:pointer;display:flex;align-items:center;justify-content:center;gap:8px;margin-bottom:16px;transition:all .17s}
.ce-voice-btn.speaking{border-color:var(--g400);animation:pulse 1.5s infinite}
.ce-divider{height:1px;background:rgba(255,255,255,.1);margin:18px 0}
.ce-actions{display:flex;gap:10px;flex-wrap:wrap}
.ce-btn{padding:11px 18px;border-radius:10px;background:rgba(255,255,255,.08);border:1px solid rgba(255,255,255,.12);color:#fff;font-family:var(--ss);font-size:13px;font-weight:600;cursor:pointer;transition:all .17s}
.ce-btn:hover{background:rgba(255,255,255,.16)}
.ce-btn.primary{background:var(--g600);border-color:var(--g600)}

/* SINTOMAS */
.sint-grid{display:grid;grid-template-columns:repeat(auto-fill,minmax(280px,1fr));gap:12px}
.sint-card{border-radius:var(--rsm);padding:16px;border:1px solid}
.sint-ok{background:var(--g50);border-color:var(--g200)}
.sint-warn{background:var(--warn-bg);border-color:var(--warn-brd)}
.sint-ttl{font-weight:700;font-size:14px;margin-bottom:4px}
.sint-cause{font-size:12px;color:var(--muted);margin-bottom:8px;font-style:italic;line-height:1.5}
.sint-levels{display:flex;flex-direction:column;gap:6px}
.sint-level{border-radius:6px;padding:8px 10px;font-size:12px;line-height:1.6}
.sl1{background:rgba(22,163,74,.07);border-left:3px solid var(--g500)}
.sl2{background:rgba(217,119,6,.07);border-left:3px solid var(--warn)}
.sl3{background:rgba(220,38,38,.07);border-left:3px solid var(--red)}
.sl-ttl{font-weight:700;font-size:11px;text-transform:uppercase;letter-spacing:.4px;margin-bottom:3px}

/* CHARTS */
.chw{background:var(--g50);border:1px solid var(--g200);border-radius:var(--rsm);padding:14px;margin-top:12px}
.pbar-wrap{margin-top:10px}
.pbar-lbl{font-size:11px;color:var(--muted);margin-bottom:4px}
.pbar{height:8px;background:var(--cream3);border-radius:999px;overflow:hidden}
.pbar-fill{height:100%;border-radius:999px;background:linear-gradient(90deg,var(--g500),var(--g400));transition:width .5s ease}
.pbar-fill.warn{background:linear-gradient(90deg,var(--warn),#fbbf24)}
.pbar-fill.danger{background:linear-gradient(90deg,var(--red),#f87171)}
.peq{background:var(--g50);border:1px solid var(--g200);border-radius:var(--rsm);padding:12px 14px;font-size:13px;color:var(--ink3);line-height:1.75;margin-top:10px}

/* TABELAS */
.tw2{border:1px solid var(--cream3);border-radius:var(--rsm);overflow:hidden;max-height:300px;overflow-y:auto}
table{width:100%;border-collapse:collapse;font-size:13px}
th{padding:9px 12px;background:var(--g50);color:var(--muted);font-weight:700;font-size:11px;text-transform:uppercase;letter-spacing:.5px;text-align:left;position:sticky;top:0}
td{padding:9px 12px;border-top:1px solid var(--cream2)}
td.r{text-align:right;font-weight:600}
tr:hover td{background:var(--g50)}

/* EDUCAÃ‡ÃƒO */
.egrid{display:grid;grid-template-columns:repeat(auto-fill,minmax(260px,1fr));gap:14px}
.ecard{background:#fff;border:1px solid rgba(15,26,19,.055);border-radius:var(--r);padding:18px;box-shadow:var(--sh)}
.eic{font-size:25px;margin-bottom:9px}
.et{font-family:var(--fs);font-size:16px;color:var(--ink);margin-bottom:7px;font-weight:500}
.eb{font-size:13px;color:var(--ink3);line-height:1.65}
.ef{background:var(--g50);border:1px solid var(--g200);border-radius:7px;padding:8px 12px;font-size:12px;color:var(--g700);font-family:monospace;margin-top:9px;line-height:1.75}
.comp-tbl{width:100%;border-collapse:collapse;font-size:13px}
.comp-tbl th{background:var(--g700);color:#fff;padding:10px 14px;text-align:left;font-size:12px;text-transform:uppercase;letter-spacing:.5px}
.comp-tbl td{padding:10px 14px;border-top:1px solid var(--cream2)}
.comp-tbl tr:hover td{background:var(--g50)}
.best{color:var(--g600);font-weight:700}

/* FARMACOCINÃ‰TICA */
.pk-hero{background:linear-gradient(135deg,#0c1a3a,#1e3a6e);border-radius:var(--rlg);padding:22px;color:#fff;margin-bottom:14px;position:relative;overflow:hidden}
.pk-hero::before{content:'';position:absolute;right:-20px;top:-20px;width:160px;height:160px;border-radius:50%;background:radial-gradient(circle,rgba(59,130,246,.15),transparent 70%);pointer-events:none}
.pk-tag{font-size:10px;text-transform:uppercase;letter-spacing:.8px;color:#93c5fd;margin-bottom:6px;font-weight:700}
.pk-title{font-family:var(--fs);font-size:20px;color:#fff;font-weight:500;margin-bottom:4px}
.pk-sub{font-size:13px;color:#bfdbfe;line-height:1.5;margin-bottom:14px}
.pk-kpis{display:flex;gap:10px;flex-wrap:wrap;margin-bottom:14px}
.pk-kpi{background:rgba(255,255,255,.08);border-radius:10px;padding:9px 14px;flex:1;min-width:90px;border:1px solid rgba(255,255,255,.1)}
.pk-kl{font-size:10px;text-transform:uppercase;letter-spacing:.5px;color:#93c5fd;margin-bottom:3px}
.pk-kv{font-size:18px;font-weight:700;color:#fff}
.pk-kh{font-size:11px;color:rgba(255,255,255,.5);margin-top:2px}
.pk-chart-wrap{background:rgba(255,255,255,.04);border:1px solid rgba(255,255,255,.08);border-radius:14px;padding:14px;position:relative}
.pk-zone-label{position:absolute;top:18px;right:18px;font-size:10px;font-weight:700;text-transform:uppercase;letter-spacing:.5px;padding:3px 8px;border-radius:999px;background:rgba(34,197,94,.15);border:1px solid rgba(34,197,94,.3);color:#4ade80}
.pk-legend{display:flex;gap:14px;flex-wrap:wrap;margin-top:12px}
.pk-leg-item{display:flex;align-items:center;gap:6px;font-size:11px;color:rgba(255,255,255,.6)}
.pk-leg-dot{width:10px;height:10px;border-radius:50%}
.pk-empty{text-align:center;padding:28px;color:rgba(255,255,255,.35);font-size:13px}
.pk-alert{background:rgba(251,191,36,.08);border:1px solid rgba(251,191,36,.2);border-radius:var(--rsm);padding:10px 13px;font-size:12px;color:#fde68a;margin-top:12px;line-height:1.6;display:none}
.pk-alert.show{display:block}

/* IBOX */
.ibox{border-radius:var(--rsm);padding:14px 16px;font-size:13px;line-height:1.65}
.ibox-g{background:var(--g50);border:1px solid var(--g200);color:var(--ink3)}
.ibox-w{background:var(--warn-bg);border:1px solid var(--warn-brd);color:#78350f}
.ibox-b{background:var(--blue-bg);border:1px solid var(--blue-brd);color:var(--blue)}

/* MODAL */
.modal-ov{position:fixed;inset:0;background:rgba(0,0,0,.4);z-index:500;display:none;align-items:center;justify-content:center;padding:20px}
.modal-ov.open{display:flex}
.modal{background:#fff;border-radius:var(--rlg);padding:28px;max-width:380px;width:100%;box-shadow:0 12px 40px rgba(15,26,19,.13);position:relative}
.modal-ttl{font-family:var(--fs);font-size:20px;margin-bottom:6px;font-weight:500}
.modal-sub{font-size:13px;color:var(--muted);margin-bottom:20px}
.modal-x{position:absolute;top:16px;right:16px;background:none;border:none;font-size:20px;cursor:pointer;color:var(--muted)}

/* DIETA */
.diet-wrap{background:linear-gradient(135deg,var(--g50),var(--cream));border:1px solid var(--g200);border-radius:var(--r);padding:18px 20px;margin-bottom:14px}
.diet-meal{display:flex;gap:12px;align-items:flex-start;margin-bottom:9px}
.diet-meal:last-child{margin-bottom:0}
.diet-time{font-size:11px;font-weight:700;color:var(--muted);text-transform:uppercase;width:56px;flex-shrink:0;padding-top:2px}
.diet-desc{font-size:13px;color:var(--ink3);line-height:1.5}
.diet-prot{font-size:11px;color:var(--g600);font-weight:700;margin-top:2px}

/* TOOLTIP ICON */
.tip{display:inline-flex;width:17px;height:17px;border-radius:50%;background:rgba(15,26,19,.1);color:var(--muted);font-size:11px;font-weight:700;align-items:center;justify-content:center;cursor:pointer;margin-left:4px;flex-shrink:0;transition:background .15s}
.tip:hover{background:var(--g200);color:var(--g700)}
.tip-dark{background:rgba(255,255,255,.12);color:rgba(255,255,255,.6)}
.tip-dark:hover{background:rgba(255,255,255,.22);color:#fff}
/* HELP FAB */
.help-fab{position:fixed;bottom:80px;left:16px;z-index:350;width:46px;height:46px;border-radius:50%;background:var(--g700);color:#fff;border:none;display:flex;align-items:center;justify-content:center;font-size:20px;box-shadow:0 4px 14px rgba(15,26,19,.25);cursor:pointer;transition:all .2s}
.help-fab:hover{transform:scale(1.1);background:var(--g600)}
.help-bubble{position:fixed;bottom:136px;left:16px;right:16px;background:#14532d;color:#fff;padding:18px;border-radius:18px;z-index:400;box-shadow:0 8px 24px rgba(0,0,0,.25);border:1px solid rgba(255,255,255,.1);animation:slideUp .3s ease;max-width:420px}
@keyframes slideUp{from{opacity:0;transform:translateY(16px)}to{opacity:1;transform:none}}
.help-bubble-close{margin-top:12px;width:100%;padding:11px;background:rgba(255,255,255,.15);border:none;border-radius:10px;color:#fff;font-weight:600;cursor:pointer;font-family:var(--ss);font-size:13px}
/* PRATO SEMÃFORO */
.prato-visual{display:flex;gap:8px;margin:12px 0}
.prato-item{flex:1;text-align:center;padding:12px 5px;border-radius:10px}
.prato-proteina{background:rgba(74,222,128,.15);border:1px solid rgba(74,222,128,.3)}
.prato-salada{background:rgba(251,191,36,.15);border:1px solid rgba(251,191,36,.3)}
.prato-carboidrato{background:rgba(248,113,113,.15);border:1px solid rgba(248,113,113,.3)}
/* CONQUISTAS */
.conquista-card{background:linear-gradient(145deg,#78350f,#92400e);border-radius:var(--rsm);padding:12px 15px;margin-bottom:8px;display:flex;align-items:center;gap:12px;color:#fff;animation:fi .4s ease}
/* ROTEIRO */
.roteiro-card{background:linear-gradient(145deg,var(--g800),var(--g700));border-radius:var(--rlg);padding:20px;color:#fff;margin-bottom:14px}
.roteiro-step{display:flex;align-items:flex-start;gap:12px;padding:10px 0;border-bottom:1px solid rgba(255,255,255,.08)}
.roteiro-step:last-child{border-bottom:none}
.roteiro-num{width:24px;height:24px;border-radius:50%;background:rgba(255,255,255,.15);color:#fff;font-size:12px;font-weight:700;display:flex;align-items:center;justify-content:center;flex-shrink:0;margin-top:1px}
.roteiro-num.done{background:var(--g500)}

@media(max-width:640px){
  .nb span.nb-txt{display:none}
  .kg{grid-template-columns:1fr 1fr}
  .fg{grid-template-columns:1fr}
  .egrid,.sint-grid{grid-template-columns:1fr}
  .wrap{padding:14px 12px 100px}
  .ce-fab{bottom:16px;right:14px;padding:11px 16px;font-size:13px}
  .help-fab{bottom:72px;left:12px;width:42px;height:42px;font-size:18px}
  .calc-form{grid-template-columns:1fr}
  .calc-fi{grid-column:1/-1}
}

@media print {
  body > *:not(#resumoOv) { display: none !important; }
  #resumoOv { display: block !important; position: static !important; background: #fff !important; }
  #resumoOv button { display: none !important; }
}
</style>
</head>
<body>
<!-- COMO ESTOU FAB -->
<button class="help-fab" id="helpFab" onclick="abrirAjuda()" style="display:none" title="NÃ£o entendi">â“</button>
<div class="help-bubble" id="helpBubble" style="display:none">
  <div style="font-size:15px;font-weight:700;margin-bottom:8px">ğŸ’¡ Como usar o Equilibra</div>
  <div style="font-size:13px;line-height:1.7;color:rgba(255,255,255,.85)">
    Toque nos Ã­cones <strong>â“˜</strong> para entender qualquer nÃºmero.<br>
    FaÃ§a o <strong>check-in diÃ¡rio</strong> â€” leva menos de 1 minuto.<br>
    DÃºvidas sobre a medicaÃ§Ã£o? Veja a aba <strong>ğŸ’‰ Caneta</strong>.
  </div>
  <button class="help-bubble-close" onclick="fecharAjuda()">Entendi! âœ“</button>
</div>

<button class="ce-fab" id="ceFab" onclick="abrirCE()" style="display:none">ğŸ©º Como estou?</button>

<!-- COMO ESTOU SHEET -->
<!-- RESUMO MÃ‰DICO -->
<div id="resumoOv" style="display:none;position:fixed;inset:0;z-index:600;background:#f0fdf4;overflow-y:auto">
  <div style="max-width:480px;margin:0 auto;padding:20px 16px 40px">
    <!-- Header -->
    <div style="display:flex;justify-content:space-between;align-items:center;margin-bottom:20px">
      <div>
        <div style="font-size:11px;font-weight:700;text-transform:uppercase;letter-spacing:.8px;color:#16a34a">EQUILIBRA 5.0</div>
        <div style="font-size:18px;font-weight:700;color:#14532d">RelatÃ³rio do Paciente</div>
      </div>
      <button onclick="fecharResumo()" style="background:#dcfce7;border:none;border-radius:999px;width:36px;height:36px;font-size:18px;cursor:pointer;color:#166534">âœ•</button>
    </div>

    <!-- CartÃ£o ID -->
    <div id="resumoCartao" style="background:linear-gradient(135deg,#14532d,#166534);border-radius:16px;padding:20px;color:#fff;margin-bottom:16px">
      <div style="display:flex;justify-content:space-between;align-items:flex-start">
        <div>
          <div style="font-size:22px;font-weight:700" id="resumoNome">â€”</div>
          <div style="font-size:12px;color:rgba(255,255,255,.6);margin-top:2px" id="resumoInfo">â€”</div>
        </div>
        <div style="text-align:right">
          <div style="font-size:28px;font-weight:700" id="resumoPeso">â€”</div>
          <div style="font-size:11px;color:rgba(255,255,255,.6)">peso atual</div>
        </div>
      </div>
      <div style="margin-top:14px;padding-top:14px;border-top:1px solid rgba(255,255,255,.15);display:grid;grid-template-columns:1fr 1fr 1fr;gap:8px">
        <div style="text-align:center">
          <div style="font-size:16px;font-weight:700" id="resumoPerda">â€”</div>
          <div style="font-size:10px;color:rgba(255,255,255,.6)">kg perdidos</div>
        </div>
        <div style="text-align:center">
          <div style="font-size:16px;font-weight:700" id="resumoMeta">â€”</div>
          <div style="font-size:10px;color:rgba(255,255,255,.6)">meta</div>
        </div>
        <div style="text-align:center">
          <div style="font-size:16px;font-weight:700" id="resumoSemanas">â€”</div>
          <div style="font-size:10px;color:rgba(255,255,255,.6)">semanas</div>
        </div>
      </div>
    </div>

    <!-- Medicamento -->
    <div style="background:#fff;border:1px solid #dcfce7;border-radius:12px;padding:16px;margin-bottom:12px">
      <div style="font-size:10px;font-weight:700;text-transform:uppercase;letter-spacing:.6px;color:#16a34a;margin-bottom:10px">ğŸ’‰ MEDICAMENTO</div>
      <div id="resumoMed" style="font-size:14px;color:#14532d;line-height:1.8"></div>
    </div>

    <!-- Progresso -->
    <div style="background:#fff;border:1px solid #dcfce7;border-radius:12px;padding:16px;margin-bottom:12px">
      <div style="font-size:10px;font-weight:700;text-transform:uppercase;letter-spacing:.6px;color:#16a34a;margin-bottom:10px">ğŸ“Š EVOLUÃ‡ÃƒO DO PESO</div>
      <div id="resumoPesos" style="font-size:13px;color:#374151;line-height:2"></div>
    </div>

    <!-- HÃ¡bitos Ãºltimos 7 dias -->
    <div style="background:#fff;border:1px solid #dcfce7;border-radius:12px;padding:16px;margin-bottom:12px">
      <div style="font-size:10px;font-weight:700;text-transform:uppercase;letter-spacing:.6px;color:#16a34a;margin-bottom:10px">ğŸ¥— HÃBITOS â€” ÃšLTIMOS 7 DIAS</div>
      <div id="resumoHabitos" style="font-size:13px;color:#374151;line-height:2"></div>
    </div>

    <!-- Sintomas -->
    <div style="background:#fff;border:1px solid #dcfce7;border-radius:12px;padding:16px;margin-bottom:20px">
      <div style="font-size:10px;font-weight:700;text-transform:uppercase;letter-spacing:.6px;color:#16a34a;margin-bottom:10px">ğŸ©º SINTOMAS REGISTRADOS</div>
      <div id="resumoSintomas" style="font-size:13px;color:#374151;line-height:1.8"></div>
    </div>

    <!-- RodapÃ© -->
    <div style="text-align:center;font-size:11px;color:#6b7280;margin-bottom:20px" id="resumoData"></div>

    <!-- BotÃ£o compartilhar -->
    <button onclick="compartilharResumo()" style="width:100%;padding:16px;border-radius:14px;background:linear-gradient(135deg,#16a34a,#22c55e);border:none;color:#fff;font-family:var(--ss);font-size:15px;font-weight:700;cursor:pointer;box-shadow:0 4px 14px rgba(22,163,74,.3)">
      ğŸ“¤ Compartilhar com meu mÃ©dico
    </button>
    <button onclick="imprimirResumo()" style="width:100%;margin-top:10px;padding:14px;border-radius:14px;background:#fff;border:1.5px solid #16a34a;color:#16a34a;font-family:var(--ss);font-size:14px;font-weight:700;cursor:pointer">
      ğŸ–¨ï¸ Imprimir / Salvar PDF
    </button>
  </div>
</div>

<div class="ce-ov" id="ceOv">
  <div class="ce-sheet">
    <div class="ce-handle"></div>
    <button class="ce-close" onclick="fecharCE()">âœ•</button>
    <div class="ce-tag">SEU RESUMO CLÃNICO</div>
    <div class="ce-title" id="ceTitle">â€”</div>
    <div class="ce-sub" id="ceSub"></div>
    <button class="ce-voice-btn" id="ceVBtn" onclick="toggleVoz()">
      <span id="ceVIc">ğŸ”Š</span><span id="ceVTxt">Ouvir em voz alta</span>
    </button>
    <div class="ce-grid" id="ceGrid"></div>
    <div class="ce-foco" id="ceFoco">
      <div class="ce-foco-tag">SEU FOCO AGORA</div>
      <div class="ce-foco-msg" id="ceFocoMsg"></div>
      <div class="ce-foco-sub" id="ceFocoSub"></div>
    </div>
    <div class="ce-divider"></div>
    <div class="ce-actions">
      <button class="ce-btn primary" onclick="fecharCE();go('checkin')">âœ… Check-in</button>
      <button class="ce-btn" onclick="fecharCE();go('caneta')">ğŸ’‰ Caneta</button>
      <button class="ce-btn" onclick="fecharCE();go('dashboard')">ğŸ“Š Dashboard</button>
    </div>
  </div>
</div>

<!-- MODAL CONQUISTA -->
<div class="modal-ov" id="modalConquista">
  <div class="modal" style="text-align:center">
    <button class="modal-x" onclick="el('modalConquista').classList.remove('open')">âœ•</button>
    <div id="modalConquistaIc" style="font-size:52px;margin-bottom:12px"></div>
    <div class="modal-ttl" id="modalConquistaTtl">â€”</div>
    <div class="modal-sub" id="modalConquistaSub">â€”</div>
    <div style="background:var(--g50);border:1px solid var(--g200);border-radius:10px;padding:14px;margin:14px 0;font-size:13px;color:var(--ink3);line-height:1.6" id="modalConquistaBody"></div>
    <button class="btn bp" style="width:100%" onclick="el('modalConquista').classList.remove('open')">Continuar minha jornada ğŸ’ª</button>
  </div>
</div>

<!-- MODAL RESET -->
<div class="modal-ov" id="modalReset">
  <div class="modal">
    <button class="modal-x" onclick="fecharReset()">âœ•</button>
    <div class="modal-ttl">âš ï¸ Apagar todos os dados?</div>
    <div class="modal-sub">Esta aÃ§Ã£o Ã© irreversÃ­vel.</div>
    <div class="row">
      <button class="btn bp" style="flex:1" onclick="fecharReset()">Cancelar</button>
      <button class="btn bdanger" style="flex:1" onclick="confirmarReset()">Apagar tudo</button>
    </div>
  </div>
</div>


<!-- MODAL REFAZER ANAMNESE -->
<div class="modal-ov" id="modalAna">
  <div class="modal">
    <div class="modal-ttl">ğŸ—£ï¸ Refazer questionÃ¡rio?</div>
    <div class="modal-sub">Seus dados de peso e check-ins serÃ£o <strong>mantidos</strong>. O perfil e o tratamento serÃ£o reconfigurados pela conversa.</div>
    <div class="row">
      <button class="btn bg2" style="flex:1" onclick="el('modalAna').classList.remove('open')">Cancelar</button>
      <button class="btn bp" style="flex:1" onclick="confirmarRefazer()">Sim, comeÃ§ar</button>
    </div>
  </div>
</div>

<!-- ANAMNESE -->
<div class="ana-ov" id="anaOv" style="display:flex">
  <div class="ana-bg"></div>
  <div class="ana-prog"><div class="ana-prog-fill" id="anaFill" style="width:0%"></div></div>
  <div class="ana-body">
    <div class="ana-msgs" id="anaMsgs"></div>
    <div id="anaInput"></div>
  </div>
</div>

<!-- HEADER â€” sÃ³ logo -->
<header class="hdr" id="mainHdr" style="display:none">
  <div class="hdr-in">
    <div class="logo" onclick="go('dashboard')">
      <div class="logo-ic">ğŸŒ¿</div>
      <div><div class="logo-nm">Equilibra</div><div class="logo-vr">v5.0</div></div>
    </div>
    <!-- botÃµes rÃ¡pidos lado direito -->
    <div style="margin-left:auto;display:flex;gap:6px;align-items:center">
      <div style="display:flex;gap:6px">
        <button onclick="abrirResumo()" style="padding:6px 12px;border-radius:999px;border:1px solid rgba(255,255,255,.2);background:transparent;color:var(--g200);font-family:var(--ss);font-size:12px;font-weight:600;cursor:pointer">ğŸ“‹ MÃ©dico</button>
        <button onclick="abrirCE()" style="padding:6px 12px;border-radius:999px;border:1px solid rgba(255,255,255,.2);background:transparent;color:var(--g200);font-family:var(--ss);font-size:12px;font-weight:600;cursor:pointer">ğŸ©º Como estou?</button>
      </div>
    </div>
  </div>
</header>

<!-- TAB BAR INFERIOR -->
<nav class="tab-bar" id="tabBar" style="display:none">
  <div class="tab-bar-in">
    <button class="tb on" id="nb-dashboard" onclick="go('dashboard')">
      <span class="tb-ic">ğŸ“Š</span><span>Painel</span><span class="tb-dot"></span>
    </button>
    <button class="tb" id="nb-checkin" onclick="go('checkin')">
      <span class="tb-ic">âœ…</span><span>Check-in</span><span class="tb-dot"></span>
    </button>
    <button class="tb" id="nb-caneta" onclick="go('caneta')">
      <span class="tb-ic">ğŸ’‰</span><span>Caneta</span><span class="tb-dot"></span>
    </button>
    <button class="tb" id="nb-sintomas" onclick="go('sintomas')">
      <span class="tb-ic">ğŸ©º</span><span>Sintomas</span><span class="tb-dot"></span>
    </button>
    <button class="tb" id="nb-mais" onclick="abrirMais()">
      <span class="tb-ic">â˜°</span><span>Mais</span><span class="tb-dot"></span>
    </button>
  </div>
</nav>

<!-- MENU MAIS (drawer) -->
<div id="maisOv" style="position:fixed;inset:0;background:rgba(0,0,0,.5);z-index:600;display:none" onclick="fecharMais()">
  <div id="maisSheet" style="position:absolute;bottom:0;left:0;right:0;background:var(--g800);border-radius:20px 20px 0 0;padding:20px 0 40px" onclick="event.stopPropagation()">
    <div style="width:36px;height:4px;background:rgba(255,255,255,.2);border-radius:999px;margin:0 auto 20px"></div>
    <div style="padding:0 8px;display:grid;grid-template-columns:1fr 1fr;gap:8px">
      <button onclick="fecharMais();go('perfil')" style="padding:16px 12px;border-radius:14px;border:1px solid rgba(255,255,255,.1);background:rgba(255,255,255,.05);color:#fff;font-family:var(--ss);font-size:13px;font-weight:600;cursor:pointer;display:flex;flex-direction:column;align-items:center;gap:6px"><span style="font-size:22px">âš™ï¸</span>Perfil</button>
      <button onclick="fecharMais();go('historico')" style="padding:16px 12px;border-radius:14px;border:1px solid rgba(255,255,255,.1);background:rgba(255,255,255,.05);color:#fff;font-family:var(--ss);font-size:13px;font-weight:600;cursor:pointer;display:flex;flex-direction:column;align-items:center;gap:6px"><span style="font-size:22px">ğŸ“‹</span>HistÃ³rico</button>
      <button onclick="fecharMais();go('educacao')" style="padding:16px 12px;border-radius:14px;border:1px solid rgba(255,255,255,.1);background:rgba(255,255,255,.05);color:#fff;font-family:var(--ss);font-size:13px;font-weight:600;cursor:pointer;display:flex;flex-direction:column;align-items:center;gap:6px"><span style="font-size:22px">ğŸ“š</span>Entenda</button>
      <button onclick="fecharMais();go('faq')" style="padding:16px 12px;border-radius:14px;border:1px solid rgba(255,255,255,.1);background:rgba(255,255,255,.05);color:#fff;font-family:var(--ss);font-size:13px;font-weight:600;cursor:pointer;display:flex;flex-direction:column;align-items:center;gap:6px"><span style="font-size:22px">â“</span>DÃºvidas</button>
      <button onclick="fecharMais();go('manual')" style="padding:16px 12px;border-radius:14px;border:1px solid rgba(255,255,255,.1);background:rgba(255,255,255,.05);color:#fff;font-family:var(--ss);font-size:13px;font-weight:600;cursor:pointer;display:flex;flex-direction:column;align-items:center;gap:6px;grid-column:span 2"><span style="font-size:22px">ğŸ“–</span>Manual de AplicaÃ§Ã£o</button>
    </div>
  </div>
</div>

<main class="wrap" id="mainWrap" style="display:none">

<!-- â•â•â• DASHBOARD â•â•â• -->
<div class="sec on" id="sec-dashboard">
  <div class="alert alert-r" id="alSint" style="display:none">âš ï¸ Sintomas intensos registrados. Avalie consultar seu mÃ©dico.</div>
  <div class="alert alert-w" id="alAgua" style="display:none">ğŸ’§ Sem registro de Ã¡gua hoje. HidrataÃ§Ã£o Ã© fundamental no uso de GLP-1.</div>
  <div class="alert alert-g" id="alDose" style="display:none"></div>

  <!-- GUIA RÃPIDO -->
  <div id="guiaRapidoWrap" style="display:none;margin-bottom:14px">
    <div id="guiaHoje" style="background:linear-gradient(135deg,var(--g800),var(--g700));border-radius:14px;padding:16px 18px;color:#fff">
      <div style="font-size:10px;font-weight:700;text-transform:uppercase;letter-spacing:.7px;color:var(--g300);margin-bottom:10px">ğŸ“… O QUE FAZER HOJE</div>
      <div id="guiaHojeItems" style="display:flex;flex-direction:column;gap:8px"></div>
      <button onclick="go('checkin')" id="guiaCheckinBtn" style="display:none;margin-top:12px;width:100%;padding:13px;border-radius:10px;background:rgba(255,255,255,.12);border:1px solid rgba(255,255,255,.2);color:#fff;font-family:var(--ss);font-size:13px;font-weight:700;cursor:pointer;text-align:center">
        ğŸ’§ğŸ¥© Registrar Ã¡gua e proteÃ­na â†’
      </button>
    </div>
  </div>

  <!-- CARD PROGRESSO HERO -->
  <div class="prog-hero" id="progHero">
    <div class="prog-tag" id="progTag">PESO &amp; PROGRESSO</div>

    <!-- TOP: anel + peso atual -->
    <div class="prog-top">
      <div class="prog-ring-wrap">
        <svg width="90" height="90" viewBox="0 0 90 90">
          <circle cx="45" cy="45" r="38" fill="none" stroke="rgba(255,255,255,.08)" stroke-width="7"/>
          <circle id="progRingFill" cx="45" cy="45" r="38" fill="none" stroke="url(#ringGrad)" stroke-width="7"
            stroke-linecap="round" stroke-dasharray="239" stroke-dashoffset="239" style="transition:stroke-dashoffset .9s cubic-bezier(.34,1.56,.64,1)"/>
          <defs>
            <linearGradient id="ringGrad" x1="0%" y1="0%" x2="100%" y2="0%">
              <stop offset="0%" stop-color="#22c55e"/>
              <stop offset="100%" stop-color="#4ade80"/>
            </linearGradient>
          </defs>
        </svg>
        <div class="prog-ring-center">
          <div class="prog-ring-pct" id="progRingPct">â€”</div>
          <div class="prog-ring-lbl">da meta</div>
        </div>
      </div>
      <div class="prog-info">
        <div class="prog-weight" id="progWeight">â€” kg</div>
        <div class="prog-delta" id="progDelta"></div>
        <div class="prog-moti" id="progMoti"></div>
        <div id="progUrineTag"></div>
      </div>
    </div>

    <!-- BARRA DE JORNADA -->
    <div class="prog-journey" id="progJourneyWrap">
      <div class="prog-journey-lbl">SUA JORNADA</div>
      <div class="prog-road"><div class="prog-road-fill" id="progRoadFill" style="width:0%"></div></div>
      <div class="prog-dots">
        <div class="prog-dot-wrap">
          <div class="prog-dot start"></div>
          <div class="prog-dot-lbl">InÃ­cio</div>
          <div class="prog-dot-val" id="pdStart">â€”</div>
        </div>
        <div class="prog-dot-wrap" id="midMarkerWrap" style="display:none">
          <div class="prog-dot" id="midMarkerDot"></div>
          <div class="prog-dot-lbl" id="midMarkerLbl">â€”</div>
          <div class="prog-dot-val" id="midMarkerVal">â€”</div>
        </div>
        <div class="prog-dot-wrap">
          <div class="prog-dot current"></div>
          <div class="prog-dot-lbl">Agora</div>
          <div class="prog-dot-val" id="pdNow">â€”</div>
        </div>
        <div class="prog-dot-wrap">
          <div class="prog-dot goal"></div>
          <div class="prog-dot-lbl">Meta</div>
          <div class="prog-dot-val" id="pdGoal">â€”</div>
        </div>
      </div>
    </div>

    <!-- KPIs -->
    <div class="prog-kpis" id="progKpis">
      <div class="prog-kpi highlight">
        <div class="prog-kpl">Perdido</div>
        <div class="prog-kpv" id="pkPerd">â€”</div>
        <div class="prog-kph">total</div>
      </div>
      <div class="prog-kpi">
        <div class="prog-kpl">Faltam</div>
        <div class="prog-kpv" id="pkFaltam">â€”</div>
        <div class="prog-kph">para meta</div>
      </div>
      <div class="prog-kpi">
        <div class="prog-kpl">Ritmo</div>
        <div class="prog-kpv" id="pkRitmo">â€”</div>
        <div class="prog-kph">kg/semana</div>
      </div>
    </div>

    <!-- Sem meta -->
    <div class="prog-no-goal" id="progNoGoal" style="display:none" onclick="go('perfil')">
      ğŸ¯ Defina seu peso meta no Perfil para ver o progresso completo â†’
    </div>

    <!-- ProjeÃ§Ã£o quando tem meta -->
    <div id="progProj" style="display:none;font-size:12px;color:var(--g300);margin-bottom:10px;text-align:center"></div>

    <!-- TENDÃŠNCIA SEMANAL -->
    <!-- PLACAR PROTEÃNA -->
    <div id="protPlacarWrap" style="margin-top:12px;display:none">
      <div onclick="go('checkin')" style="cursor:pointer;background:rgba(255,255,255,.06);border:1px solid rgba(255,255,255,.1);border-radius:12px;padding:12px 14px">
        <div style="display:flex;justify-content:space-between;align-items:center;margin-bottom:8px">
          <div style="font-size:11px;font-weight:700;text-transform:uppercase;letter-spacing:.5px;color:rgba(255,255,255,.45)">ğŸ¥© PROTEÃNA HOJE</div>
          <div style="font-size:10px;color:var(--g300)">toque para registrar â†’</div>
        </div>
        <div style="display:flex;align-items:baseline;gap:6px;margin-bottom:8px">
          <div id="protPlacarVal" style="font-family:var(--fs);font-size:28px;font-weight:600;color:#fff">0g</div>
          <div id="protPlacarMeta" style="font-size:13px;color:rgba(255,255,255,.4)">/ â€” g</div>
          <div id="protPlacarPct" style="margin-left:auto;font-size:14px;font-weight:700;color:var(--g400)">0%</div>
        </div>
        <div style="height:6px;background:rgba(255,255,255,.1);border-radius:999px;overflow:hidden">
          <div id="protPlacarBar" style="height:100%;border-radius:999px;background:linear-gradient(90deg,var(--g500),var(--g400));transition:width .5s ease;width:0%"></div>
        </div>
        <div id="protPlacarMsg" style="font-size:11px;color:rgba(255,255,255,.45);margin-top:6px">Registre sua proteÃ­na no check-in</div>
      </div>
    </div>

    <!-- CARD CANETA NO PAINEL -->
    <div id="canaetaPainelWrap" style="margin-top:10px;display:none">
      <div onclick="go('caneta')" style="cursor:pointer;background:rgba(255,255,255,.06);border:1px solid rgba(255,255,255,.1);border-radius:12px;padding:12px 14px">
        <div style="font-size:10px;font-weight:700;text-transform:uppercase;letter-spacing:.5px;color:rgba(255,255,255,.45);margin-bottom:10px">ğŸ’‰ SUA CANETA</div>
        <div style="display:flex;align-items:center;justify-content:space-between;gap:8px">
          <div>
            <div id="caPainelFarm" style="font-family:var(--fs);font-size:18px;font-weight:500;color:#fff;line-height:1.2">â€”</div>
            <div id="caPainelDose" style="font-size:12px;color:rgba(255,255,255,.5);margin-top:2px">â€”</div>
          </div>
          <div style="text-align:right">
            <div id="caPainelProxTag" style="font-size:9px;font-weight:700;text-transform:uppercase;letter-spacing:.5px;margin-bottom:3px"></div>
            <div id="caPainelProxVal" style="font-size:15px;font-weight:700;color:var(--g400)"></div>
          </div>
        </div>
        <div style="margin-top:10px;height:4px;background:rgba(255,255,255,.08);border-radius:999px;overflow:hidden">
          <div id="caPainelBar" style="height:100%;border-radius:999px;background:linear-gradient(90deg,var(--g500),var(--g400));transition:width .5s;width:0%"></div>
        </div>
        <div id="caPainelCiclo" style="font-size:10px;color:rgba(255,255,255,.35);margin-top:5px;text-align:center"></div>
      </div>
    </div>
    <!-- Canvas oculto mantido para compatibilidade interna -->
    <canvas id="chartMain" height="0" style="display:none"></canvas>
  </div>


  <!-- AVISO PRÃ“XIMA DOSE -->
  <div id="proxDoseCard" style="display:none;margin-bottom:14px">
    <div id="proxDoseInner" onclick="go('caneta')" style="cursor:pointer;border-radius:var(--rlg);padding:16px 18px;display:flex;align-items:center;gap:14px">
      <div id="proxDoseIc" style="font-size:28px;flex-shrink:0"></div>
      <div style="flex:1">
        <div id="proxDoseTag" style="font-size:10px;font-weight:700;text-transform:uppercase;letter-spacing:.7px;margin-bottom:4px"></div>
        <div id="proxDoseTtl" style="font-family:var(--fs);font-size:18px;font-weight:500;line-height:1.2"></div>
        <div id="proxDoseSub" style="font-size:12px;margin-top:3px;opacity:.75"></div>
      </div>
      <div style="font-size:18px;opacity:.4">â†’</div>
    </div>
  </div>

  <!-- FARMACOCINÃ‰TICA -->
  <div class="pk-hero" id="pkCard" style="display:none">
    <div class="pk-tag">ğŸ“ˆ EXCLUSIVO EQUILIBRA</div>
    <div class="pk-title" style="display:flex;align-items:center;gap:8px">ğŸ“Š NÃ­vel do remÃ©dio no sangue <span class="tip tip-dark" onclick="mostrarDica('farmaco')">â“˜</span></div>
    <div class="pk-sub">Estimativa farmacocinÃ©tica ao longo do ciclo. A zona verde indica quando a saciedade Ã© esperada.</div>
    <div class="pk-kpis" id="pkKpis"></div>
    <div class="pk-chart-wrap">
      <div class="pk-zone-label">Zona de saciedade</div>
      <canvas id="chartPK" height="110"></canvas>
    </div>
    <div class="pk-legend">
      <div class="pk-leg-item"><div class="pk-leg-dot" style="background:#3b82f6"></div>NÃ­vel estimado</div>
      <div class="pk-leg-item"><div class="pk-leg-dot" style="background:#22c55e"></div>Zona de saciedade</div>
      <div class="pk-leg-item"><div class="pk-leg-dot" style="background:#fff;border:2px solid #3b82f6"></div>Agora</div>
      <div class="pk-leg-item"><div class="pk-leg-dot" style="background:#f59e0b"></div>PrÃ³xima dose</div>
    </div>
    <div class="pk-alert" id="pkAlert"></div>
    <div style="font-size:11px;color:rgba(255,255,255,.3);margin-top:10px;line-height:1.5">âš ï¸ Curva estimada com base na farmacocinÃ©tica publicada. VariaÃ§Ãµes individuais existem. NÃ£o substitui orientaÃ§Ã£o mÃ©dica.</div>
  </div>


  <div class="streak" id="streakEl" style="display:none!important;visibility:hidden;height:0;overflow:hidden;margin:0;padding:0">
    <div style="font-size:22px">ğŸ”¥</div>
    <div style="flex:1;font-size:13px;color:var(--g200)">SequÃªncia de check-ins</div>
    <div style="text-align:right">
      <div class="streak-num" id="streakNum">0</div>
      <div class="streak-lbl">dias seguidos</div>
    </div>
  </div>
  <div class="milestone" id="msEl" style="display:none;cursor:pointer" onclick="abrirConquista()">
    <div style="font-size:28px" id="msIc">ğŸ†</div>
    <div><div style="font-size:14px;font-weight:600" id="msMsg">â€”</div><div style="font-size:12px;color:rgba(255,255,255,.7);margin-top:2px" id="msSub">â€”</div></div>
  </div>


  <!-- SEMÃFORO DO PRATO -->
  <div class="card" id="pratoCard">
    <div class="ct" style="display:flex;align-items:center;gap:6px">ğŸ½ï¸ Como montar seu prato <span class="tip" onclick="mostrarDica('prato')">â“˜</span></div>
    <div class="cs">A ordem em que vocÃª come faz diferenÃ§a com GLP-1</div>
    <div class="prato-visual">
      <div class="prato-item prato-proteina">
        <div style="font-size:24px">ğŸ¥©</div>
        <div style="font-size:11px;font-weight:700;margin-top:4px">1Âº PROTEÃNA</div>
        <div style="font-size:10px;opacity:.7;margin-top:2px">Tamanho da palma</div>
      </div>
      <div class="prato-item prato-salada">
        <div style="font-size:24px">ğŸ¥—</div>
        <div style="font-size:11px;font-weight:700;margin-top:4px">2Âº SALADA</div>
        <div style="font-size:10px;opacity:.7;margin-top:2px">Encher o prato</div>
      </div>
      <div class="prato-item prato-carboidrato">
        <div style="font-size:24px">ğŸš</div>
        <div style="font-size:11px;font-weight:700;margin-top:4px">3Âº CARBOIDRATO</div>
        <div style="font-size:10px;opacity:.7;margin-top:2px">Punho fechado</div>
      </div>
    </div>
    <div style="font-size:12px;color:var(--ink3);padding:10px 12px;background:var(--g50);border-radius:8px;line-height:1.6">
      ğŸ’¡ <strong>Por quÃª?</strong> ProteÃ­na primeiro aumenta saciedade, estabiliza glicose e protege mÃºsculo durante a perda de peso.
    </div>
  </div>

  <div class="card">
    <div class="ct" style="display:flex;align-items:center;gap:6px">âš¡ Metabolismo &amp; Metas <span class="tip" onclick="mostrarDica('metabolismo')">â“˜</span></div>
    <div class="cs">Toque em <strong>O que Ã©?</strong> para entender cada nÃºmero.</div>
    <div class="kg">
      <div class="kb"><div class="kl" style="display:flex;align-items:center;gap:3px">ğŸ˜´ Metabolismo em repouso <span class="tip" onclick="mostrarDica('TMB')">â“˜</span></div><div class="kv" id="kTMB">â€”</div><div class="kh">kcal/dia</div>
        <button class="exp-btn" onclick="toggleExp('eTMB',this)">O que Ã©? <span class="exp-arr">â–¾</span></button>
        <div class="exp-box" id="eTMB"><strong>Taxa MetabÃ³lica Basal.</strong> Energia gasta para existir â€” respirar, bombear sangue, manter temperatura. Calculado pela fÃ³rmula Mifflin-St Jeor.</div>
      </div>
      <div class="kb"><div class="kl" style="display:flex;align-items:center;gap:3px">ğŸƒ Energia no dia <span class="tip" onclick="mostrarDica('GET')">â“˜</span></div><div class="kv" id="kGET">â€”</div><div class="kh">kcal/dia</div>
        <button class="exp-btn" onclick="toggleExp('eGET',this)">O que Ã©? <span class="exp-arr">â–¾</span></button>
        <div class="exp-box" id="eGET"><strong>Gasto EnergÃ©tico Total.</strong> TMB Ã— fator de atividade. Representa tudo que vocÃª gasta num dia real.</div>
      </div>
      <div class="kb"><div class="kl" style="display:flex;align-items:center;gap:3px">ğŸ¯ Meta de calorias <span class="tip" onclick="mostrarDica('meta')">â“˜</span></div><div class="kv" id="kMeta">â€”</div><div class="kh" id="kDefH">â€”</div>
        <button class="exp-btn" onclick="toggleExp('eMeta',this)">O que Ã©? <span class="exp-arr">â–¾</span></button>
        <div class="exp-box" id="eMeta"><strong>Meta calÃ³rica diÃ¡ria.</strong> GET âˆ’ 500 kcal. DÃ©ficit que resulta em ~0,45 kg/semana. O GLP-1 facilita com saciedade natural.</div>
      </div>
      <div class="kb"><div class="kl" style="display:flex;align-items:center;gap:3px">ğŸ“‰ Perda esperada <span class="tip" onclick="mostrarDica('perda')">â“˜</span></div><div class="kv" id="kPEst">â€”</div><div class="kh">kg/semana</div>
        <button class="exp-btn" onclick="toggleExp('ePerda',this)">O que Ã©? <span class="exp-arr">â–¾</span></button>
        <div class="exp-box" id="ePerda">Estimativa teÃ³rica. Resultado real varia. Confie na mÃ©dia de 7 dias.</div>
      </div>
    </div>
  </div>

  <div class="card">
    <div class="ct" style="display:flex;align-items:center;gap:6px">ğŸ’§ HidrataÃ§Ã£o &amp; ProteÃ­na <span class="tip" onclick="mostrarDica('hidratacao')">â“˜</span></div>
    <div class="cs">Metas ajustadas ao seu peso</div>
    <div class="kg" style="margin-bottom:12px">
      <div class="kb"><div class="kl">Ãgua hoje</div><div class="kv" id="kAguaH">â€”</div><div class="kh" id="kAguaHH">â€”</div></div>
      <div class="kb"><div class="kl" style="display:flex;align-items:center;gap:3px">ğŸ¯ Meta de Ã¡gua <span class="tip" onclick="mostrarDica('agua')">â“˜</span></div><div class="kv" id="kAgua">â€”</div><div class="kh">ml/dia</div></div>
      <div class="kb"><div class="kl" style="display:flex;align-items:center;gap:3px">ğŸ¥© Meta mÃ­nima <span class="tip" onclick="mostrarDica('proteina')">â“˜</span></div><div class="kv" id="kPMin">â€”</div><div class="kh">1,6g/kg</div></div>
      <div class="kb"><div class="kl">ProteÃ­na ideal</div><div class="kv" id="kPIdeal">â€”</div><div class="kh">1,8â€“2,2g/kg</div></div>
    </div>
    <div id="aguaBarWrap" style="display:none">
      <div class="pbar-lbl">ğŸ’§ Ãgua â€” <span id="aguaPct">0%</span> da meta</div>
      <div class="pbar"><div class="pbar-fill" id="aguaFill" style="width:0%"></div></div>
    </div>
    <div class="peq" id="peqEl">â€”</div>
  </div>

  <div class="diet-wrap" id="dietCard" style="display:none">
    <div style="font-family:var(--fs);font-size:16px;color:var(--ink);margin-bottom:3px;font-weight:500">ğŸ¥— SugestÃ£o alimentar para hoje</div>
    <div style="font-size:12px;color:var(--muted);margin-bottom:14px" id="dietSub">â€”</div>
    <div id="dietMeals"></div>
    <div style="font-size:12px;color:var(--muted);margin-top:12px;padding-top:12px;border-top:1px solid var(--g200);line-height:1.5">âš ï¸ SugestÃ£o educativa. Priorize sempre <strong>proteÃ­na primeiro</strong> em cada refeiÃ§Ã£o.</div>
  </div>


  <div class="card" id="proxCard" style="display:none">
    <div class="ct">ğŸ’‰ Minha Caneta</div>
    <div class="cs" style="margin-bottom:12px">Acompanhamento da dose</div>
    <div class="nd">
      <div style="font-size:24px">â°</div>
      <div><div class="nd-lbl">PrÃ³xima aplicaÃ§Ã£o</div><div class="nd-val" id="proxVal">â€”</div></div>
      <div class="ml"><span class="tag tg" id="proxTag">â€”</span></div>
    </div>
    <div class="row" style="margin-top:10px;gap:8px">
      <div class="kb" style="flex:1;min-width:90px"><div class="kl">FÃ¡rmaco</div><div style="font-size:14px;font-weight:700" id="dFarm">â€”</div></div>
      <div class="kb" style="flex:1;min-width:90px"><div class="kl">Dose</div><div style="font-size:14px;font-weight:700;color:var(--g600)" id="dDose">â€”</div></div>
      <div class="kb" style="flex:1;min-width:90px"><div class="kl">Semana</div><div style="font-size:14px;font-weight:700;color:var(--ink3)" id="dSem">â€”</div></div>
    </div>
  </div>

  <div class="ibox ibox-w" style="margin-top:14px">
    <strong>âš ï¸ Disclaimer:</strong> O Equilibra fornece informaÃ§Ãµes educativas e <strong>nÃ£o substitui consulta mÃ©dica</strong>. Sintomas intensos ou persistentes â†’ <strong>procure seu mÃ©dico.</strong>
  </div>
</div>

<!-- â•â•â• CHECK-IN â•â•â• -->
<div class="sec" id="sec-checkin">
  <div class="pg-title">âœ… Check-in do dia</div>
  <div class="pg-sub">Menos de 1 minuto. FaÃ§a todo dia.</div>
  <div class="card">
    <div class="ct">Como estÃ¡ sua saciedade?</div>
    <div class="cs">O principal sinal de que a medicaÃ§Ã£o funciona.</div>
    <div class="ci-grid">
      <div class="ci-card" id="ciS1" onclick="setSac('saciado')"><div class="ci-icon">ğŸ˜Œ</div><div class="ci-lbl">Com saciedade</div><div class="ci-sub">Me sinto satisfeito naturalmente</div></div>
      <div class="ci-card" id="ciS2" onclick="setSac('fome')"><div class="ci-icon">ğŸ˜®â€ğŸ’¨</div><div class="ci-lbl">Com fome</div><div class="ci-sub">Mais fome que o esperado</div></div>
    </div>
    <div class="ci-act" id="ciActFome">
      <strong>Quando a fome aparece â€” verifique:</strong><br>
      âœ” Atingiu a <strong>meta de proteÃ­na</strong>? ProteÃ­na reduz fome.<br>
      âœ” Bebeu <strong>Ã¡gua suficiente</strong>? DesidrataÃ§Ã£o imita fome.<br>
      âœ” PrÃ³ximo da prÃ³xima dose? Normal a saciedade cair nos Ãºltimos dias.<br>
      âœ” Fome hÃ¡ vÃ¡rios dias â†’ <strong>converse com seu mÃ©dico.</strong>
    </div>
  </div>
  <div class="card">
    <div class="ct">Efeitos colaterais?</div>
    <div class="cs">Selecione os que estÃ¡ sentindo agora.</div>
    <div class="ci-grid">
      <div class="ci-card" id="ciQ1" onclick="setSint('ok')"><div class="ci-icon">âœ…</div><div class="ci-lbl">Sem queixas</div></div>
      <div class="ci-card" id="ciQ2" onclick="setSint('sim')"><div class="ci-icon">ğŸ¤¢</div><div class="ci-lbl">Tenho sintomas</div></div>
    </div>
    <div id="sintWrap" style="display:none;margin-top:12px">
      <div class="chips">
        <div class="chip" id="chNA" onclick="toggleChip('nausea')">ğŸ¤¢ NÃ¡usea</div>
        <div class="chip" id="chVO" onclick="toggleChip('vomito')">ğŸ¤® VÃ´mito</div>
        <div class="chip" id="chES" onclick="toggleChip('estomago')">ğŸ˜® EstÃ´mago cheio</div>
        <div class="chip" id="chCO" onclick="toggleChip('constipacao')">ğŸª¨ ConstipaÃ§Ã£o</div>
        <div class="chip" id="chDI" onclick="toggleChip('diarreia')">ğŸ’§ Diarreia</div>
        <div class="chip" id="chSA" onclick="toggleChip('semapetite')">ğŸš« Sem apetite</div>
        <div class="chip" id="chRE" onclick="toggleChip('refluxo')">ğŸ”¥ Refluxo</div>
        <div class="chip" id="chFA" onclick="toggleChip('fadiga')">ğŸ˜´ Fadiga</div>
        <div class="chip" id="chTO" onclick="toggleChip('tontura')">ğŸ’« Tontura</div>
      </div>
      <div class="chip-act" id="ca-nausea"><strong>NÃ¡usea:</strong> Coma devagar, volumes menores. ProteÃ­na antes de carboidratos. NÃ£o deite logo apÃ³s comer. Persiste mais de 3 dias â†’ avise seu mÃ©dico.</div>
      <div class="chip-act" id="ca-vomito"><strong>VÃ´mito:</strong> Hidrate com soro. 2+ episÃ³dios no dia â†’ avise seu mÃ©dico nesse mesmo dia.</div>
      <div class="chip-act" id="ca-estomago"><strong>EstÃ´mago cheio:</strong> ProteÃ­na primeiro. Volumes muito menores. Mastigue 20x por garfada.</div>
      <div class="chip-act" id="ca-constipacao"><strong>ConstipaÃ§Ã£o:</strong> <strong>Aumente Ã¡gua imediatamente.</strong> Fibras gradualmente. Ameixa, mamÃ£o, kiwi. Mais de 5 dias â†’ mÃ©dico.</div>
      <div class="chip-act" id="ca-diarreia"><strong>Diarreia:</strong> <strong>HidrataÃ§Ã£o rigorosa.</strong> BRAT: banana, arroz, torrada. Sangue ou mais de 3 dias â†’ emergÃªncia.</div>
      <div class="chip-act" id="ca-semapetite"><strong>Sem apetite:</strong> <strong>Risco de perda muscular.</strong> Whey protein. Ovos e iogurte grego. Informe seu mÃ©dico â€” pode indicar ajuste de dose.</div>
      <div class="chip-act" id="ca-refluxo"><strong>Refluxo:</strong> NÃ£o deite por 2â€“3h apÃ³s comer. RefeiÃ§Ãµes menores. Evite cafÃ© e Ã¡lcool Ã  noite.</div>
      <div class="chip-act" id="ca-fadiga"><strong>Fadiga:</strong> Verifique proteÃ­na e calorias. Exames se persistir: ferro, vitamina D, B12.</div>
      <div class="chip-act" id="ca-tontura"><strong>Tontura:</strong> Levante-se devagar. Hidrate. Intensa + sudorese fria â†’ emergÃªncia.</div>
      <div class="alert alert-r" id="alChips" style="display:none;margin-top:10px">ğŸš¨ MÃºltiplos sintomas. Avalie consultar seu mÃ©dico.</div>
    </div>
  </div>
  <div class="card">
    <div class="ct">ğŸ’§ Ãgua e proteÃ­na</div>
    <div class="cs">Registre rapidamente.</div>
    <div class="fg">
      <div class="fi">
        <label>ğŸ’§ Ãgua â€” quantos copos bebeu? <span style="font-size:10px;color:var(--muted);font-weight:400">(1 copo = 250ml)</span></label>
        <input id="ciAgua" type="number" step="250" placeholder="ex: 2000 ml"/>
        <div class="wbs" style="flex-wrap:wrap">
          <button class="wb" onclick="addAgua(250)">+1 copo</button>
          <button class="wb" onclick="addAgua(500)">+2 copos</button>
          <button class="wb" onclick="addAgua(750)">+3 copos</button>
          <button class="wb" onclick="addAgua(1000)">+4 copos (1L)</button>
        </div>
        <div id="aguaCoposDisplay" style="margin-top:6px;font-size:12px;color:var(--g600);font-weight:700"></div>
      </div>
      <div class="fi">
        <label>Cor da urina</label>
        <select id="ciUrina">
          <option value="">â€” nÃ£o informar â€”</option>
          <option value="Clara">ğŸ’§ Clara e frequente âœ…</option>
          <option value="Media">ğŸŸ¡ Amarelo mÃ©dio âš ï¸</option>
          <option value="Escura">ğŸ”´ Escura / pouca ğŸš¨</option>
        </select>
      </div>
    </div>

    <!-- PROTEÃNA â€” chips rÃ¡pidos + entrada por peso real -->
    <div style="margin-top:16px;padding-top:16px;border-top:1px solid var(--cream3)">
      <div style="font-size:11px;font-weight:700;color:var(--ink3);text-transform:uppercase;letter-spacing:.5px;margin-bottom:6px">ğŸ¥© ProteÃ­na â€” o que vocÃª comeu hoje?</div>

      <!-- MODO 1: Chips rÃ¡pidos de porÃ§Ãµes prontas -->
      <div style="font-size:12px;color:var(--muted);margin-bottom:10px">Toque para adicionar porÃ§Ãµes rÃ¡pidas:</div>
      <div id="protChipsWrap" style="display:flex;flex-wrap:wrap;gap:7px;margin-bottom:14px"></div>

      <!-- Separador -->
      <div style="display:flex;align-items:center;gap:8px;margin-bottom:12px">
        <div style="flex:1;height:1px;background:var(--cream3)"></div>
        <span style="font-size:11px;color:var(--muted);white-space:nowrap">ou informe o peso real</span>
        <div style="flex:1;height:1px;background:var(--cream3)"></div>
      </div>

      <!-- MODO 2: Dropdown + campo de gramas -->
      <div id="protFoodList" style="display:flex;flex-direction:column;gap:8px"></div>
      <button onclick="addProtFood()" style="margin-top:8px;width:100%;padding:9px;border-radius:9px;border:1.5px dashed var(--cream3);background:transparent;color:var(--muted);font-family:var(--ss);font-size:13px;cursor:pointer;transition:all .17s" onmouseover="this.style.borderColor='var(--g400)'" onmouseout="this.style.borderColor='var(--cream3)'">+ Adicionar alimento com peso</button>

      <!-- Total -->
      <div style="margin-top:12px;padding:12px 14px;background:var(--g50);border:1px solid var(--g200);border-radius:10px;display:flex;justify-content:space-between;align-items:center">
        <div>
          <div style="font-size:11px;font-weight:700;color:var(--muted);text-transform:uppercase;letter-spacing:.4px">Total de proteÃ­na</div>
          <div style="font-size:11px;color:var(--muted);margin-top:1px" id="protMeta">â€”</div>
        </div>
        <span id="protTotal" style="font-size:24px;font-weight:700;color:var(--g600)">0 g</span>
      </div>
      <input id="ciProt" type="hidden" value="0"/>
    </div>
    <div class="row" style="margin-top:14px">
      <button class="btn bp" onclick="salvarCI()">âœ… Salvar check-in</button>
    </div>
  </div>
</div>

<!-- â•â•â• CANETA â•â•â• -->
<div class="sec" id="sec-caneta">
  <div class="pg-title">ğŸ’‰ Minha Caneta</div>
  <div class="pg-sub">Tratamento, protocolo e calculadora de diluiÃ§Ã£o.</div>
  <div class="ch-hero" id="chHero">
    <div class="ch-tag">TRATAMENTO ATUAL</div>
    <div class="ch-drug" id="chDrug">Nenhum fÃ¡rmaco configurado</div>
    <div class="ch-dose" id="chDose">Configure abaixo</div>
    <div class="ch-row" id="chRow"></div>
  </div>

  <!-- CALCULADORA -->
  <div class="calc-hero">
    <div class="calc-tag">ğŸ’¡ EXCLUSIVO EQUILIBRA</div>
    <div class="calc-title">Calculadora de DiluiÃ§Ã£o</div>
    <div class="calc-sub">Identifique sua caneta ou frasco e calcule as unidades na seringa de insulina.</div>
    <div class="calc-form">
      <div class="calc-fi">
        <label>FÃ¡rmaco</label>
        <select id="calcFarm" onchange="updateCalcApres()">
          <option value="">â€” selecione â€”</option>
          <option>Tirzepatida</option>
          <option>Semaglutida</option>
          <option>Liraglutida</option>
        </select>
      </div>
      <div class="calc-fi">
        <label>ApresentaÃ§Ã£o / produto</label>
        <select id="calcApres" onchange="updateCalcTipo()">
          <option value="">â€” selecione o fÃ¡rmaco primeiro â€”</option>
        </select>
      </div>
    </div>
    <!-- Campos que aparecem apenas para frascos-ampola -->
    <div id="calcAmpolaWrap" style="display:none;margin-top:12px">
      <!-- Linha do frasco: mg / mL -->
      <div id="calcConcWrap" style="margin-bottom:14px">
        <div style="font-size:11px;font-weight:700;color:rgba(255,255,255,.55);text-transform:uppercase;letter-spacing:.5px;margin-bottom:8px">O que estÃ¡ escrito no seu frasco?</div>
        <div style="display:flex;align-items:center;gap:10px">
          <div style="flex:1;display:flex;flex-direction:column;align-items:center;gap:4px">
            <input id="calcMg" type="number" step="0.1" placeholder="mg" oninput="calcDil()"
              style="width:100%;padding:13px 8px;border-radius:10px;border:1.5px solid rgba(255,255,255,.15);background:rgba(255,255,255,.07);color:#fff;font-family:var(--ss);font-size:20px;font-weight:700;outline:none;text-align:center;transition:border-color .18s"
              onfocus="this.style.borderColor='#4ade80'" onblur="this.style.borderColor='rgba(255,255,255,.15)'"/>
            <div style="font-size:11px;color:rgba(255,255,255,.4)">mg no frasco</div>
          </div>
          <div style="font-size:32px;color:rgba(255,255,255,.25);font-weight:300;flex-shrink:0;padding-bottom:18px">/</div>
          <div style="flex:1;display:flex;flex-direction:column;align-items:center;gap:4px">
            <input id="calcMl" type="number" step="0.1" placeholder="mL" oninput="calcDil()"
              style="width:100%;padding:13px 8px;border-radius:10px;border:1.5px solid rgba(255,255,255,.15);background:rgba(255,255,255,.07);color:#fff;font-family:var(--ss);font-size:20px;font-weight:700;outline:none;text-align:center;transition:border-color .18s"
              onfocus="this.style.borderColor='#4ade80'" onblur="this.style.borderColor='rgba(255,255,255,.15)'"/>
            <div style="font-size:11px;color:rgba(255,255,255,.4)">mL no frasco</div>
          </div>
        </div>
        <div id="calcConcResult" style="display:none;margin-top:8px;text-align:center;font-size:12px;color:rgba(255,255,255,.45)"></div>
      </div>
      <!-- Dose prescrita -->
      <div>
        <div style="font-size:11px;font-weight:700;color:rgba(255,255,255,.55);text-transform:uppercase;letter-spacing:.5px;margin-bottom:8px">Dose prescrita pelo mÃ©dico</div>
        <div style="display:flex;flex-direction:column;align-items:center;gap:4px">
          <input id="calcDose" type="number" step="0.1" placeholder="mg" oninput="calcDil()"
            style="width:100%;padding:13px 8px;border-radius:10px;border:1.5px solid rgba(255,255,255,.15);background:rgba(255,255,255,.07);color:#fff;font-family:var(--ss);font-size:20px;font-weight:700;outline:none;text-align:center;transition:border-color .18s"
            onfocus="this.style.borderColor='#4ade80'" onblur="this.style.borderColor='rgba(255,255,255,.15)'"/>
          <div style="font-size:11px;color:rgba(255,255,255,.4)">mg a aplicar por dose</div>
        </div>
      </div>
    </div>
    <div id="calcRes" style="margin-top:12px"><div class="calc-empty">Selecione o fÃ¡rmaco e a apresentaÃ§Ã£o acima.</div></div>
  </div>

  <div class="card">
    <div class="ct">ğŸ“ DiÃ¡rio de peso</div>
    <div class="cs">Registre ao acordar, apÃ³s urinar, antes de comer.</div>
    <div class="fg">
      <div class="fi"><label>Data</label><input id="pData" type="date"/></div>
      <div class="fi"><label>Peso (kg)</label><input id="pVal" type="number" step="0.1" placeholder="ex: 97.4"/></div>
    </div>
    <div class="row" style="margin-top:12px">
      <button class="btn bp" onclick="addPeso()">Salvar pesagem</button>
      <button class="btn bg2" style="padding:7px 12px;font-size:12px" onclick="delPeso()">Apagar Ãºltima</button>
    </div>
    <div class="chw"><canvas id="chartCaneta" height="70"></canvas></div>
  </div>

  <div class="card">
    <div class="ct">Configurar tratamento</div>
    <div class="cs">InformaÃ§Ãµes da sua prescriÃ§Ã£o.</div>
    <div class="fg">
      <div class="fi">
        <label>FÃ¡rmaco</label>
        <select id="cFarm" onchange="updateDoses()">
          <option value="">â€” selecione â€”</option>
          <option value="Tirzepatida">Tirzepatida (Mounjaro / Zepbound)</option>
          <option value="Semaglutida">Semaglutida (Ozempic / Wegovy)</option>
          <option value="Liraglutida">Liraglutida (Saxenda)</option>
        </select>
      </div>
      <div class="fi"><label>Dose atual</label><select id="cDose"><option value="">â€”</option></select></div>
      <div class="fi"><label>FrequÃªncia</label><select id="cFreq"><option value="semanal">Semanal</option><option value="diaria">DiÃ¡ria</option></select></div>
      <div class="fi" id="diaSemW">
        <label>Dia da aplicaÃ§Ã£o</label>
        <select id="cDia">
          <option value="0">Domingo</option><option value="1">Segunda</option><option value="2">TerÃ§a</option>
          <option value="3">Quarta</option><option value="4">Quinta</option><option value="5">Sexta</option><option value="6">SÃ¡bado</option>
        </select>
      </div>
      <div class="fi"><label>Data de inÃ­cio</label><input id="cIni" type="date"/></div>
      <div class="fi"><label>Ãšltima aplicaÃ§Ã£o</label><input id="cUlt" type="date"/></div>
    </div>
    <div style="margin-top:18px">
      <div style="font-size:11px;font-weight:700;color:var(--ink3);text-transform:uppercase;letter-spacing:.5px;margin-bottom:8px">Como estÃ¡ a saciedade com a dose atual?</div>
      <div class="fase-opts">
        <div class="fase-opt" id="foOk" onclick="setFase('ok')"><div class="fase-dot" style="background:var(--g500)"></div><div><div class="fase-ttl">Saciedade boa â€” manter dose</div><div class="fase-sub">Sinto saciedade e perco peso consistentemente.</div></div></div>
        <div class="fase-opt" id="foComp" onclick="setFase('comp')"><div class="fase-dot" style="background:var(--warn)"></div><div><div class="fase-ttl">Saciedade comprometida</div><div class="fase-sub">Ainda tenho, mas estÃ¡ diminuindo ou inconsistente.</div></div></div>
        <div class="fase-opt" id="foSem" onclick="setFase('sem')"><div class="fase-dot" style="background:var(--red)"></div><div><div class="fase-ttl">Sem saciedade + peso estagnado</div><div class="fase-sub">NÃ£o sinto efeito. O peso nÃ£o cai.</div></div></div>
      </div>
      <div class="fase-fb fb-ok" id="fbOk">âœ… <strong>Ã“timo.</strong> A dose mÃ­nima eficaz Ã© sempre a melhor escolha.</div>
      <div class="fase-fb fb-warn" id="fbComp">âš ï¸ <strong>AtenÃ§Ã£o.</strong> Converse com seu mÃ©dico. Revise proteÃ­na e hidrataÃ§Ã£o primeiro.</div>
      <div class="fase-fb fb-danger" id="fbSem">ğŸš¨ <strong>Requer avaliaÃ§Ã£o mÃ©dica.</strong> NÃ£o ajuste a dose por conta prÃ³pria.</div>
    </div>
    <div style="margin-top:14px">
      <div class="fi"><label>ObservaÃ§Ãµes</label><textarea id="cObs" rows="2" placeholder="Ex: nÃ¡usea leve nos 3 primeiros dias, depois passouâ€¦"></textarea></div>
    </div>
    <div class="row" style="margin-top:14px">
      <button class="btn bp" onclick="salvarCaneta()">ğŸ’¾ Salvar tratamento</button>
    </div>
  </div>

  <div class="card" id="escCard" style="display:none">
    <div class="ct">Protocolo de escalonamento</div>
    <div class="cs" id="escSub">TrajetÃ³ria de dose.</div>
    <div class="ibox ibox-g" style="margin-bottom:14px">ğŸ¯ A dose ideal Ã© a <strong>mÃ­nima com boa saciedade</strong> e perda consistente. Progredir Ã© sempre decisÃ£o mÃ©dica.</div>
    <div class="tl" id="escTL"></div>
  </div>

  <div class="card" id="esqCard" style="display:none">
    <div class="ct">âš ï¸ Dose esquecida</div>
    <div class="cs" style="margin-bottom:0" id="esqTxt"></div>
  </div>
</div>

<!-- â•â•â• SINTOMAS â•â•â• -->
<div class="sec" id="sec-sintomas">
  <div class="pg-title">ğŸ©º Biblioteca de Sintomas</div>
  <div class="pg-sub">O que esperar, o que fazer e quando buscar seu mÃ©dico.</div>
  <div class="sint-grid" id="sintGrid"></div>
  <div class="divider"></div>
  <div style="display:grid;grid-template-columns:1fr 1fr;gap:12px">
    <div class="ibox ibox-g"><strong style="color:var(--g600)">âœ… Bem hidratado</strong><br>Urina clara Â· 6â€“8 micÃ§Ãµes/dia</div>
    <div class="ibox ibox-w"><strong>âš ï¸ AtenÃ§Ã£o</strong><br>Urina escura Â· menos de 4 micÃ§Ãµes/dia</div>
  </div>
  <div class="alert alert-r" style="margin-top:12px">ğŸš¨ <strong>EmergÃªncia:</strong> Dor abdominal intensa irradiando para costas Â· VÃ´mitos incoercÃ­veis Â· Tontura + sudorese fria Â· ReaÃ§Ã£o alÃ©rgica Â· Sangue nas fezes â†’ <strong>Pronto-socorro imediato</strong></div>
</div>

<!-- â•â•â• PERFIL â•â•â• -->
<div class="sec" id="sec-perfil">
  <div class="pg-title">âš™ï¸ Perfil</div>
  <div class="pg-sub">Seus dados para cÃ¡lculos personalizados.</div>
  <div class="card">
    <div class="ct">Dados pessoais</div>
    <div class="fg">
      <div class="fi"><label>Sexo biolÃ³gico</label><select id="sexo"><option value="M">Masculino</option><option value="F">Feminino</option></select></div>
      <div class="fi"><label>Idade</label><input id="idade" type="number" min="18" max="90"/></div>
      <div class="fi"><label>Altura (cm)</label><input id="altura" type="number" min="140" max="220"/></div>
      <div class="fi"><label>Peso atual (kg)</label><input id="peso" type="number" min="40" max="400" step="0.1"/></div>
      <div class="fi"><label>Peso inicial no tratamento</label><input id="pesoI" type="number" min="40" max="400" step="0.1" placeholder="Peso quando comeÃ§ou"/></div>
      <div class="fi"><label>ğŸ¯ Peso meta (kg)</label><input id="pesoMeta" type="number" min="40" max="400" step="0.1" placeholder="ex: 80"/></div>
      <div class="fi">
        <label>NÃ­vel de atividade</label>
        <select id="ativ">
          <option value="SedentÃ¡rio">SedentÃ¡rio</option>
          <option value="Leve">Leve â€” 1â€“3x/sem</option>
          <option value="Moderada" selected>Moderada â€” 3â€“5x/sem</option>
          <option value="Alta">Alta â€” 6â€“7x/sem</option>
        </select>
      </div>
      <div class="fi"><label>InÃ­cio do tratamento</label><input id="dtIni" type="date"/></div>
    </div>
    <div class="row" style="margin-top:16px">
      <button class="btn bp" onclick="salvarPerfil()">âœ… Salvar e recalcular</button>
      <button class="btn bg2" onclick="exportar()">â¬‡ï¸ Exportar</button>
      <button class="btn bg2" onclick="importar()">â¬†ï¸ Importar</button>
    </div>
    <div class="divider"></div>
    <div class="ibox ibox-g">ğŸŒ… <strong>Como pesar corretamente:</strong> Ao acordar Â· ApÃ³s urinar Â· Antes de comer Â· Mesma balanÃ§a, mesmo local.</div>
    <div class="divider"></div>
    <div style="display:flex;flex-direction:column;gap:10px">
      <button class="btn" style="background:linear-gradient(135deg,var(--g800),var(--g700));color:#fff;font-size:14px;padding:12px 18px" onclick="refazerAnamnese()">ğŸ—£ï¸ Refazer questionÃ¡rio inicial</button>
      <div class="ibox ibox-g" style="font-size:12px">Seus dados de peso e check-ins <strong>nÃ£o serÃ£o apagados</strong>. Apenas o perfil e o tratamento serÃ£o reconfigurados pela conversa.</div>
    </div>
    <div class="divider"></div>
    <button class="btn bdanger" onclick="abrirReset()">ğŸ—‘ï¸ Apagar todos os dados</button>
  </div>
</div>

<!-- â•â•â• HISTÃ“RICO â•â•â• -->
<div class="sec" id="sec-historico">
  <div class="pg-title">ğŸ“‹ HistÃ³rico</div>
  <div class="pg-sub">Seus dados registrados.</div>
  <div class="card">
    <div class="ct">ğŸ“Š EvoluÃ§Ã£o semanal do peso</div>
    <div class="cs">MÃ©dia de peso por semana de tratamento</div>
    <div style="position:relative;height:180px;margin:8px 0">
      <canvas id="chartPesoSemanal"></canvas>
    </div>
    <div style="font-size:11px;color:var(--muted);text-align:center;margin-top:4px">Cada barra = mÃ©dia dos pesos registrados naquela semana</div>
  </div>
  <div class="card"><div class="ct">Pesagens</div><div class="tw2"><table><thead><tr><th>Data</th><th class="r">Peso (kg)</th><th class="r">MÃ©dia 7d</th></tr></thead><tbody id="tPesos"></tbody></table></div></div>
  <div class="card"><div class="ct">Check-ins diÃ¡rios</div><div class="tw2"><table><thead><tr><th>Data</th><th>Saciedade</th><th class="r">Ãgua</th><th>Urina</th><th>Sintomas</th><th class="r">ProteÃ­na</th></tr></thead><tbody id="tDias"></tbody></table></div></div>
  <div class="card"><div class="row"><button class="btn bg2" onclick="exportar()">â¬‡ï¸ Exportar JSON</button><button class="btn bg2" onclick="importar()">â¬†ï¸ Importar JSON</button></div></div>
</div>

<!-- â•â•â• EDUCAÃ‡ÃƒO â•â•â• -->
<div class="sec" id="sec-educacao">
  <div class="pg-title">ğŸ“š Entenda seu emagrecimento</div>
  <div class="pg-sub">CiÃªncia simples, sem jargÃ£o.</div>
  <div class="egrid">
    <div class="ecard"><div class="eic">ğŸ’Š</div><div class="et">Como o GLP-1 funciona</div><div class="eb">O GLP-1 Ã© um hormÃ´nio natural liberado pelo intestino apÃ³s refeiÃ§Ãµes. As medicaÃ§Ãµes imitam esse hormÃ´nio, agindo no cÃ©rebro para reduzir a fome e no estÃ´mago para retardar o esvaziamento. Resultado: vocÃª come menos naturalmente.</div></div>
    <div class="ecard"><div class="eic">âš¡</div><div class="et">Tirzepatida â€” duplo receptor</div><div class="eb">Age nos receptores GLP-1 e GIP simultaneamente. Maior perda ponderal nos estudos disponÃ­veis.</div><div class="ef">SURMOUNT: 5mgâ†’~15% | 10mgâ†’~19,5% | 15mgâ†’~20,9%</div></div>
    <div class="ecard"><div class="eic">ğŸ’‰</div><div class="et">Semaglutida â€” GLP-1 puro</div><div class="eb">O mais estudado para obesidade. FrequÃªncia semanal. Escalonamento de 16 semanas atÃ© 2,4mg.</div><div class="ef">Estudos STEP: perda mÃ©dia ~15%</div></div>
    <div class="ecard"><div class="eic">ğŸ”¥</div><div class="et">O que Ã© a TMB</div><div class="eb">Taxa MetabÃ³lica Basal: energia gasta para sobreviver. Mesmo parado, vocÃª gasta esse valor.</div><div class="ef" id="efTMB">FÃ³rmula Mifflin-St Jeor</div></div>
    <div class="ecard"><div class="eic">âš–ï¸</div><div class="et">DÃ©ficit calÃ³rico e gordura</div><div class="eb">1kg de gordura â‰ˆ 7.700 kcal. DÃ©ficit de 500 kcal/dia = ~0,45 kg/semana. O GLP-1 facilita a saciedade.</div><div class="ef" id="efMeta">Meta = GET âˆ’ 500 kcal</div></div>
    <div class="ecard"><div class="eic">ğŸ’ª</div><div class="et">Por que proteÃ­na Ã© fundamental</div><div class="eb">Em dÃ©ficit, o corpo pode quebrar mÃºsculo. ProteÃ­na protege a massa magra. Priorize proteÃ­na no inÃ­cio de cada refeiÃ§Ã£o.</div><div class="ef" id="efProt">MÃ­n: 1,6g/kg Â· Ideal: 1,8â€“2,2g/kg</div></div>
    <div class="ecard"><div class="eic">ğŸ“ˆ</div><div class="et">MÃ©dia mÃ³vel de 7 dias</div><div class="eb">O peso diÃ¡rio oscila por Ã¡gua, sal e hormÃ´nios. A mÃ©dia de 7 dias mostra a tendÃªncia real. Confie na linha, nÃ£o no nÃºmero de hoje.</div><div class="ef">MÃ©dia7 = soma dos Ãºltimos 7 pesos Ã· 7</div></div>
    <div class="ecard"><div class="eic">ğŸ¯</div><div class="et">Dose mÃ­nima eficaz</div><div class="eb">A dose ideal nÃ£o Ã© a mais alta â€” Ã© aquela com boa saciedade e perda consistente. Progredir Ã© sempre decisÃ£o mÃ©dica.</div></div>
  </div>
  <div class="divider"></div>
  <div style="overflow-x:auto;border-radius:var(--rsm)">
    <table class="comp-tbl">
      <thead><tr><th>CaracterÃ­stica</th><th>Liraglutida</th><th>Semaglutida</th><th>Tirzepatida</th></tr></thead>
      <tbody>
        <tr><td>FrequÃªncia</td><td>DiÃ¡ria</td><td>Semanal</td><td class="best">Semanal</td></tr>
        <tr><td>Mecanismo</td><td>GLP-1</td><td>GLP-1</td><td class="best">GLP-1 + GIP</td></tr>
        <tr><td>Perda mÃ©dia</td><td>~6â€“8%</td><td class="best">~15%</td><td class="best">~20%</td></tr>
        <tr><td>Dose esquecida</td><td>AtÃ© 12h antes</td><td>AtÃ© 5 dias</td><td>AtÃ© 4 dias</td></tr>
      </tbody>
    </table>
  </div>
  <p class="note" style="margin-top:10px">A melhor medicaÃ§Ã£o Ã© sempre a que seu mÃ©dico prescreveu para o seu perfil clÃ­nico.</p>
</div>


<!-- â•â•â• FAQ â•â•â• -->
<div class="sec" id="sec-faq">
  <div class="pg-title">â“ DÃºvidas Frequentes</div>
  <div class="pg-sub">Respostas de especialista em GLP-1</div>
  
  <!-- Campo de busca -->
  <div style="position:relative;margin-bottom:16px">
    <input id="faqBusca" type="text" placeholder="ğŸ” Digite sua dÃºvida..." oninput="filtrarFAQ(this.value)"
      style="width:100%;padding:12px 16px;border-radius:12px;border:1.5px solid var(--cream3);background:#fff;font-family:var(--ss);font-size:14px;outline:none"/>
    <button onclick="el('faqBusca').value='';filtrarFAQ('')" style="position:absolute;right:12px;top:50%;transform:translateY(-50%);border:none;background:none;font-size:16px;cursor:pointer;color:var(--muted)">âœ•</button>
  </div>

  <div id="faqNenhum" style="display:none;text-align:center;padding:24px;color:var(--muted);font-size:14px">Nenhuma dÃºvida encontrada. Tente outras palavras.</div>
  <div id="faqLista"></div>
</div>

<!-- â•â•â• MANUAL â•â•â• -->
<div class="sec" id="sec-manual">
  <div class="pg-title">ğŸ“– Manual de AplicaÃ§Ã£o</div>
  <div class="pg-sub">Passo a passo para aplicar corretamente</div>

  <!-- Seletor -->
  <div style="display:flex;gap:8px;margin-bottom:16px">
    <button id="manBtn1" onclick="mostrarManual('caneta')" class="btn bp" style="flex:1">ğŸ–Šï¸ Caneta</button>
    <button id="manBtn2" onclick="mostrarManual('ampola')" class="btn bg2" style="flex:1">ğŸ’‰ Ampola</button>
  </div>

  <div id="manualCaneta">
    <!-- IlustraÃ§Ã£o SVG da caneta Mounjaro -->
    <div class="card" style="margin-bottom:14px">
      <div class="ct">ğŸ–Šï¸ Caneta PrÃ©-cheia (Mounjaro KwikPen)</div>
      <div class="cs">Tirzepatida â€” uso semanal</div>
      <svg viewBox="0 0 340 90" style="width:100%;margin:8px 0 16px" xmlns="http://www.w3.org/2000/svg">
        <!-- Corpo da caneta -->
        <rect x="10" y="30" width="260" height="32" rx="16" fill="#e8e8e8" stroke="#ccc" stroke-width="1.5"/>
        <!-- Parte colorida roxa (Mounjaro) -->
        <rect x="10" y="30" width="80" height="32" rx="16" fill="#4f46e5"/>
        <rect x="75" y="30" width="20" height="32" fill="#4f46e5"/>
        <!-- Janela de inspeÃ§Ã£o -->
        <rect x="100" y="35" width="60" height="22" rx="4" fill="rgba(255,255,255,0.6)" stroke="#bbb" stroke-width="1"/>
        <!-- Texto Mounjaro -->
        <text x="20" y="50" font-family="sans-serif" font-size="9" font-weight="700" fill="white">mounjaroÂ®</text>
        <text x="20" y="60" font-family="sans-serif" font-size="7" fill="rgba(255,255,255,0.8)">5 mg/Dose</text>
        <!-- Escala na janela -->
        <line x1="110" y1="38" x2="110" y2="55" stroke="#999" stroke-width="0.8"/>
        <line x1="120" y1="38" x2="120" y2="55" stroke="#999" stroke-width="0.8"/>
        <line x1="130" y1="38" x2="130" y2="55" stroke="#999" stroke-width="0.8"/>
        <line x1="140" y1="38" x2="140" y2="55" stroke="#999" stroke-width="0.8"/>
        <line x1="150" y1="38" x2="150" y2="55" stroke="#999" stroke-width="0.8"/>
        <!-- Tampa protetora da agulha -->
        <rect x="265" y="34" width="30" height="24" rx="4" fill="#6d6d6d"/>
        <!-- BotÃ£o de dose -->
        <circle cx="295" y="46" r="10" fill="#16a34a" stroke="#15803d" stroke-width="1.5" cy="46"/>
        <text x="291" y="50" font-family="sans-serif" font-size="9" fill="white" font-weight="700">â–¶</text>
        <!-- Tampa inferior -->
        <rect x="10" y="30" width="18" height="32" rx="16" fill="#312e81"/>
        <!-- RÃ³tulo Lilly -->
        <text x="200" y="42" font-family="sans-serif" font-size="7" fill="#555" font-style="italic">Lilly</text>
      </svg>
      <!-- Passos caneta -->
      <div id="passosCaneta"></div>
    </div>
  </div>

  <div id="manualAmpola" style="display:none">
    <!-- IlustraÃ§Ã£o SVG frasco + seringa -->
    <div class="card" style="margin-bottom:14px">
      <div class="ct">ğŸ’‰ Frasco-Ampola + Seringa de Insulina</div>
      <div class="cs">Tirzepatida manipulada â€” uso semanal</div>
      <svg viewBox="0 0 340 120" style="width:100%;margin:8px 0 16px" xmlns="http://www.w3.org/2000/svg">
        <!-- FRASCO -->
        <!-- Corpo do frasco -->
        <rect x="30" y="40" width="60" height="70" rx="6" fill="rgba(200,230,255,0.4)" stroke="#8bb" stroke-width="1.5"/>
        <!-- Tampa metÃ¡lica -->
        <rect x="38" y="28" width="44" height="16" rx="4" fill="#9aa" stroke="#788" stroke-width="1"/>
        <!-- Tampa de borracha azul -->
        <rect x="42" y="32" width="36" height="10" rx="3" fill="#2563eb"/>
        <!-- RÃ³tulo -->
        <rect x="32" y="58" width="56" height="44" rx="4" fill="white" stroke="#ccc" stroke-width="0.5"/>
        <text x="60" y="71" font-family="sans-serif" font-size="7" font-weight="700" fill="#1e40af" text-anchor="middle">mounjaroÂ®</text>
        <rect x="36" y="74" width="48" height="10" rx="2" fill="#dc2626"/>
        <text x="60" y="82" font-family="sans-serif" font-size="6" font-weight="700" fill="white" text-anchor="middle">15 mg/0.5 mL</text>
        <text x="60" y="93" font-family="sans-serif" font-size="5.5" fill="#555" text-anchor="middle">0.5 mL vial</text>
        <!-- LÃ­quido interno -->
        <rect x="32" y="85" width="56" height="23" rx="0 0 6 6" fill="rgba(200,230,255,0.6)"/>

        <!-- SERINGA -->
        <!-- Corpo transparente -->
        <rect x="140" y="20" width="22" height="80" rx="4" fill="rgba(220,240,255,0.5)" stroke="#8bb" stroke-width="1.5"/>
        <!-- ÃŠmbolo/pistÃ£o -->
        <rect x="142" y="50" width="18" height="48" rx="2" fill="rgba(255,100,80,0.3)" stroke="#f87171" stroke-width="0.8"/>
        <rect x="138" y="48" width="26" height="6" rx="2" fill="#f87171"/>
        <!-- Haste do pistÃ£o -->
        <rect x="149" y="54" width="4" height="60" fill="#ccc" stroke="#aaa" stroke-width="0.5"/>
        <rect x="145" y="110" width="12" height="8" rx="2" fill="#aaa"/>
        <!-- Agulha -->
        <rect x="148" y="10" width="6" height="12" fill="#888"/>
        <polygon points="148,10 154,10 151,2" fill="#666"/>
        <!-- Escala -->
        <line x1="162" y1="25" x2="168" y2="25" stroke="#888" stroke-width="0.8"/>
        <line x1="162" y1="35" x2="168" y2="35" stroke="#888" stroke-width="0.8"/>
        <line x1="162" y1="45" x2="168" y2="45" stroke="#888" stroke-width="0.8"/>
        <line x1="162" y1="55" x2="172" y2="55" stroke="#888" stroke-width="1"/>
        <text x="174" y="58" font-family="sans-serif" font-size="7" fill="#666">50</text>
        <line x1="162" y1="65" x2="168" y2="65" stroke="#888" stroke-width="0.8"/>
        <line x1="162" y1="75" x2="168" y2="75" stroke="#888" stroke-width="0.8"/>
        <line x1="162" y1="85" x2="172" y2="85" stroke="#888" stroke-width="1"/>
        <text x="174" y="88" font-family="sans-serif" font-size="7" fill="#666">100</text>
        <!-- Tampinha laranja -->
        <rect x="144" y="2" width="14" height="14" rx="3" fill="#f97316" stroke="#ea580c" stroke-width="1"/>
        
        <!-- Seta indicando processo -->
        <text x="210" y="65" font-family="sans-serif" font-size="28" fill="#16a34a">â†’</text>
        
        <!-- RegiÃ£o aplicaÃ§Ã£o (silhueta do abdÃ´men) -->
        <ellipse cx="295" cy="65" rx="30" ry="40" fill="rgba(255,220,180,0.4)" stroke="#d4a57a" stroke-width="1.5"/>
        <circle cx="295" cy="50" r="8" fill="rgba(255,100,80,0.2)" stroke="#f87171" stroke-width="1" stroke-dasharray="3,2"/>
        <text x="295" y="95" font-family="sans-serif" font-size="7" fill="#555" text-anchor="middle">AbdÃ´men</text>
      </svg>
      <div id="passosAmpola"></div>
    </div>

    <!-- Locais de aplicaÃ§Ã£o -->
    <div class="card">
      <div class="ct">ğŸ“ Locais de AplicaÃ§Ã£o</div>
      <div class="cs">FaÃ§a rodÃ­zio a cada aplicaÃ§Ã£o</div>
      <svg viewBox="0 0 340 160" style="width:100%;margin:8px 0" xmlns="http://www.w3.org/2000/svg">
        <!-- Silhueta corpo frente -->
        <ellipse cx="85" cy="30" rx="20" ry="22" fill="rgba(255,220,180,0.5)" stroke="#d4a57a" stroke-width="1.5"/>
        <rect x="65" y="50" width="40" height="60" rx="8" fill="rgba(255,220,180,0.5)" stroke="#d4a57a" stroke-width="1.5"/>
        <rect x="45" y="52" width="22" height="50" rx="8" fill="rgba(255,220,180,0.4)" stroke="#d4a57a" stroke-width="1"/>
        <rect x="93" y="52" width="22" height="50" rx="8" fill="rgba(255,220,180,0.4)" stroke="#d4a57a" stroke-width="1"/>
        <rect x="68" y="108" width="18" height="48" rx="6" fill="rgba(255,220,180,0.5)" stroke="#d4a57a" stroke-width="1.5"/>
        <rect x="84" y="108" width="18" height="48" rx="6" fill="rgba(255,220,180,0.5)" stroke="#d4a57a" stroke-width="1.5"/>
        <!-- Zona abdÃ´men -->
        <ellipse cx="85" cy="80" rx="22" ry="18" fill="rgba(34,197,94,0.2)" stroke="#16a34a" stroke-width="2" stroke-dasharray="4,2"/>
        <text x="85" y="84" font-family="sans-serif" font-size="8" fill="#16a34a" text-anchor="middle" font-weight="700">1Â°</text>
        <!-- Zona coxa -->
        <ellipse cx="76" cy="125" rx="10" ry="14" fill="rgba(59,130,246,0.2)" stroke="#2563eb" stroke-width="2" stroke-dasharray="4,2"/>
        <text x="76" y="129" font-family="sans-serif" font-size="8" fill="#2563eb" text-anchor="middle" font-weight="700">2Â°</text>
        <ellipse cx="92" cy="125" rx="10" ry="14" fill="rgba(59,130,246,0.2)" stroke="#2563eb" stroke-width="2" stroke-dasharray="4,2"/>
        <text x="92" y="129" font-family="sans-serif" font-size="8" fill="#2563eb" text-anchor="middle" font-weight="700">2Â°</text>

        <!-- Silhueta costas -->
        <ellipse cx="255" cy="30" rx="20" ry="22" fill="rgba(255,220,180,0.5)" stroke="#d4a57a" stroke-width="1.5"/>
        <rect x="235" y="50" width="40" height="60" rx="8" fill="rgba(255,220,180,0.5)" stroke="#d4a57a" stroke-width="1.5"/>
        <rect x="215" y="52" width="22" height="50" rx="8" fill="rgba(255,220,180,0.4)" stroke="#d4a57a" stroke-width="1"/>
        <rect x="263" y="52" width="22" height="50" rx="8" fill="rgba(255,220,180,0.4)" stroke="#d4a57a" stroke-width="1"/>
        <rect x="238" y="108" width="18" height="48" rx="6" fill="rgba(255,220,180,0.5)" stroke="#d4a57a" stroke-width="1.5"/>
        <rect x="254" y="108" width="18" height="48" rx="6" fill="rgba(255,220,180,0.5)" stroke="#d4a57a" stroke-width="1.5"/>
        <!-- Zona braÃ§o -->
        <ellipse cx="226" cy="75" rx="12" ry="16" fill="rgba(251,191,36,0.2)" stroke="#d97706" stroke-width="2" stroke-dasharray="4,2"/>
        <text x="226" y="79" font-family="sans-serif" font-size="8" fill="#d97706" text-anchor="middle" font-weight="700">3Â°</text>
        <ellipse cx="274" cy="75" rx="12" ry="16" fill="rgba(251,191,36,0.2)" stroke="#d97706" stroke-width="2" stroke-dasharray="4,2"/>
        <text x="274" y="79" font-family="sans-serif" font-size="8" fill="#d97706" text-anchor="middle" font-weight="700">3Â°</text>

        <!-- Labels -->
        <text x="85" y="155" font-family="sans-serif" font-size="9" fill="#555" text-anchor="middle">Frente</text>
        <text x="255" y="155" font-family="sans-serif" font-size="9" fill="#555" text-anchor="middle">Costas/BraÃ§o</text>
        
        <!-- Legenda -->
        <circle cx="10" cy="10" r="5" fill="rgba(34,197,94,0.3)" stroke="#16a34a" stroke-width="1.5"/>
        <text x="18" y="14" font-family="sans-serif" font-size="8" fill="#16a34a" font-weight="700">1Â° AbdÃ´men</text>
        <circle cx="10" cy="25" r="5" fill="rgba(59,130,246,0.3)" stroke="#2563eb" stroke-width="1.5"/>
        <text x="18" y="29" font-family="sans-serif" font-size="8" fill="#2563eb" font-weight="700">2Â° Coxas</text>
        <circle cx="10" cy="40" r="5" fill="rgba(251,191,36,0.3)" stroke="#d97706" stroke-width="1.5"/>
        <text x="18" y="44" font-family="sans-serif" font-size="8" fill="#d97706" font-weight="700">3Â° BraÃ§os</text>
      </svg>
      <div style="font-size:12px;color:var(--ink3);line-height:1.7;padding:10px 12px;background:var(--g50);border-radius:8px">
        âš ï¸ <strong>Nunca aplique no mesmo local duas vezes seguidas.</strong> FaÃ§a rodÃ­zio dentro de cada regiÃ£o. MÃ­nimo 2cm do umbigo. Evite cicatrizes e manchas.
      </div>
    </div>
  </div>
</div>

</main>
<script>
/* â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
   EQUILIBRA 5.0 â€” JAVASCRIPT
   â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• */

var LS='equilibra_v5';
var S={profile:{sex:'M',age:null,heightCm:null,activityLevel:'Moderada',startDate:'',weightStartKg:null,weightKg:null,weightGoalKg:null},caneta:{farmaco:'',dose:'',freq:'semanal',faseSac:'',inicio:'',ultima:'',diaSem:1,obs:''},weights:[],daily:[]};

var AF={SedentÃ¡rio:1.20,Leve:1.35,Moderada:1.50,Alta:1.70};
var WBX={SedentÃ¡rio:0,Leve:200,Moderada:400,Alta:700};

var DOSES={
  Tirzepatida:[
    {dose:'2,5 mg',sem:'Semanas 1â€“4',info:'Dose de introduÃ§Ã£o. O corpo estÃ¡ aprendendo a responder ao duplo receptor. A saciedade plena comeÃ§a a aparecer entre as semanas 5 e 8.'},
    {dose:'5 mg',sem:'Semanas 5â€“8',info:'Primeira dose terapÃªutica real. Saciedade comeÃ§a a se estabelecer. Muitos respondem muito bem aqui â€” nÃ£o apresse progressÃ£o.'},
    {dose:'7,5 mg',sem:'Semanas 9â€“12',info:'Saciedade consistente ao longo da semana toda. A maioria tem excelente resultado nessa dose.'},
    {dose:'10 mg',sem:'Semanas 13â€“16',info:'Dose eficaz para a maioria. PlatÃ´ de 1â€“2 semanas pode ocorrer â€” Ã© remodelaÃ§Ã£o corporal, nÃ£o estagnaÃ§Ã£o real.'},
    {dose:'12,5 mg',sem:'Semanas 17â€“20',info:'Apenas se resposta subÃ³tima Ã  10mg. DecisÃ£o exclusivamente mÃ©dica.'},
    {dose:'15 mg',sem:'Semana 21+',info:'Dose mÃ¡xima. Nem todos precisam chegar aqui. SuplementaÃ§Ã£o nutricional obrigatÃ³ria.'}
  ],
  Semaglutida:[
    {dose:'0,25 mg',sem:'Semanas 1â€“4',info:'Dose de adaptaÃ§Ã£o. O nÃ­vel sÃ©rico estÃ¡ subindo gradualmente. Saciedade ainda nÃ£o Ã© esperada.'},
    {dose:'0,5 mg',sem:'Semanas 5â€“8',info:'Primeira dose com potencial terapÃªutico real. Saciedade comeÃ§a.'},
    {dose:'1,0 mg',sem:'Semanas 9â€“12',info:'Dose terapÃªutica principal. Muitos tÃªm excelente resposta aqui â€” nÃ£o progrida sem necessidade.'},
    {dose:'1,7 mg',sem:'Semanas 13â€“16',info:'Dose intermediÃ¡ria alta. Indicada quando a 1mg foi insuficiente.'},
    {dose:'2,4 mg',sem:'Semana 17+',info:'Dose mÃ¡xima para obesidade (Wegovy). SuplementaÃ§Ã£o nutricional frequentemente necessÃ¡ria.'}
  ],
  Liraglutida:[
    {dose:'0,6 mg',sem:'Semana 1',info:'AdaptaÃ§Ã£o diÃ¡ria. Crie o hÃ¡bito antes de progredir.'},
    {dose:'1,2 mg',sem:'Semana 2',info:'Primeira dose com efeito terapÃªutico. Saciedade pÃ³s-prandial comeÃ§a.'},
    {dose:'1,8 mg',sem:'Semana 3',info:'Dose eficaz para muitos. Avalie resposta antes de progredir.'},
    {dose:'2,4 mg',sem:'Semana 4',info:'Dose intermediÃ¡ria. Verifique tolerabilidade.'},
    {dose:'3,0 mg',sem:'Semana 5+',info:'Dose mÃ¡xima. Avalie em 12 semanas â€” mÃ­nimo 5% de perda esperado.'}
  ]
};

var ESQ={
  Tirzepatida:'Se passaram <strong>atÃ© 4 dias (96h)</strong> â†’ aplique agora e retome no dia habitual. Se mais de 4 dias â†’ <strong>pule a dose</strong>. Nunca aplique duas doses com menos de 3 dias de intervalo.',
  Semaglutida:'Se passaram <strong>atÃ© 5 dias</strong> â†’ aplique agora. Se mais de 5 dias â†’ <strong>pule a dose</strong>. Nunca aplique duas doses em menos de 48h.',
  Liraglutida:'Se faltam <strong>mais de 12h</strong> para o prÃ³ximo horÃ¡rio â†’ aplique agora. Se menos de 12h â†’ <strong>pule</strong>. Nunca aplique duas doses no mesmo dia.'
};

/* â•â• DADOS DE APRESENTAÃ‡Ã•ES â•â•
   tipo: 'caneta' = dose jÃ¡ medida, usar diretamente
          'ampola' = calcular unidades na seringa U-100
   conc: mg/mL (apenas para ampolas)
   dose: dose por aplicaÃ§Ã£o (para canetas prÃ©-cheias)
*/
var APRES={
  Tirzepatida:[
    // â”€â”€ Canetas prÃ©-cheias MounjaroÂ® (0,5 mL por dose)
    {lbl:'ğŸ–Šï¸ Mounjaro 2,5 mg â€” caneta prÃ©-cheia',tipo:'caneta',dose:'2,5 mg',marca:'MounjaroÂ®',info:'Caneta de dose Ãºnica 0,5 mL Â· 5 mg/mL'},
    {lbl:'ğŸ–Šï¸ Mounjaro 5 mg â€” caneta prÃ©-cheia',tipo:'caneta',dose:'5 mg',marca:'MounjaroÂ®',info:'Caneta de dose Ãºnica 0,5 mL Â· 10 mg/mL'},
    {lbl:'ğŸ–Šï¸ Mounjaro 7,5 mg â€” caneta prÃ©-cheia',tipo:'caneta',dose:'7,5 mg',marca:'MounjaroÂ®',info:'Caneta de dose Ãºnica 0,5 mL Â· 15 mg/mL'},
    {lbl:'ğŸ–Šï¸ Mounjaro 10 mg â€” caneta prÃ©-cheia',tipo:'caneta',dose:'10 mg',marca:'MounjaroÂ®',info:'Caneta de dose Ãºnica 0,5 mL Â· 20 mg/mL'},
    {lbl:'ğŸ–Šï¸ Mounjaro 12,5 mg â€” caneta prÃ©-cheia',tipo:'caneta',dose:'12,5 mg',marca:'MounjaroÂ®',info:'Caneta de dose Ãºnica 0,5 mL Â· 25 mg/mL'},
    {lbl:'ğŸ–Šï¸ Mounjaro 15 mg â€” caneta prÃ©-cheia',tipo:'caneta',dose:'15 mg',marca:'MounjaroÂ®',info:'Caneta de dose Ãºnica 0,5 mL Â· 30 mg/mL'},
    // â”€â”€ Frascos-ampola MounjaroÂ® dose Ãºnica (prÃ©-preenche mg/mL, paciente digita dose)
    {lbl:'ğŸ’‰ Mounjaro 2,5 mg â€” frasco-ampola',tipo:'ampola',mgTotal:2.5,vol:0.5,marca:'MounjaroÂ® frasco',info:'0,5 mL Â· 2,5 mg totais'},
    {lbl:'ğŸ’‰ Mounjaro 5 mg â€” frasco-ampola',tipo:'ampola',mgTotal:5,vol:0.5,marca:'MounjaroÂ® frasco',info:'0,5 mL Â· 5 mg totais'},
    {lbl:'ğŸ’‰ Mounjaro 7,5 mg â€” frasco-ampola',tipo:'ampola',mgTotal:7.5,vol:0.5,marca:'MounjaroÂ® frasco',info:'0,5 mL Â· 7,5 mg totais'},
    {lbl:'ğŸ’‰ Mounjaro 10 mg â€” frasco-ampola',tipo:'ampola',mgTotal:10,vol:0.5,marca:'MounjaroÂ® frasco',info:'0,5 mL Â· 10 mg totais'},
    {lbl:'ğŸ’‰ Mounjaro 12,5 mg â€” frasco-ampola',tipo:'ampola',mgTotal:12.5,vol:0.5,marca:'MounjaroÂ® frasco',info:'0,5 mL Â· 12,5 mg totais'},
    {lbl:'ğŸ’‰ Mounjaro 15 mg â€” frasco-ampola',tipo:'ampola',mgTotal:15,vol:0.5,marca:'MounjaroÂ® frasco',info:'0,5 mL Â· 15 mg totais'},
    // â”€â”€ Manipulada (concentraÃ§Ã£o variÃ¡vel â€” paciente informa)
    {lbl:'âš—ï¸ Manipulada â€” informar concentraÃ§Ã£o do frasco',tipo:'ampola_manual',marca:'Manipulada',info:'Informe a concentraÃ§Ã£o exata do seu frasco abaixo'}
  ],
  Semaglutida:[
    // â”€â”€ Canetas prÃ©-cheias OzempicÂ®
    {lbl:'ğŸ–Šï¸ Ozempic 0,25 mg/dose (1,34 mg/mL Â· 1,5 mL)',tipo:'caneta',dose:'0,25 mg',marca:'OzempicÂ®',info:'Caneta c/ 8 doses de 0,25 mg Â· 2 mg totais'},
    {lbl:'ğŸ–Šï¸ Ozempic 0,5 mg/dose (1,34 mg/mL Â· 1,5 mL)',tipo:'caneta',dose:'0,5 mg',marca:'OzempicÂ®',info:'Caneta c/ 4 doses de 0,5 mg Â· 2 mg totais'},
    {lbl:'ğŸ–Šï¸ Ozempic 1 mg/dose (1,34 mg/mL Â· 3 mL)',tipo:'caneta',dose:'1 mg',marca:'OzempicÂ®',info:'Caneta c/ 4 doses de 1 mg Â· 4 mg totais'},
    // â”€â”€ ExtensiorÂ® (mesma fÃ³rmula do Ozempic)
    {lbl:'ğŸ–Šï¸ Extensior 0,25/0,5 mg â€” caneta prÃ©-cheia',tipo:'caneta',dose:'0,25 ou 0,5 mg',marca:'ExtensiorÂ®',info:'Equivalente ao Ozempic Â· 1,34 mg/mL Â· 1,5 mL'},
    {lbl:'ğŸ–Šï¸ Extensior 1 mg â€” caneta prÃ©-cheia',tipo:'caneta',dose:'1 mg',marca:'ExtensiorÂ®',info:'Equivalente ao Ozempic Â· 1,34 mg/mL Â· 3 mL'},
    // â”€â”€ Canetas prÃ©-cheias WegovyÂ®
    {lbl:'ğŸ–Šï¸ Wegovy 0,25 mg/dose (0,68 mg/mL Â· 1,5 mL)',tipo:'caneta',dose:'0,25 mg',marca:'WegovyÂ®',info:'Semanas 1â€“4 Â· 4 doses de 0,25 mg por caneta'},
    {lbl:'ğŸ–Šï¸ Wegovy 0,5 mg/dose (1,34 mg/mL Â· 1,5 mL)',tipo:'caneta',dose:'0,5 mg',marca:'WegovyÂ®',info:'Semanas 5â€“8 Â· 4 doses de 0,5 mg por caneta'},
    {lbl:'ğŸ–Šï¸ Wegovy 1 mg/dose (1,34 mg/mL Â· 3 mL)',tipo:'caneta',dose:'1 mg',marca:'WegovyÂ®',info:'Semanas 9â€“12 Â· 4 doses de 1 mg por caneta'},
    {lbl:'ğŸ–Šï¸ Wegovy 1,7 mg/dose (2,27 mg/mL Â· 3 mL)',tipo:'caneta',dose:'1,7 mg',marca:'WegovyÂ®',info:'Semanas 13â€“16 Â· 4 doses de 1,7 mg por caneta'},
    {lbl:'ğŸ–Šï¸ Wegovy 2,4 mg/dose (3,20 mg/mL Â· 3 mL)',tipo:'caneta',dose:'2,4 mg',marca:'WegovyÂ®',info:'ManutenÃ§Ã£o (sem. 17+) Â· 4 doses por caneta'},
    // â”€â”€ PoviztraÂ® (mesma fÃ³rmula do Wegovy)
    {lbl:'ğŸ–Šï¸ Poviztra 0,25 mg â€” caneta prÃ©-cheia',tipo:'caneta',dose:'0,25 mg',marca:'PoviztraÂ®',info:'Equivalente ao Wegovy Â· 0,68 mg/mL Â· 1,5 mL'},
    {lbl:'ğŸ–Šï¸ Poviztra 0,5 mg â€” caneta prÃ©-cheia',tipo:'caneta',dose:'0,5 mg',marca:'PoviztraÂ®',info:'Equivalente ao Wegovy Â· 1,34 mg/mL Â· 1,5 mL'},
    {lbl:'ğŸ–Šï¸ Poviztra 1 mg â€” caneta prÃ©-cheia',tipo:'caneta',dose:'1 mg',marca:'PoviztraÂ®',info:'Equivalente ao Wegovy Â· 1,34 mg/mL Â· 3 mL'},
    {lbl:'ğŸ–Šï¸ Poviztra 1,7 mg â€” caneta prÃ©-cheia',tipo:'caneta',dose:'1,7 mg',marca:'PoviztraÂ®',info:'Equivalente ao Wegovy Â· 2,27 mg/mL Â· 3 mL'},
    {lbl:'ğŸ–Šï¸ Poviztra 2,4 mg â€” caneta prÃ©-cheia',tipo:'caneta',dose:'2,4 mg',marca:'PoviztraÂ®',info:'Equivalente ao Wegovy Â· 3,20 mg/mL Â· 3 mL'}
  ],
  Liraglutida:[
    // â”€â”€ Canetas prÃ©-cheias SaxendaÂ®
    {lbl:'ğŸ–Šï¸ Saxenda 6 mg/mL Â· 3 mL â€” caneta prÃ©-cheia',tipo:'caneta',dose:'0,6â€“3 mg',marca:'SaxendaÂ®',info:'18 mg totais Â· Doses: 0,6 / 1,2 / 1,8 / 2,4 / 3,0 mg/dia'},
    // â”€â”€ VictozaÂ®
    {lbl:'ğŸ–Šï¸ Victoza 6 mg/mL Â· 3 mL â€” caneta prÃ©-cheia',tipo:'caneta',dose:'0,6â€“1,8 mg',marca:'VictozaÂ®',info:'18 mg totais Â· Doses: 0,6 / 1,2 / 1,8 mg/dia (diabetes)'},
    // â”€â”€ Manipulada / ampola genÃ©rica
    {lbl:'âš—ï¸ Manipulada â€” informar concentraÃ§Ã£o do frasco',tipo:'ampola_manual',marca:'Manipulada',info:'Informe a concentraÃ§Ã£o exata do seu frasco abaixo'}
  ]
};

var MS=[
  {kg:1,ic:'ğŸŒ±',msg:'Primeiro quilograma perdido!',sub:'A jornada comeÃ§ou de verdade.'},
  {kg:2,ic:'ğŸ’ª',msg:'2 kg perdidos',sub:'ConsistÃªncia gerando resultado.'},
  {kg:5,ic:'ğŸ…',msg:'5 kg â€” marco importante!',sub:'VocÃª provou consistÃªncia.'},
  {kg:10,ic:'ğŸ†',msg:'10 kg â€” conquista extraordinÃ¡ria!',sub:'TransformaÃ§Ã£o de saÃºde real.'},
  {kg:15,ic:'â­',msg:'15 kg â€” resultado clÃ­nico significativo!',sub:'ReduÃ§Ã£o expressiva de risco metabÃ³lico.'},
  {kg:20,ic:'ğŸŒŸ',msg:'20 kg perdidos â€” impressionante!',sub:'Uma jornada que merece orgulho.'}
];

var SINT=[
  {id:'nausea',ttl:'ğŸ¤¢ NÃ¡usea',cls:'sint-ok',causa:'O GLP-1 retarda o esvaziamento gÃ¡strico â€” o estÃ´mago processa mais devagar. Intencional, mas causa nÃ¡usea especialmente no inÃ­cio e apÃ³s escalonamento.',quando:'Semanas 1â€“6',
   nv:[{c:'sl1',t:'Leve',tx:'Volumes menores. ProteÃ­na antes de carboidratos. NÃ£o deite por 1h apÃ³s comer. ChÃ¡ de gengibre pode ajudar.'},
       {c:'sl2',t:'Moderado (3+ dias)',tx:'RefeiÃ§Ãµes menores e mais frequentes. Evite gordura e laticÃ­nios. Consulte mÃ©dico â€” pode indicar ajuste.'},
       {c:'sl3',t:'Grave (vÃ´mitos + incapacidade de ingerir lÃ­quidos)',tx:'ğŸš¨ Atendimento mÃ©dico imediato â€” risco de desidrataÃ§Ã£o grave.'}]},
  {id:'vomito',ttl:'ğŸ¤® VÃ´mito',cls:'sint-ok',causa:'ExtensÃ£o da nÃ¡usea. EstÃ´mago muito cheio ou muito lento. Precipitado por refeiÃ§Ãµes grandes ou gordurosas.',quando:'Semanas 1â€“8',
   nv:[{c:'sl1',t:'EpisÃ³dio Ãºnico',tx:'Hidrate com soro em goles. NÃ£o coma por 1â€“2h. Retome com alimentos leves.'},
       {c:'sl2',t:'2+ episÃ³dios no dia',tx:'Dieta lÃ­quida. HidrataÃ§Ã£o rigorosa. Avise mÃ©dico no mesmo dia.'},
       {c:'sl3',t:'VÃ´mitos por 24h+',tx:'ğŸš¨ Pronto-socorro â€” risco de desidrataÃ§Ã£o grave e desequilÃ­brio eletrolÃ­tico.'}]},
  {id:'constipacao',ttl:'ğŸª¨ ConstipaÃ§Ã£o',cls:'sint-ok',causa:'O GLP-1 reduz a motilidade intestinal em atÃ© 50%. Tudo fica mais lento â€” combinado com menor volume alimentar e hidrataÃ§Ã£o insuficiente.',quando:'Qualquer fase â€” piora com doses maiores',
   nv:[{c:'sl1',t:'Leve (2â€“3 dias)',tx:'ÃGUA â€” o passo mais importante. Fibras gradualmente. Ameixa, mamÃ£o, kiwi. Caminhada leve.'},
       {c:'sl2',t:'Moderado (4â€“5 dias)',tx:'Lactulose ou macrogol â€” laxativos osmÃ³ticos seguros com GLP-1. Consulte mÃ©dico ou farmacÃªutico.'},
       {c:'sl3',t:'Grave (7+ dias, dor intensa)',tx:'ğŸš¨ Pode ser obstruÃ§Ã£o. Atendimento mÃ©dico urgente.'}]},
  {id:'diarreia',ttl:'ğŸ’§ Diarreia',cls:'sint-ok',causa:'Menos comum que constipaÃ§Ã£o. Pode ser por alteraÃ§Ã£o da microbiota ou aceleraÃ§Ã£o do trÃ¢nsito em alguns pacientes.',quando:'Primeiras semanas',
   nv:[{c:'sl1',t:'Leve',tx:'HidrataÃ§Ã£o rigorosa â€” risco real. BRAT: banana, arroz, torrada, maÃ§Ã£. Evite laticÃ­nios temporariamente.'},
       {c:'sl2',t:'Moderado (4+ episÃ³dios/dia)',tx:'Soro de reidrataÃ§Ã£o oral obrigatÃ³rio. Monitore sinais de desidrataÃ§Ã£o. Consulte mÃ©dico.'},
       {c:'sl3',t:'Intenso ou com sangue',tx:'ğŸš¨ Atendimento mÃ©dico urgente. Sangue nas fezes = emergÃªncia.'}]},
  {id:'refluxo',ttl:'ğŸ”¥ Refluxo / Azia',cls:'sint-ok',causa:'O retardo do esvaziamento gÃ¡strico aumenta o tempo que o Ã¡cido permanece no estÃ´mago. RefeiÃ§Ãµes grandes e deitar logo apÃ³s comer pioram.',quando:'Qualquer fase',
   nv:[{c:'sl1',t:'Leve',tx:'NÃ£o deite por 2â€“3h apÃ³s comer. RefeiÃ§Ãµes menores. Evite cafÃ© e Ã¡lcool Ã  noite.'},
       {c:'sl2',t:'DiÃ¡rio, interfere no sono',tx:'Omeprazol ou pantoprazol â€” consulte mÃ©dico para prescriÃ§Ã£o.'},
       {c:'sl3',t:'Dor no peito, dificuldade para engolir',tx:'ğŸš¨ AvaliaÃ§Ã£o mÃ©dica â€” afastar esofagite ou outras causas.'}]},
  {id:'semapetite',ttl:'ğŸš« AusÃªncia de apetite',cls:'sint-warn',causa:'O sintoma mais subestimado. Parece bom â€” mas sem proteÃ­na adequada vocÃª perde mÃºsculo, nÃ£o gordura. Compromete o metabolismo a longo prazo.',quando:'Qualquer fase, piora com doses maiores',
   nv:[{c:'sl1',t:'Moderado',tx:'ProteÃ­na primeiro e sempre. Whey protein com Ã¡gua. Ovos, cottage e iogurte grego sÃ£o fÃ¡ceis de consumir sem apetite.'},
       {c:'sl2',t:'Intenso (abaixo de 1g/kg de proteÃ­na)',tx:'Whey obrigatÃ³rio. Registre proteÃ­na diariamente. Avalie com mÃ©dico â€” dose pode estar acima do necessÃ¡rio.'},
       {c:'sl3',t:'Grave (menos de 800 kcal/dia por 3+ dias)',tx:'ğŸš¨ Avise seu mÃ©dico urgentemente â€” risco de deficiÃªncias e perda muscular severa.'}]},
  {id:'tontura',ttl:'ğŸ’« Tontura / Fraqueza',cls:'sint-warn',causa:'Pode ser hipoglicemia, hipotensÃ£o ortostÃ¡tica, desidrataÃ§Ã£o ou dÃ©ficit calÃ³rico. Distinguir a causa Ã© importante.',quando:'Qualquer fase',
   nv:[{c:'sl1',t:'Leve ao levantar',tx:'Levante-se devagar. Hidrate. Verifique se coincide com refeiÃ§Ãµes.'},
       {c:'sl2',t:'Persistente com fraqueza',tx:'Se usa insulina: verifique glicemia. Avise mÃ©dico.'},
       {c:'sl3',t:'Intensa + confusÃ£o + sudorese fria',tx:'ğŸš¨ EMERGÃŠNCIA â€” hipoglicemia grave. Ingira aÃ§Ãºcar e ligue para emergÃªncia.'}]},
  {id:'queda_cabelo',ttl:'ğŸ’† Queda de cabelo',cls:'sint-warn',causa:'NÃ£o Ã© causada diretamente pelo GLP-1. Ã‰ o eflÃºvio telÃ³geno â€” resposta ao dÃ©ficit calÃ³rico e ao estresse da perda rÃ¡pida de peso. Ocorre 2â€“4 meses apÃ³s o inÃ­cio.',quando:'2â€“4 meses de tratamento',
   nv:[{c:'sl1',t:'Queda moderada',tx:'Aumente proteÃ­na â€” cabelo Ã© queratina. Verifique ferro, zinco, biotina e vitamina D. Geralmente autolimitado.'},
       {c:'sl2',t:'Queda intensa com falhas',tx:'Exames: ferro, ferritina, zinco, vitamina D. AvaliaÃ§Ã£o dermatolÃ³gica.'}]},
  {id:'dor_abdominal',ttl:'ğŸ«ƒ Dor abdominal',cls:'sint-warn',causa:'Pode ser desde distensÃ£o por gases (benigno) atÃ© sinal de complicaÃ§Ã£o grave. LocalizaÃ§Ã£o e irradiaÃ§Ã£o sÃ£o critÃ©rios crÃ­ticos.',quando:'Qualquer fase',
   nv:[{c:'sl1',t:'Leve, melhora com gases',tx:'Reduza fibras insolÃºveis. ChÃ¡ de menta. Caminhada leve estimula motilidade.'},
       {c:'sl2',t:'Moderada, persistente',tx:'Avise mÃ©dico no mesmo dia. Documente: localizaÃ§Ã£o, irradiaÃ§Ã£o, relaÃ§Ã£o com refeiÃ§Ãµes.'},
       {c:'sl3',t:'Intensa, epigÃ¡strica, irradiando para costas',tx:'ğŸš¨ EMERGÃŠNCIA â€” possÃ­vel pancreatite. Pronto-socorro imediato. NÃ£o espere.'}]},
  {id:'fadiga',ttl:'ğŸ˜´ Fadiga',cls:'sint-ok',causa:'DÃ©ficit calÃ³rico reduz energia disponÃ­vel. Pode indicar deficiÃªncias nutricionais por ingestÃ£o inadequada.',quando:'Qualquer fase',
   nv:[{c:'sl1',t:'Leve',tx:'Acima de 1.000 kcal/dia? ProteÃ­na suficiente? HidrataÃ§Ã£o em dia?'},
       {c:'sl2',t:'Intensa, limita atividades',tx:'Exames: ferro, vitamina D, B12, TSH. Avise mÃ©dico se associada a tontura ou queda de cabelo.'}]}
];

/* â•â• ANAMNESE â•â• */
var ANA={step:0,data:{},totalSteps:10};

function anaInit(){
  var h=new Date().getHours();
  var s=h<12?'Bom dia':h<18?'Boa tarde':'Boa noite';
  anaProgresso(0);
  setTimeout(function(){
    anaMsg('bot',s+'! Seja bem-vindo ao <strong>Equilibra</strong>. ğŸŒ¿',null,function(){
      anaMsg('bot','Sou o <strong>Equi</strong>, seu assistente de acompanhamento com GLP-1. Vou configurar tudo para vocÃª agora â€” leva cerca de 3 minutos e vocÃª nÃ£o precisarÃ¡ preencher mais nada depois.',null,function(){
        anaStep0();
      });
    });
  },500);
}

/* PASSO 0 â€” Nome */
function anaStep0(){
  anaProgresso(5);
  setTimeout(function(){
    anaMsg('bot','Primeiro â€” qual Ã© o seu <strong>nome</strong>?');
    anaTextInput('Seu nome...', function(nome){
      ANA.data.nome=nome;
      anaMsg('usr',nome);
      anaMsg('bot','Prazer, <strong>'+nome+'</strong>! Vamos comeÃ§ar.',null,function(){anaStep1();});
    });
  },400);
}

/* PASSO 1 â€” Status */
function anaStep1(){
  anaProgresso(10);
  setTimeout(function(){
    anaMsg('bot','VocÃª <strong>jÃ¡ estÃ¡ usando</strong> a medicaÃ§Ã£o GLP-1, ou ainda vai comeÃ§ar?');
    anaOpts([
      {ic:'ğŸ’‰',lb:'JÃ¡ estou usando',sub:'JÃ¡ iniciei o tratamento',v:'em_tratamento'},
      {ic:'ğŸŒ±',lb:'Ainda vou comeÃ§ar',sub:'Vou comeÃ§ar em breve',v:'iniciante'}
    ],function(v){
      ANA.data.status=v;
      anaMsg('usr',v==='em_tratamento'?'JÃ¡ estou usando':'Ainda vou comeÃ§ar');
      v==='em_tratamento'?anaStep2B():anaStep2A();
    });
  },400);
}

/* â•â•â•â•â•â•â•â•â•â• RAMO A â€” Iniciante â•â•â•â•â•â•â•â•â•â• */
function anaStep2A(){
  anaProgresso(20);
  setTimeout(function(){
    anaMsg('bot','Qual medicaÃ§Ã£o seu mÃ©dico prescreveu?');
    anaOpts([
      {ic:'âš¡',lb:'Tirzepatida',sub:'Mounjaro / Zepbound â€” Semanal',v:'Tirzepatida'},
      {ic:'ğŸ’‰',lb:'Semaglutida',sub:'Ozempic / Wegovy â€” Semanal',v:'Semaglutida'},
      {ic:'ğŸ”¬',lb:'Liraglutida',sub:'Saxenda â€” DIÃRIO',v:'Liraglutida'},
      {ic:'â“',lb:'NÃ£o sei o nome',sub:'Vou verificar',v:'nsei'}
    ],function(v){
      if(v==='nsei'){
        anaMsg('usr','NÃ£o sei o nome');
        anaMsg('bot','Sem problema! Os mais comuns:<br><strong>Mounjaro / Zepbound</strong> = Tirzepatida (semanal)<br><strong>Ozempic / Wegovy</strong> = Semaglutida (semanal)<br><strong>Saxenda</strong> = Liraglutida (diÃ¡rio)<br><br>Olha a embalagem ou a receita e volta! ğŸ˜Š');
        setTimeout(function(){anaStep2A();},300);return;
      }
      ANA.data.farmaco=v;anaMsg('usr',v);
      var posologia={Tirzepatida:'ğŸ’‰ <strong>Tirzepatida Ã© SEMANAL</strong> â€” sempre no mesmo dia da semana.',Semaglutida:'ğŸ’‰ <strong>Semaglutida Ã© SEMANAL</strong> â€” sempre no mesmo dia da semana.',Liraglutida:'ğŸ’Š <strong>AtenÃ§Ã£o: Liraglutida (Saxenda) Ã© DIÃRIA</strong> â€” aplicaÃ§Ã£o uma vez por dia, sempre no mesmo horÃ¡rio. NÃ£o confunda com Ozempic ou Mounjaro que sÃ£o semanais.'};
      var info={Tirzepatida:'Age em dois receptores simultaneamente â€” GLP-1 e GIP. Os estudos mostram perda mÃ©dia de 15 a 20% do peso. Ã‰ o fÃ¡rmaco com maiores resultados disponÃ­veis hoje.',Semaglutida:'O mais estudado para obesidade do mundo. Perda mÃ©dia de 15% nos estudos STEP. Mais de 15 anos de dados de seguranÃ§a.',Liraglutida:'O GLP-1 com maior histÃ³rico de seguranÃ§a. Exige disciplina pela aplicaÃ§Ã£o diÃ¡ria, mas excelente tolerabilidade.'};
      anaMsg('bot',posologia[v],'clinical',function(){
        anaMsg('bot',info[v],null,function(){anaStep3A();});
      });
    });
  },400);
}

function anaStep3A(){
  anaProgresso(35);
  setTimeout(function(){
    anaMsg('bot','O que passa pela sua cabeÃ§a antes de comeÃ§ar?');
    anaOpts([
      {ic:'ğŸ˜Š',lb:'Animado, quero comeÃ§ar logo',v:'animado'},
      {ic:'ğŸ˜°',lb:'Ansioso com os efeitos colaterais',v:'ansioso'},
      {ic:'ğŸ¤”',lb:'Com medo de nÃ£o funcionar',v:'medo'},
      {ic:'â“',lb:'DÃºvidas sobre como aplicar',v:'duvidas'}
    ],function(v){
      var r={
        animado:'Ã“timo! Mas entra com expectativas realistas: as primeiras semanas sÃ£o de <strong>adaptaÃ§Ã£o</strong>, nÃ£o de perda acelerada. O resultado vem com consistÃªncia.',
        ansioso:'Completamente compreensÃ­vel. Os efeitos gastrointestinais sÃ£o comuns nas primeiras semanas â€” mas hÃ¡ muito que vocÃª pode fazer para minimizÃ¡-los. E eles passam.',
        medo:'Esse medo Ã© legÃ­timo. GLP-1 funciona para a grande maioria â€” mas tem uma condiÃ§Ã£o: <strong>proteÃ­na e hidrataÃ§Ã£o em dia</strong>. A medicaÃ§Ã£o reduz a fome, mas as escolhas ainda importam.',
        duvidas:'A aplicaÃ§Ã£o Ã© subcutÃ¢nea â€” na gordura sob a pele. Locais: abdÃ´men, coxa ou braÃ§o. A agulha Ã© fina e curta. VocÃª vai ver o manual completo com ilustraÃ§Ãµes dentro do app.'
      };
      var lbs={animado:'Animado!',ansioso:'Ansioso com os efeitos',medo:'Com medo de nÃ£o funcionar',duvidas:'DÃºvidas sobre a aplicaÃ§Ã£o'};
      anaMsg('usr',lbs[v]);anaMsg('bot',r[v]);setTimeout(function(){anaStep4A();},700);
    });
  },400);
}

function anaStep4A(){
  anaProgresso(48);
  setTimeout(function(){
    anaMsg('bot','Preciso dos seus dados para calcular suas metas personalizadas. <strong>Sexo biolÃ³gico:</strong>');
    anaOpts([{ic:'ğŸ‘¨',lb:'Masculino',v:'M'},{ic:'ğŸ‘©',lb:'Feminino',v:'F'}],function(v){
      ANA.data.sex=v;anaMsg('usr',v==='M'?'Masculino':'Feminino');setTimeout(function(){anaStep5A();},200);
    });
  },400);
}

function anaStep5A(){
  anaProgresso(58);
  setTimeout(function(){
    anaMsg('bot','<strong>Idade, altura e peso atual:</strong>');
    anaNums4(function(age,h,wi,w,meta){
      ANA.data.age=age;ANA.data.heightCm=h;ANA.data.pesoInicio=wi;ANA.data.pesoAtual=w;ANA.data.pesoMeta=meta;
      anaMsg('usr',age+' anos Â· '+h+' cm Â· '+w+' kg Â· meta: '+meta+' kg');
      anaStep6A();
    });
  },400);
}

function anaStep6A(){
  anaProgresso(70);
  setTimeout(function(){
    anaMsg('bot','NÃ­vel de atividade fÃ­sica. <strong>Seja honesto</strong> â€” superestimar afeta seus cÃ¡lculos:');
    anaOpts([
      {ic:'ğŸª‘',lb:'SedentÃ¡rio',sub:'Trabalho sentado, sem exercÃ­cio',v:'SedentÃ¡rio'},
      {ic:'ğŸš¶',lb:'Leve',sub:'Caminhadas ou exercÃ­cio 1â€“3x/semana',v:'Leve'},
      {ic:'ğŸƒ',lb:'Moderada',sub:'ExercÃ­cio regular 3â€“5x/semana',v:'Moderada'},
      {ic:'ğŸ‹ï¸',lb:'Alta',sub:'Treino intenso 6â€“7x/semana',v:'Alta'}
    ],function(v){
      ANA.data.activ=v;anaMsg('usr',v);
      var M=calcMetricsAna();
      if(!M){anaStep7A();return;}
      setTimeout(function(){
        anaMsg('bot','ğŸ“Š Calculei seu <strong>metabolismo em repouso (TMB)</strong> â€” a energia que seu corpo gasta sÃ³ para existir: respirar, coraÃ§Ã£o bater, manter temperatura. Mesmo deitado o dia todo, vocÃª gasta esse valor.<br><br>ğŸ”¥ <strong>Sua TMB: '+Math.round(M.tmb)+' kcal/dia</strong>','clinical');
        setTimeout(function(){
          anaMsg('bot','Com seu nÃ­vel de atividade, calculei o <strong>GET â€” Gasto EnergÃ©tico Total</strong>: tudo que vocÃª gasta num dia real.<br><br>âš¡ <strong>Seu GET: '+Math.round(M.get)+' kcal/dia</strong><br><br>ğŸ’¡ <strong>Qualquer valor abaixo do seu GET jÃ¡ faz vocÃª emagrecer</strong> â€” quanto menos vocÃª come em relaÃ§Ã£o ao GET, mais o corpo usa a gordura como combustÃ­vel. O GLP-1 facilita isso reduzindo a fome naturalmente.<br><br>ğŸ¯ <strong>Sua meta calÃ³rica: '+Math.round(M.meta)+' kcal/dia</strong> (dÃ©ficit de 500 kcal)','clinical');
          setTimeout(function(){anaStep7A();},200);
        },800);
      },400);
    });
  },400);
}

function anaStep7A(){
  anaProgresso(82);
  var M=calcMetricsAna();
  if(!M){setTimeout(function(){anaStep8A();},400);return;}
  var pm=Math.round(M.pm);
  var frango=Math.round(pm/0.31);
  var carne=Math.round(pm/0.26);
  var atum=Math.round(pm/0.30);
  var ovos=Math.round(pm/8);
  var whey_scoops=Math.round(pm/24);
  setTimeout(function(){
    anaMsg('bot','ğŸ¥© Agora a meta mais importante do seu tratamento: <strong>proteÃ­na</strong>.<br><br>Sua meta mÃ­nima: <strong>'+pm+'g de proteÃ­na PURA por dia</strong>.<br><br>âš ï¸ AtenÃ§Ã£o: alimentos nÃ£o sÃ£o proteÃ­na pura! Um peito de frango tem Ã¡gua, gordura e outros componentes. Para ingerir <strong>'+pm+'g de proteÃ­na pura</strong>, vocÃª precisaria comer:<br><br>ğŸ— <strong>'+frango+'g de peito de frango cozido</strong> (31g prot/100g)<br>ğŸ¥© <strong>'+carne+'g de carne magra</strong> (26g prot/100g)<br>ğŸŸ <strong>'+atum+'g de atum</strong> (30g prot/100g)<br>ğŸ¥š <strong>'+ovos+' ovos inteiros</strong> (8g prot/unidade)<br>ğŸ¥› <strong>'+whey_scoops+' scoops de whey</strong> (24g prot/scoop)<br><br>ğŸ’¡ Na prÃ¡tica: combine 2 ou 3 fontes ao longo do dia.','clinical');
    setTimeout(function(){
      anaMsg('bot','ğŸš¨ <strong>Aviso importante:</strong> Se vocÃª nÃ£o atingir a meta de proteÃ­na, seu corpo vai emagrecer â€” mas vai perder <strong>gordura E mÃºsculo</strong> ao mesmo tempo. Isso Ã© chamado de perda de massa magra e Ã© o maior risco do tratamento mal acompanhado.<br><br>Os dois grandes aliados para preservar seus mÃºsculos sÃ£o:<br><br>ğŸ’ª <strong>Atividade fÃ­sica resistida:</strong><br>â€¢ MusculaÃ§Ã£o / academia<br>â€¢ Treino com elÃ¡sticos<br>â€¢ Pilates com equipamentos<br>â€¢ Agachamento, flexÃ£o, prancha<br><br>ğŸ¥© <strong>ProteÃ­na distribuÃ­da ao longo do dia</strong> â€” nÃ£o tudo de uma vez.<br><br>Com esses dois pilares, vocÃª perde gordura e <strong>mantÃ©m ou ganha mÃºsculo</strong>.','clinical');
      setTimeout(function(){anaConfirm('Entendi! Continuar â†’', function(){anaStep8A();});},400);
    },900);
  },400);
}

function anaStep8A(){
  anaProgresso(90);
  setTimeout(function(){
    anaMsg('bot','Agora vamos configurar sua caneta. <strong>JÃ¡ tem a data da primeira aplicaÃ§Ã£o?</strong>');
    anaOpts([
      {ic:'ğŸ“…',lb:'Sim, jÃ¡ sei a data',v:'sim'},
      {ic:'â³',lb:'Ainda nÃ£o sei',v:'nao'}
    ],function(v){
      if(v==='nao'){
        anaMsg('usr','Ainda nÃ£o sei');
        anaMsg('bot','Sem problema â€” vocÃª pode configurar depois na aba ğŸ’‰ Caneta.');
        setTimeout(function(){anaFinalA();},300);return;
      }
      anaMsg('usr','Sim, jÃ¡ sei');
      anaMsg('bot','Qual serÃ¡ a data da <strong>primeira aplicaÃ§Ã£o</strong>?');
      anaDate(function(d){
        ANA.data.inicio=d;ANA.data.ultima=d;
        anaMsg('usr','Primeira dose: '+d);
        setTimeout(function(){anaFinalA();},300);
      });
    });
  },400);
}

function anaFinalA(){
  anaProgresso(96);
  setTimeout(function(){
    anaMsg('bot','Antes de entrar no app â€” as <strong>trÃªs regras de ouro</strong>:');
    setTimeout(function(){
      anaMsg('bot','<strong>1. ProteÃ­na primeiro.</strong> Em cada refeiÃ§Ã£o, proteÃ­na antes de tudo. Com GLP-1 reduzindo o apetite, comer carboidrato primeiro vai saciar sem atingir a meta de proteÃ­na.','clinical');
      setTimeout(function(){
        var M=calcMetricsAna();
        var copos=M?Math.round(M.agua/250):8;
        anaMsg('bot','<strong>2. HidrataÃ§Ã£o rigorosa.</strong> '+(M?'Meta: '+Math.round(M.agua)+' ml/dia â€” '+copos+' copos de 250ml. ':'Meta: 35ml Ã— seu peso. ')+'Urina clara Ã© o indicador. DesidrataÃ§Ã£o imita fome e piora todos os efeitos colaterais.','clinical');
        setTimeout(function(){
          anaMsg('bot','<strong>3. ConsistÃªncia acima de perfeiÃ§Ã£o.</strong> VocÃª nÃ£o precisa de uma semana perfeita. Precisa de semanas consistentes. O GLP-1 funciona com o tempo.','clinical');
          setTimeout(function(){anaConfirm('Ver meu resumo â†’', function(){anaDone();});},400);
        },700);
      },700);
    },500);
  },400);
}

/* â•â•â•â•â•â•â•â•â•â• RAMO B â€” Em tratamento â•â•â•â•â•â•â•â•â•â• */
function anaStep2B(){
  anaProgresso(15);
  setTimeout(function(){
    anaMsg('bot','Qual medicaÃ§Ã£o vocÃª usa?');
    anaOpts([
      {ic:'âš¡',lb:'Tirzepatida',sub:'Mounjaro / Zepbound â€” Semanal',v:'Tirzepatida'},
      {ic:'ğŸ’‰',lb:'Semaglutida',sub:'Ozempic / Wegovy â€” Semanal',v:'Semaglutida'},
      {ic:'ğŸ”¬',lb:'Liraglutida',sub:'Saxenda â€” DIÃRIO',v:'Liraglutida'}
    ],function(v){
      ANA.data.farmaco=v;anaMsg('usr',v);
      var posologia={
        Tirzepatida:'ğŸ’‰ <strong>Tirzepatida Ã© SEMANAL</strong> â€” sempre no mesmo dia da semana.',
        Semaglutida:'ğŸ’‰ <strong>Semaglutida Ã© SEMANAL</strong> â€” sempre no mesmo dia da semana.',
        Liraglutida:'ğŸ’Š <strong>Liraglutida (Saxenda) Ã© DIÃRIA</strong> â€” uma aplicaÃ§Ã£o por dia, sempre no mesmo horÃ¡rio. Diferente de Ozempic e Mounjaro.'
      };
      anaMsg('bot',posologia[v],'clinical');
      setTimeout(function(){anaStep3B();},200);
    });
  },400);
}

function anaStep3B(){
  anaProgresso(25);
  setTimeout(function(){
    anaMsg('bot','Qual Ã© a sua <strong>dose atual</strong>?');
    var doses={
      Tirzepatida:[{lb:'2,5 mg',v:'2.5'},{lb:'5 mg',v:'5'},{lb:'7,5 mg',v:'7.5'},{lb:'10 mg',v:'10'},{lb:'12,5 mg',v:'12.5'},{lb:'15 mg',v:'15'}],
      Semaglutida:[{lb:'0,25 mg',v:'0.25'},{lb:'0,5 mg',v:'0.5'},{lb:'1,0 mg',v:'1.0'},{lb:'1,7 mg',v:'1.7'},{lb:'2,4 mg',v:'2.4'}],
      Liraglutida:[{lb:'0,6 mg/dia',v:'0.6'},{lb:'1,2 mg/dia',v:'1.2'},{lb:'1,8 mg/dia',v:'1.8'},{lb:'2,4 mg/dia',v:'2.4'},{lb:'3,0 mg/dia',v:'3.0'}]
    };
    var opts=doses[ANA.data.farmaco]||[];
    anaOpts(opts.map(function(d){return {ic:'ğŸ’Š',lb:d.lb,v:d.v};}),function(v){
      ANA.data.dose=v;
      var doseLabel=doses[ANA.data.farmaco].find(function(d){return d.v===v;});
      anaMsg('usr',(doseLabel?doseLabel.lb:v));
      setTimeout(function(){anaStep4B();},200);
    });
  },400);
}

function anaStep4B(){
  anaProgresso(35);
  var farm=ANA.data.farmaco;
  var dose=parseFloat(ANA.data.dose||0);
  // Build protocol table
  var protocolos={
    Tirzepatida:[
      {sem:'Semanas 1â€“4',dose:'2,5 mg',info:'IntroduÃ§Ã£o â€” adaptaÃ§Ã£o'},
      {sem:'Semanas 5â€“8',dose:'5 mg',info:'1Âª dose terapÃªutica'},
      {sem:'Semanas 9â€“12',dose:'7,5 mg',info:'Saciedade consistente'},
      {sem:'Semanas 13â€“16',dose:'10 mg',info:'Eficaz para a maioria'},
      {sem:'Semanas 17â€“20',dose:'12,5 mg',info:'Se resposta subÃ³tima'},
      {sem:'Semana 21+',dose:'15 mg',info:'Dose mÃ¡xima'}
    ],
    Semaglutida:[
      {sem:'Semanas 1â€“4',dose:'0,25 mg',info:'AdaptaÃ§Ã£o'},
      {sem:'Semanas 5â€“8',dose:'0,5 mg',info:'1Âª dose terapÃªutica'},
      {sem:'Semanas 9â€“12',dose:'1,0 mg',info:'Dose terapÃªutica principal'},
      {sem:'Semanas 13â€“16',dose:'1,7 mg',info:'Dose intermediÃ¡ria'},
      {sem:'Semana 17+',dose:'2,4 mg',info:'Dose mÃ¡xima'}
    ],
    Liraglutida:[
      {sem:'Semana 1',dose:'0,6 mg/dia',info:'AdaptaÃ§Ã£o'},
      {sem:'Semana 2',dose:'1,2 mg/dia',info:'1Âª dose terapÃªutica'},
      {sem:'Semana 3',dose:'1,8 mg/dia',info:'Dose eficaz'},
      {sem:'Semana 4',dose:'2,4 mg/dia',info:'Dose intermediÃ¡ria'},
      {sem:'Semana 5+',dose:'3,0 mg/dia',info:'Dose mÃ¡xima'}
    ]
  };
  var proto=protocolos[farm]||[];
  var tableRows=proto.map(function(p){
    var doseNum=parseFloat(p.dose);
    var isCurrent=Math.abs(doseNum-dose)<0.01;
    var style=isCurrent?'background:rgba(74,222,128,.15);border-left:3px solid var(--g400);':'';
    return '<div style="display:flex;justify-content:space-between;align-items:center;padding:8px 10px;border-bottom:1px solid rgba(255,255,255,.06);'+style+'">'
      +'<div style="font-size:12px;color:rgba(255,255,255,.5)">'+p.sem+'</div>'
      +'<div style="font-size:13px;font-weight:700;color:'+(isCurrent?'var(--g400)':'#fff')+'">'+p.dose+(isCurrent?' â† vocÃª estÃ¡ aqui':'')+'</div>'
      +'<div style="font-size:11px;color:rgba(255,255,255,.45)">'+p.info+'</div>'
      +'</div>';
  }).join('');
  setTimeout(function(){
    anaMsg('bot','ğŸ“‹ <strong>Protocolo completo â€” '+farm+':</strong><div style="margin-top:10px;border-radius:10px;overflow:hidden;border:1px solid rgba(255,255,255,.1)">'+tableRows+'</div>');
    setTimeout(function(){
      anaMsg('bot','âš ï¸ <strong>Importante sobre a progressÃ£o:</strong> Esta tabela Ã© um <strong>guia, nÃ£o uma obrigaÃ§Ã£o</strong>. A dose sÃ³ sobe quando a saciedade atual nÃ£o for suficiente.<br><br>VocÃª pode ficar em '+ANA.data.dose+' mg por <strong>3, 4 ou 6 meses</strong> â€” se essa dose estÃ¡ trazendo saciedade natural, <strong>nÃ£o hÃ¡ motivo para aumentar</strong>.<br><br>ğŸ¯ A dose ideal Ã© a <strong>menor dose que te deixa satisfeito naturalmente</strong>. Chegar na dose mÃ¡xima nÃ£o Ã© o objetivo â€” encontrar sua dose certa Ã©.<br><br>ğŸš« <strong>Nunca aumente a dose por conta prÃ³pria. Essa decisÃ£o Ã© sempre do seu mÃ©dico.</strong>','clinical');
      setTimeout(function(){anaConfirm('Entendi! Continuar â†’', function(){anaStep5B();});},400);
    },700);
  },400);
}

function anaStep5B(){
  anaProgresso(46);
  setTimeout(function(){
    anaMsg('bot','Quando foi sua <strong>Ãºltima aplicaÃ§Ã£o</strong>?');
    anaOpts([
      {ic:'ğŸ“…',lb:'Hoje',v:'hoje'},
      {ic:'ğŸ“…',lb:'Ontem',v:'ontem'},
      {ic:'ğŸ“…',lb:'Escolher data',v:'data'}
    ],function(v){
      var d;
      if(v==='hoje'){d=hoje();}
      else if(v==='ontem'){var dt=new Date();dt.setDate(dt.getDate()-1);dt.setMinutes(dt.getMinutes()-dt.getTimezoneOffset());d=dt.toISOString().slice(0,10);}
      if(d){
        ANA.data.ultima=d;ANA.data.inicio=ANA.data.inicio||d;
        anaMsg('usr',v==='hoje'?'Hoje':'Ontem');
        setTimeout(function(){anaStep6B();},200);
      } else {
        anaMsg('usr','Escolher data');
        anaDate(function(dt){
          ANA.data.ultima=dt;ANA.data.inicio=ANA.data.inicio||dt;
          anaMsg('usr','Ãšltima dose: '+dt);
          setTimeout(function(){anaStep6B();},200);
        });
      }
    });
  },400);
}

function anaStep6B(){
  anaProgresso(55);
  setTimeout(function(){
    anaMsg('bot','Quando vocÃª <strong>iniciou o tratamento</strong>? (data da primeira dose)');
    anaDate(function(d){
      ANA.data.inicio=d;
      var sem=Math.max(1,Math.floor((Date.now()-new Date(d+'T12:00:00').getTime())/(7*24*3600*1000)));
      ANA.data.semana=sem;
      anaMsg('usr','Comecei em '+d);
      anaMsg('bot','<strong>'+sem+' semanas</strong> de tratamento. '+
        (sem<=4?'VocÃª estÃ¡ na fase de adaptaÃ§Ã£o. O corpo ainda estÃ¡ se ajustando Ã  medicaÃ§Ã£o.':
        sem<=8?'Fase onde a saciedade comeÃ§a a se estabelecer de forma consistente.':
        sem<=16?'Tratamento estabelecido. O padrÃ£o de perda jÃ¡ deve estar visÃ­vel.':
        'HistÃ³rico robusto. Vamos analisar e otimizar seu acompanhamento.'));
      setTimeout(function(){anaStep7B();},200);
    });
  },400);
}

function anaStep7B(){
  anaProgresso(64);
  setTimeout(function(){
    anaMsg('bot','A saciedade Ã© o principal sinal de que a medicaÃ§Ã£o funciona. <strong>Como vocÃª a descreve?</strong>');
    anaOpts([
      {ic:'ğŸ˜Œ',lb:'Me sinto saciado naturalmente',sub:'Paro de comer sem esforÃ§o',v:'saciado'},
      {ic:'ğŸ¤”',lb:'Tenho saciedade, mas fome Ã s vezes',sub:'Especialmente perto da prÃ³xima dose',v:'parcial'},
      {ic:'ğŸ˜®â€ğŸ’¨',lb:'Quase nÃ£o sinto diferenÃ§a',sub:'Fome semelhante ao anterior',v:'sem'},
      {ic:'ğŸš«',lb:'Sem apetite â€” esqueÃ§o de comer',sub:'Ã€s vezes nÃ£o como o dia todo',v:'sem_apetite'}
    ],function(v){
      ANA.data.saciedade=v;
      var r={
        saciado:'Ã“timo sinal. O GLP-1 estÃ¡ funcionando. Aproveite essa janela para priorizar proteÃ­na em cada refeiÃ§Ã£o.',
        parcial:'Normal â€” especialmente nos dias que antecedem a prÃ³xima dose. A farmacocinÃ©tica mostra que o nÃ­vel cai no final do ciclo. Monitoraremos isso no app.',
        sem:'Isso merece atenÃ§Ã£o. Pode ser dose ainda insuficiente, problema de armazenamento (a caneta precisa de 2Â°Câ€“8Â°C) ou tÃ©cnica de aplicaÃ§Ã£o. Vamos investigar.',
        sem_apetite:'âš ï¸ <strong>AtenÃ§Ã£o.</strong> AusÃªncia total de fome Ã© perigosa: sem proteÃ­na vocÃª perde mÃºsculo, nÃ£o gordura. Mesmo sem fome, coma proteÃ­na. Avise seu mÃ©dico.'
      };
      var lb={saciado:'Me sinto saciado',parcial:'Saciedade parcial',sem:'Quase nÃ£o sinto',sem_apetite:'EsqueÃ§o de comer'};
      anaMsg('usr',lb[v]);anaMsg('bot',r[v],null,function(){anaStep8B();});
    });
  },400);
}

function anaStep8B(){
  anaProgresso(72);
  setTimeout(function(){
    anaMsg('bot','Algum efeito colateral? <strong>Selecione os presentes:</strong>');
    anaChips([
      {lb:'ğŸ¤¢ NÃ¡usea',v:'nausea'},{lb:'ğŸª¨ ConstipaÃ§Ã£o',v:'constipacao'},{lb:'ğŸ’§ Diarreia',v:'diarreia'},
      {lb:'ğŸ˜® EstÃ´mago cheio',v:'estomago'},{lb:'ğŸš« Sem apetite',v:'semapetite'},{lb:'ğŸ”¥ Refluxo',v:'refluxo'},
      {lb:'ğŸ’† Queda de cabelo',v:'cabelo'},{lb:'âœ… Nenhum',v:'nenhum'}
    ],function(sel){
      ANA.data.sintomas=sel;
      if(sel.indexOf('nenhum')>=0){anaMsg('usr','Sem efeitos');anaMsg('bot','Ã“timo. TolerÃ¢ncia excelente.');}
      else{
        anaMsg('usr',sel.join(', '));
        if(sel.indexOf('cabelo')>=0) anaMsg('bot','ğŸ’† <strong>Queda de cabelo:</strong> NÃ£o Ã© causada pelo GLP-1 diretamente. Ã‰ o eflÃºvio telÃ³geno â€” resposta ao dÃ©ficit calÃ³rico. Ocorre 2â€“4 meses apÃ³s inÃ­cio, geralmente autolimitado. Priorize proteÃ­na e verifique ferro e biotina.','clinical');
        if(sel.indexOf('nausea')>=0) anaMsg('bot','ğŸ¤¢ <strong>NÃ¡usea:</strong> Causada pelo retardo do esvaziamento gÃ¡strico â€” esperado. Coma em volumes menores, proteÃ­na primeiro, nÃ£o deite logo apÃ³s comer.','clinical');
        if(sel.indexOf('constipacao')>=0) anaMsg('bot','ğŸª¨ <strong>ConstipaÃ§Ã£o:</strong> Aumente Ã¡gua imediatamente. Fibras gradualmente. Ameixa, mamÃ£o, kiwi. Mais de 5 dias sem evacuar â†’ avise seu mÃ©dico.','clinical');
      }
      setTimeout(function(){anaStep9B();},200);
    });
  },400);
}

function anaStep9B(){
  anaProgresso(80);
  setTimeout(function(){
    anaMsg('bot','Dados fÃ­sicos para calcular suas metas. <strong>Sexo biolÃ³gico:</strong>');
    anaOpts([{ic:'ğŸ‘¨',lb:'Masculino',v:'M'},{ic:'ğŸ‘©',lb:'Feminino',v:'F'}],function(v){
      ANA.data.sex=v;anaMsg('usr',v==='M'?'Masculino':'Feminino');
      setTimeout(function(){
        anaMsg('bot','<strong>Idade, altura, peso atual e peso meta:</strong>');
        anaNums4(function(age,h,wi,w,meta){
          ANA.data.age=age;ANA.data.heightCm=h;ANA.data.pesoInicio=wi;ANA.data.pesoAtual=w;
          ANA.data.pesoMeta=meta;
          anaMsg('usr',age+' anos Â· '+h+' cm Â· '+w+' kg Â· meta: '+meta+' kg');
          setTimeout(function(){anaStep10B();},200);
        });
      },400);
    });
  },400);
}

function anaStep10B(){
  anaProgresso(88);
  setTimeout(function(){
    anaMsg('bot','NÃ­vel de atividade fÃ­sica:');
    anaOpts([
      {ic:'ğŸª‘',lb:'SedentÃ¡rio',sub:'Trabalho sentado, sem exercÃ­cio',v:'SedentÃ¡rio'},
      {ic:'ğŸš¶',lb:'Leve',sub:'Caminhadas ou exercÃ­cio 1â€“3x/semana',v:'Leve'},
      {ic:'ğŸƒ',lb:'Moderada',sub:'ExercÃ­cio regular 3â€“5x/semana',v:'Moderada'},
      {ic:'ğŸ‹ï¸',lb:'Alta',sub:'Treino intenso 6â€“7x/semana',v:'Alta'}
    ],function(v){
      ANA.data.activ=v;anaMsg('usr',v);
      var M=calcMetricsAna();
      if(!M){anaDone();return;}
      var pm=Math.round(M.pm);
      var frango=Math.round(pm/0.31);
      var carne=Math.round(pm/0.26);
      var ovos=Math.round(pm/8);
      var whey=Math.round(pm/24);
      setTimeout(function(){
        anaMsg('bot','ğŸ“Š <strong>TMB: '+Math.round(M.tmb)+' kcal</strong> â€” energia que seu corpo gasta em repouso.<br>âš¡ <strong>GET: '+Math.round(M.get)+' kcal</strong> â€” gasto real no seu dia com '+v.toLowerCase()+'.<br><br>ğŸ’¡ <strong>Qualquer valor abaixo de '+Math.round(M.get)+' kcal jÃ¡ faz vocÃª emagrecer.</strong> O corpo busca energia na gordura. O GLP-1 facilita isso reduzindo a fome.<br><br>ğŸ¯ <strong>Meta calÃ³rica: '+Math.round(M.meta)+' kcal/dia</strong> (dÃ©ficit seguro de 500 kcal)','clinical');
        setTimeout(function(){
          anaMsg('bot','ğŸ¥© <strong>Meta de proteÃ­na: '+pm+'g PURA por dia.</strong><br><br>Isso equivale a:<br>ğŸ— <strong>'+frango+'g de peito de frango</strong> (31g prot/100g)<br>ğŸ¥© <strong>'+carne+'g de carne magra</strong> (26g prot/100g)<br>ğŸ¥š <strong>'+ovos+' ovos inteiros</strong> (8g prot/unidade)<br>ğŸ¥› <strong>'+whey+' scoops de whey</strong> (24g/scoop)<br><br>ğŸ’¡ Combine fontes ao longo do dia.','clinical');
          setTimeout(function(){
            anaMsg('bot','ğŸš¨ <strong>Se nÃ£o bater a meta de proteÃ­na, vocÃª perde gordura E mÃºsculo.</strong> Os dois aliados para preservar mÃºsculo sÃ£o:<br><br>ğŸ’ª <strong>Atividade resistida:</strong> musculaÃ§Ã£o, elÃ¡stico, pilates, agachamento, flexÃ£o, prancha.<br><br>ğŸ¥© <strong>ProteÃ­na distribuÃ­da</strong> ao longo do dia â€” nÃ£o tudo de uma vez.','clinical');
            setTimeout(function(){anaConfirm('Ver meu resumo â†’', function(){anaDone();});},400);
          },800);
        },800);
      },400);
    });
  },400);
}

function anaDone(){
  anaProgresso(100);
  el('anaMsgs').innerHTML='';el('anaInput').innerHTML='';
  var M=calcMetricsAna();
  var perd=ANA.data.pesoInicio&&ANA.data.pesoAtual?ANA.data.pesoInicio-ANA.data.pesoAtual:null;
  var nome=ANA.data.nome||'';
  var freq=ANA.data.farmaco==='Liraglutida'?'ğŸ’Š DiÃ¡rio':'ğŸ’‰ Semanal';
  var rows=[
    {l:'Nome',v:nome||'â€”'},
    {l:'FÃ¡rmaco',v:(ANA.data.farmaco||'â€”')+(ANA.data.dose?' â€” '+ANA.data.dose+' mg':'')},
    {l:'FrequÃªncia',v:freq},
    {l:'Peso no inÃ­cio',v:ANA.data.pesoInicio?ANA.data.pesoInicio+' kg':'â€”'},
    {l:'Peso atual',v:ANA.data.pesoAtual?ANA.data.pesoAtual+' kg':'â€”'},
    {l:'Peso meta',v:ANA.data.pesoMeta?ANA.data.pesoMeta+' kg':'â€”'},
    {l:'JÃ¡ perdeu',v:perd&&perd>0?'âˆ’'+rd(perd,1)+' kg ğŸ‰':perd===0?'InÃ­cio hoje':'â€”',cls:perd>0?'green':''},
    {l:'Meta calÃ³rica',v:M?Math.round(M.meta)+' kcal/dia':'â€”'},
    {l:'Meta proteÃ­na',v:M?Math.round(M.pm)+'g/dia':'â€”'},
    {l:'Meta Ã¡gua',v:M?Math.round(M.agua/250).toFixed(0)+' copos ('+Math.round(M.agua)+'ml)':'â€”'}
  ];
  var rHtml=rows.map(function(r){
    return '<div class="ana-done-row"><span class="ana-done-lbl">'+r.l+'</span><span class="ana-done-val'+(r.cls?' '+r.cls:'')+'" >'+r.v+'</span></div>';
  }).join('');
  var dv=document.createElement('div');dv.className='ana-done';
  dv.innerHTML='<div class="ana-done-ic">ğŸ‰</div>'
    +'<div class="ana-done-title">'+(nome?nome+', seu':'Seu')+' perfil estÃ¡ pronto!</div>'
    +'<div class="ana-done-sub">Acompanhamento personalizado ativo. VocÃª nÃ£o precisa preencher mais nada â€” sÃ³ registrar no dia a dia.</div>'
    +'<div class="ana-done-card">'+rHtml+'</div>'
    +'<button class="ana-done-btn" onclick="anaAbrir()">Entrar no Equilibra ğŸŒ¿</button>';
  el('anaMsgs').appendChild(dv);
  setTimeout(function(){var last=el('anaMsgs').lastElementChild;if(last) last.scrollIntoView({behavior:'smooth',block:'end'});},150);
}

function anaAbrir(){
  // 1. Gravar todos os dados da anamnese no objeto S
  if(ANA.data.nome)     S.profile.nome=ANA.data.nome;
  if(ANA.data.sex)      S.profile.sex=ANA.data.sex;
  if(ANA.data.age)      S.profile.age=ANA.data.age;
  if(ANA.data.heightCm) S.profile.heightCm=ANA.data.heightCm;
  if(ANA.data.activ)    S.profile.activityLevel=ANA.data.activ;
  if(ANA.data.pesoAtual){
    S.profile.weightKg=ANA.data.pesoAtual;
    var jah=hoje();
    if(!S.weights.find(function(w){return w.date===jah;}))
      S.weights.push({date:jah,weight:ANA.data.pesoAtual});
  }
  if(ANA.data.pesoInicio) S.profile.weightStartKg=ANA.data.pesoInicio;
  if(ANA.data.pesoMeta)   S.profile.weightGoalKg=ANA.data.pesoMeta;
  if(ANA.data.farmaco){
    S.caneta.farmaco=ANA.data.farmaco;
    S.caneta.freq=ANA.data.farmaco==='Liraglutida'?'diaria':'semanal';
  }
  if(ANA.data.dose)   S.caneta.dose=parseFloat(ANA.data.dose);
  if(ANA.data.inicio){S.caneta.inicio=ANA.data.inicio;S.profile.startDate=ANA.data.inicio;}
  if(ANA.data.ultima) S.caneta.ultima=ANA.data.ultima;

  // 2. Persistir no localStorage ANTES de qualquer coisa
  salvar();

  // 3. Mostrar app
  el('anaOv').style.display='none';
  el('mainHdr').style.display='block';
  el('mainWrap').style.display='block';
  el('tabBar').style.display='block';
  el('ceFab').style.display='none';
  el('helpFab').style.display='flex';
  buildSint();buildFAQ();
  buildPassos(PASSOS_CANETA,'passosCaneta');
  buildPassos(PASSOS_AMPOLA,'passosAmpola');

  // 4. render() â€” preenche dashboard e campos de perfil/caneta
  render();

  // 5. Popular campos de forma explÃ­cita e direta â€” garantia dupla
  // Perfil
  if(el('sexo'))    el('sexo').value=S.profile.sex||'M';
  if(el('idade'))   el('idade').value=S.profile.age||'';
  if(el('altura'))  el('altura').value=S.profile.heightCm||'';
  if(el('peso'))    el('peso').value=S.profile.weightKg||'';
  if(el('pesoI'))   el('pesoI').value=S.profile.weightStartKg||'';
  if(el('pesoMeta'))el('pesoMeta').value=S.profile.weightGoalKg||'';
  if(el('ativ'))    el('ativ').value=S.profile.activityLevel||'Moderada';
  if(el('dtIni'))   el('dtIni').value=S.profile.startDate||'';
  // Caneta â€” updateDoses() primeiro para popular o select, depois setar dose
  if(el('cFarm')&&S.caneta.farmaco){
    el('cFarm').value=S.caneta.farmaco;
    updateDoses();
    if(el('cDose')&&S.caneta.dose) el('cDose').value=String(S.caneta.dose);
    if(el('cFreq')) el('cFreq').value=S.caneta.freq||'semanal';
    if(el('cIni'))  el('cIni').value=S.caneta.inicio||'';
    if(el('cUlt'))  el('cUlt').value=S.caneta.ultima||'';
    if(el('cDia'))  el('cDia').value=String(S.caneta.diaSem||1);
  }

  go('dashboard');
}

/* â•â• UI Helpers Anamnese â•â• */
function anaMsg(t,txt,cls,cb){
  var m=el('anaMsgs');
  // Remove typing indicator if present
  var tw=m.querySelector('.tw-wrap');if(tw) m.removeChild(tw);

  if(t==='bot'){
    // Show typing indicator first
    var tw2=document.createElement('div');tw2.className='tw-wrap msg bot';
    tw2.innerHTML='<div class="msg-av bot">ğŸŒ¿</div><div class="typing"><span></span><span></span><span></span></div>';
    m.appendChild(tw2);
    tw2.scrollIntoView({behavior:'smooth',block:'end'});

    // Calculate read delay based on message length
    var words=txt.replace(/<[^>]+>/g,'').split(/\s+/).length;
    var readDelay=Math.min(3000,Math.max(800,words*60)); // 60ms per word, 800-3000ms

    setTimeout(function(){
      var tw3=m.querySelector('.tw-wrap');if(tw3) m.removeChild(tw3);
      var d=document.createElement('div');d.className='msg bot';
      var bc=cls==='clinical'?'msg-bubble clinical':'msg-bubble bot';
      d.innerHTML='<div class="msg-av bot">ğŸŒ¿</div><div class="'+bc+'">'+txt+'</div>';
      d.style.opacity='0';d.style.transition='opacity .3s ease';
      m.appendChild(d);
      setTimeout(function(){d.style.opacity='1';},30);
      d.scrollIntoView({behavior:'smooth',block:'end'});
      if(cb) setTimeout(cb, 400);
    }, readDelay);
  } else {
    var d=document.createElement('div');d.className='msg usr';
    d.innerHTML='<div class="msg-av usr">ğŸ‘¤</div><div class="msg-bubble usr">'+txt+'</div>';
    m.appendChild(d);
    d.scrollIntoView({behavior:'smooth',block:'end'});
    if(cb) cb();
  }
}

function anaOpts(opts,cb){
  var inp=el('anaInput');inp.innerHTML='';
  var d=document.createElement('div');d.className='ana-opts';
  opts.forEach(function(o){
    var b=document.createElement('button');b.className='ana-opt';
    b.innerHTML='<span class="ana-opt-ic">'+(o.ic||'')+'</span><div><div>'+o.lb+'</div>'+(o.sub?'<div class="ana-opt-sub">'+o.sub+'</div>':'')+'</div>';
    b.onclick=function(){inp.innerHTML='';cb(o.v);};d.appendChild(b);
  });
  inp.appendChild(d);
  addVoice(inp,opts,cb);
}

function anaChips(opts,cb){
  var inp=el('anaInput');inp.innerHTML='';
  var sel=[];
  var cd=document.createElement('div');cd.className='ana-opts-h';
  opts.forEach(function(o){
    var b=document.createElement('button');b.className='ana-chip';b.textContent=o.lb;
    b.onclick=function(){
      if(o.v==='nenhum'){sel=[o.v];cd.querySelectorAll('.ana-chip').forEach(function(x){x.classList.remove('sel');});b.classList.add('sel');}
      else{var ni=sel.indexOf('nenhum');if(ni>=0) sel.splice(ni,1);cd.querySelectorAll('.ana-chip').forEach(function(x){if(x.textContent==='âœ… Nenhum') x.classList.remove('sel');});
        var i=sel.indexOf(o.v);if(i>=0){sel.splice(i,1);b.classList.remove('sel');}else{sel.push(o.v);b.classList.add('sel');}
      }
    };cd.appendChild(b);
  });
  var cf=document.createElement('button');cf.className='ana-num-confirm';cf.style.marginTop='10px';cf.textContent='Confirmar';
  cf.onclick=function(){if(!sel.length) sel=[opts[opts.length-1].v];inp.innerHTML='';cb(sel);};
  var wrap=document.createElement('div');wrap.appendChild(cd);wrap.appendChild(cf);inp.appendChild(wrap);
}

function anaConfirm(btnTxt, cb){
  var inp=el('anaInput');inp.innerHTML='';
  var b=document.createElement('button');
  b.className='ana-num-confirm';
  b.textContent=btnTxt||'Entendi, continuar â†’';
  b.style.cssText='width:100%;margin-top:8px';
  b.onclick=function(){inp.innerHTML='';cb();};
  inp.appendChild(b);
  setTimeout(function(){var last=el('anaMsgs').lastElementChild;if(last) last.scrollIntoView({behavior:'smooth',block:'end'});},150);
}

function anaTextInput(ph, cb){
  var inp=el('anaInput');inp.innerHTML='';
  var i=document.createElement('input');
  i.type='text';i.className='ana-num-inp';i.placeholder=ph;i.style.marginBottom='8px';
  var b=document.createElement('button');b.className='ana-num-confirm';b.textContent='Confirmar';b.disabled=true;
  i.oninput=function(){b.disabled=!i.value.trim();};
  i.onkeydown=function(e){if(e.key==='Enter'&&i.value.trim()){inp.innerHTML='';cb(i.value.trim());}};
  b.onclick=function(){inp.innerHTML='';cb(i.value.trim());};
  inp.appendChild(i);inp.appendChild(b);
  setTimeout(function(){i.focus();},100);
}

function anaNums4(cb){
  var inp=el('anaInput');inp.innerHTML='';
  var a=mkNumInp('Idade (anos)','18-90',18,90);
  var h=mkNumInp('Altura (cm)','140-220',140,220);
  var wi=mkNumInp('Peso quando comeÃ§ou o tratamento (kg)','ex: 110',40,400,0.1);
  var w=mkNumInp('Peso atual (kg)','ex: 97.5',40,400,0.1);
  var m=mkNumInp('Peso meta (kg)','ex: 75',30,400,0.1);
  var btn=document.createElement('button');btn.className='ana-num-confirm';btn.textContent='Confirmar';btn.disabled=true;
  function chk(){btn.disabled=!(nv(a.value)&&nv(h.value)&&nv(wi.value)&&nv(w.value)&&nv(m.value));}
  a.oninput=h.oninput=wi.oninput=w.oninput=m.oninput=chk;
  btn.onclick=function(){inp.innerHTML='';cb(nv(a.value),nv(h.value),nv(wi.value),nv(w.value),nv(m.value));};
  var labels=['Idade (anos)','Altura (cm)','Peso no inÃ­cio do tratamento (kg)','Peso atual (kg)','Peso meta (kg)'];
  [a,h,wi,w,m].forEach(function(x,i){
    var lbl=document.createElement('div');
    lbl.style.cssText='font-size:11px;color:rgba(255,255,255,.5);margin-bottom:3px;font-weight:600;text-transform:uppercase;letter-spacing:.4px';
    lbl.textContent=labels[i];
    inp.appendChild(lbl);inp.appendChild(x);
  });
  inp.appendChild(btn);
}

function anaNums3(cb){
  var inp=el('anaInput');inp.innerHTML='';
  var a=mkNumInp('Idade (anos)','18-90',18,90);
  var h=mkNumInp('Altura (cm)','140-220',140,220);
  var w=mkNumInp('Peso (kg)','ex: 97.5',40,400,0.1);
  var btn=document.createElement('button');btn.className='ana-num-confirm';btn.textContent='Confirmar';btn.disabled=true;
  function chk(){btn.disabled=!(nv(a.value)&&nv(h.value)&&nv(w.value));}
  a.oninput=h.oninput=w.oninput=chk;
  btn.onclick=function(){inp.innerHTML='';cb(nv(a.value),nv(h.value),nv(w.value));};
  [a,h,w,btn].forEach(function(x){inp.appendChild(x);});
}

function anaNum1(lbl,ph,cb){
  var inp=el('anaInput');inp.innerHTML='';
  var i=mkNumInp(ph,'',30,400,0.1);i.style.marginBottom='8px';
  var b=document.createElement('button');b.className='ana-num-confirm';b.textContent='Confirmar';b.disabled=true;
  i.oninput=function(){b.disabled=!nv(i.value);};
  b.onclick=function(){inp.innerHTML='';cb(nv(i.value));};
  inp.appendChild(i);inp.appendChild(b);
}

function anaDate(cb){
  var inp=el('anaInput');inp.innerHTML='';
  var hint=document.createElement('div');
  hint.style.cssText='font-size:11px;color:rgba(255,255,255,.45);margin-bottom:6px;text-align:center';
  hint.textContent='Selecione a data e toque em Confirmar';
  var i=document.createElement('input');i.type='date';i.max=hoje();i.className='ana-num-inp';i.style.marginBottom='8px';
  var b=document.createElement('button');b.className='ana-num-confirm';b.textContent='âœ“ Confirmar data';b.disabled=true;
  b.style.cssText='width:100%;padding:16px;border-radius:12px;background:var(--g600);border:none;color:#fff;font-family:var(--ss);font-size:16px;font-weight:700;cursor:pointer;margin-top:4px';
  i.oninput=function(){b.disabled=!i.value;};
  b.onclick=function(){inp.innerHTML='';cb(i.value);};
  inp.appendChild(hint);inp.appendChild(i);inp.appendChild(b);
  // scroll msgs up to make room
  setTimeout(function(){var last=el('anaMsgs').lastElementChild;if(last) last.scrollIntoView({behavior:'smooth',block:'end'});},150);
}

function mkNumInp(ph,ph2,mn,mx,stp){
  var i=document.createElement('input');i.type='number';i.className='ana-num-inp';i.style.marginBottom='6px';
  i.placeholder=ph;i.min=mn;i.max=mx;if(stp) i.step=stp;return i;
}

function addVoice(c,opts,cb){
  var SR=window.SpeechRecognition||window.webkitSpeechRecognition;if(!SR) return;
  var b=document.createElement('button');b.className='ana-voice';b.innerHTML='ğŸ¤ Falar resposta';
  b.onclick=function(){
    var r=new SR();r.lang='pt-BR';
    r.onstart=function(){b.classList.add('listening');b.innerHTML='ğŸ”´ Ouvindoâ€¦';};
    r.onresult=function(e){
      var t=e.results[0][0].transcript.toLowerCase();b.classList.remove('listening');
      opts.forEach(function(o){if(t.indexOf(o.lb.toLowerCase())>=0||t.indexOf(o.v.toLowerCase())>=0){c.innerHTML='';anaMsg('usr',o.lb);cb(o.v);}});
      b.innerHTML='ğŸ¤ Falar resposta';
    };
    r.onerror=function(){b.classList.remove('listening');b.innerHTML='ğŸ¤ Falar resposta';};
    r.start();
  };c.appendChild(b);
}

function calcMetricsAna(){
  var w=ANA.data.pesoAtual,age=ANA.data.age,h=ANA.data.heightCm,sex=ANA.data.sex||'M',act=ANA.data.activ||'Moderada';
  if(!w||!age||!h) return null;
  var tmb=calcTMB(sex,age,h,w);var tdee=tmb*(AF[act]||1.35);
  return{tmb:tmb,get:tdee,meta:Math.round((tdee-500)/100)*100,pm:w*1.6,agua:w*35+(WBX[act]||200)};
}
function anaProgresso(p){el('anaFill').style.width=p+'%';}
</script>
<script>
/* â•â• UTILS â•â• */
function hoje(){var d=new Date();d.setMinutes(d.getMinutes()-d.getTimezoneOffset());return d.toISOString().slice(0,10);}
function rd(x,n){return Math.round(x*Math.pow(10,n||0))/Math.pow(10,n||0);}
function nv(v,fb){var x=parseFloat(v);return isNaN(x)?(fb!==undefined?fb:null):x;}
function el(id){return document.getElementById(id);}
function porData(a,b){return a.date<b.date?-1:a.date>b.date?1:0;}
function getDH(){for(var i=0;i<S.daily.length;i++){if(S.daily[i].date===hoje()) return S.daily[i];}return null;}
function calcSemanas(){if(!S.caneta.inicio) return null;return Math.floor((Date.now()-new Date(S.caneta.inicio+'T12:00:00').getTime())/(7*24*3600*1000));}

/* â•â• PERSISTÃŠNCIA â•â• */
function salvar(){try{localStorage.setItem(LS,JSON.stringify(S));}catch(e){}}
function carregar(){
  try{
    var r=localStorage.getItem(LS);
    if(r){var d=JSON.parse(r);if(d&&d.profile){S=d;if(!S.caneta) S.caneta={farmaco:'',dose:'',freq:'semanal',faseSac:'',inicio:'',ultima:'',diaSem:1,obs:''};if(S.caneta.faseSac===undefined) S.caneta.faseSac='';return true;}}
    var r4=localStorage.getItem('equilibra_v4');
    if(r4){var d4=JSON.parse(r4);if(d4&&d4.profile){S=d4;if(!S.caneta) S.caneta={farmaco:'',dose:'',freq:'semanal',faseSac:'',inicio:'',ultima:'',diaSem:1,obs:''};S.caneta.faseSac=S.caneta.faseSac||'';salvar();return true;}}
  }catch(e){}return false;
}

/* â•â• CÃLCULOS â•â• */
function calcTMB(sex,age,h,w){var b=10*w+6.25*h-5*age;return sex==='M'?b+5:b-161;}
function calcMetrics(){
  var w=ultimoPeso()||S.profile.weightKg;
  if(!w||!S.profile.age||!S.profile.heightCm) return null;
  var tmb=calcTMB(S.profile.sex,S.profile.age,S.profile.heightCm,w);
  var tdee=tmb*(AF[S.profile.activityLevel]||1.35);
  var meta=Math.round((tdee-500)/100)*100;
  return{w:w,tmb:tmb,tdee:tdee,meta:meta,def:tdee-meta,perda:(tdee-meta)*7/7700,pm:w*1.6,pi1:w*1.8,pi2:w*2.2,agua:w*35+(WBX[S.profile.activityLevel]||200)};
}
function ultimoPeso(){if(!S.weights.length) return null;return S.weights.slice().sort(porData)[S.weights.length-1].weight;}
function calcMA7(){
  var arr=S.weights.slice().sort(porData);
  return arr.map(function(r,i){var sl=arr.slice(Math.max(0,i-6),i+1),s=0;sl.forEach(function(x){s+=x.weight;});return{date:r.date,avg:s/sl.length};});
}
function perdaSemana(ma){if(ma.length<8) return null;return ma[ma.length-8].avg-ma[ma.length-1].avg;}
function classificar(rl,est){
  if(rl===null||est===null) return null;
  if(rl>=1.3*est) return{lbl:'Acelerado ğŸš€',cls:'tg',bar:'sbar-green',msg:'Excelente ritmo. Mantenha proteÃ­na e Ã¡gua.'};
  if(rl>=0.7*est) return{lbl:'No estimado âœ…',cls:'tb',bar:'sbar-green',msg:'Ritmo saudÃ¡vel e sustentÃ¡vel.'};
  if(rl>=-0.2)    return{lbl:'Sem perda â†”ï¸',cls:'tw',bar:'sbar-warn',msg:'OscilaÃ§Ã£o normal. Avalie consistÃªncia.'};
  return{lbl:'Recuperando â¬†ï¸',cls:'tr',bar:'sbar-red',msg:'Revise sal, Ã¡lcool, sono e calorias.'};
}
function dataBR(iso){if(!iso) return 'â€”';var p=iso.split('-');return p[2]+'/'+p[1]+'/'+p[0];}
function proxDose(){
  if(!S.caneta.farmaco||!S.caneta.ultima) return null;
  var ul=new Date(S.caneta.ultima+'T12:00:00'),pr=new Date(ul);
  if(S.caneta.freq==='semanal') pr.setDate(pr.getDate()+7);else pr.setDate(pr.getDate()+1);
  pr.setMinutes(pr.getMinutes()-pr.getTimezoneOffset());
  var iso=pr.toISOString().slice(0,10),diff=Math.ceil((pr.getTime()-Date.now())/(1000*60*60*24));
  return{date:iso,diff:diff};
}
function calcStreak(){
  if(!S.daily.length) return 0;
  var dates=S.daily.map(function(d){return d.date;}).sort();
  var streak=0,d=new Date();d.setMinutes(d.getMinutes()-d.getTimezoneOffset());
  var cur=d.toISOString().slice(0,10);
  for(var i=0;i<365;i++){
    if(dates.indexOf(cur)>=0){streak++;var p=new Date(cur+'T12:00:00');p.setDate(p.getDate()-1);p.setMinutes(p.getMinutes()-p.getTimezoneOffset());cur=p.toISOString().slice(0,10);}
    else if(i===0){var p2=new Date(cur+'T12:00:00');p2.setDate(p2.getDate()-1);p2.setMinutes(p2.getMinutes()-p2.getTimezoneOffset());cur=p2.toISOString().slice(0,10);if(dates.indexOf(cur)<0) break;}
    else break;
  }
  return streak;
}
function checkMS(perd){if(!perd||perd<=0) return null;var hit=null;MS.forEach(function(m){if(perd>=m.kg) hit=m;});return hit;}
function proteqiv(g){var c=Math.round((g/31)*100),b=Math.round((g/26)*100),e=Math.round(g/6),w=Math.round(g/23);return 'ğŸ— <b>'+c+'g</b> frango &nbsp;|&nbsp; ğŸ¥© <b>'+b+'g</b> carne &nbsp;|&nbsp; ğŸ¥š <b>'+e+' ovos</b> &nbsp;|&nbsp; ğŸ¥› <b>'+w+' scoops</b> whey<br><small style="color:var(--muted)">EquivalÃªncia para meta mÃ­nima.</small>';}
function buildDiet(M){
  if(!M||M.meta<1000) return null;
  var pm=Math.round(M.pm),meta=Math.round(M.meta);
  var h=new Date().getHours();

  // Pegar o que jÃ¡ foi consumido hoje
  var hoje_date=hoje();
  var dh=S.daily.find(function(d){return d.date===hoje_date;})||{};
  var protJa=dh.proteinG||0;
  var aguaJa=dh.waterMl||0;

  // Calcular o que resta
  var protResta=Math.max(0,pm-protJa);
  var kcalJa=protJa*4; // estimativa simples: proteÃ­na registrada Ã— 4kcal/g
  var kcalResta=Math.max(0,meta-kcalJa);

  // Definir refeiÃ§Ãµes restantes baseado no horÃ¡rio
  var refeicoes=[];
  if(h<10){refeicoes=['CafÃ© da manhÃ£','AlmoÃ§o','Lanche','Jantar'];}
  else if(h<12){refeicoes=['AlmoÃ§o','Lanche','Jantar'];}
  else if(h<15){refeicoes=['AlmoÃ§o','Lanche','Jantar'];}
  else if(h<19){refeicoes=['Jantar'];}
  else{refeicoes=['Ceia leve'];}

  var n=refeicoes.length;
  if(n===0) return null;

  // Distribuir o restante igualmente (com peso maior para almoÃ§o/jantar)
  var pesos={
    'CafÃ© da manhÃ£':0.20,'AlmoÃ§o':0.35,'Lanche':0.15,'Jantar':0.25,'Ceia leve':0.10
  };
  var totalPeso=refeicoes.reduce(function(s,r){return s+(pesos[r]||0.25);},0);

  var meals=refeicoes.map(function(ref){
    var p=pesos[ref]||0.25;
    var frac=p/totalPeso;
    var kcalRef=Math.round(kcalResta*frac);
    var protRef=Math.round(protResta*frac);
    var sugestoes={
      'CafÃ© da manhÃ£':'Ovos mexidos ('+Math.round(protRef*.6)+'g prot) + iogurte grego ('+Math.round(protRef*.4)+'g prot)',
      'AlmoÃ§o':'Frango grelhado '+Math.round(protRef/0.31)+'g + salada + arroz integral',
      'Lanche':'Whey ou atum em lata ~'+protRef+'g proteÃ­na',
      'Jantar':'Peixe ou carne '+Math.round(protRef/0.26)+'g + legumes no vapor',
      'Ceia leve':'Iogurte grego ou cottage â€” leve e proteico'
    };
    return{
      t:ref,
      d:sugestoes[ref]||'~'+protRef+'g proteÃ­na + '+kcalRef+' kcal',
      p:'~'+protRef+'g prot Â· '+kcalRef+' kcal'
    };
  });

  // Adicionar contexto do que jÃ¡ consumiu
  if(protJa>0){
    meals.unshift({
      t:'âœ… JÃ¡ consumido hoje',
      d:'ProteÃ­na registrada: '+protJa+'g Â· Restam '+protResta+'g para a meta de '+pm+'g',
      p:'Meta diÃ¡ria: '+pm+'g prot Â· '+meta+' kcal'
    });
  }

  return meals;
}

function buildNarr(M,rl,perd,dh,pd){
  var h=new Date().getHours(),s=h<12?'Bom dia':h<18?'Boa tarde':'Boa noite';
  var sem=calcSemanas(),semStr=sem!==null?sem+(sem!==1?' semanas':' semana')+' de tratamento':'';
  var perdStr=perd?rd(perd,1)+' kg perdidos':'';
  if(!M) return{tag:'SEU PAINEL',msg:'Configure seu perfil para acompanhamento personalizado.',det:'',btn:false};
  if(!S.weights.length) return{tag:'PRIMEIROS PASSOS',msg:'Vamos comeÃ§ar registrando seu peso de hoje.',det:'Com o peso registrado, calculo suas metas exatas.',btn:false};
  var rh=classificar(rl,M.perda);
  if(!dh){var det=semStr&&perdStr?semStr+'. '+perdStr+'.':semStr||perdStr;return{tag:s.toUpperCase(),msg:'FaÃ§a seu check-in de hoje para manter o acompanhamento em dia.',det:det,btn:true};}
  var apc=M.agua>0?Math.round(((dh.waterMl||0)/M.agua)*100):0;
  var aStr=apc>=80?'HidrataÃ§Ã£o em dia âœ“':apc>0?'HidrataÃ§Ã£o abaixo da meta.':'Registre sua Ã¡gua no prÃ³ximo check-in.';
  var msg,det;
  if(rh&&rl!==null){
    if(rh.bar==='sbar-green'){msg='VocÃª estÃ¡ no caminho certo.'+(perdStr?' '+perdStr+'.':'');det='Ritmo: '+rd(rl,2)+' kg/semana. '+aStr+(semStr?' '+semStr+'.':'');}
    else if(rh.bar==='sbar-warn'){msg='O peso estÃ¡ estÃ¡vel â€” normal e passageiro.';det='PlatÃ´s acontecem. Revise proteÃ­na e hidrataÃ§Ã£o.'+(perdStr?' '+perdStr+'.':'')+(semStr?' '+semStr+'.':'');}
    else{msg='O peso subiu levemente â€” vamos entender.';det='Causas comuns: sal, Ã¡lcool ou sono ruim.'+(semStr?' '+semStr+'.':'');}
  }else{msg='Acompanhamento ativo.';det='Registre 8+ pesagens para ver a tendÃªncia real.'+(semStr?' '+semStr+'.':'');}
  if(pd&&pd.diff<=1) det+=' ğŸ’‰ PrÃ³xima dose: '+(pd.diff<=0?'hoje!':'amanhÃ£.');
  return{tag:s.toUpperCase(),msg:msg,det:det,btn:false};
}

/* â•â• CALCULADORA DILUIÃ‡ÃƒO â•â• */
function updateCalcApres(){
  var f=el('calcFarm').value,s=el('calcApres');
  s.innerHTML='<option value="">â€” selecione a apresentaÃ§Ã£o â€”</option>';
  el('calcAmpolaWrap').style.display='none';
  el('calcRes').innerHTML='<div class="calc-empty">Selecione a apresentaÃ§Ã£o acima.</div>';
  if(!f){s.innerHTML='<option value="">â€” selecione o fÃ¡rmaco primeiro â€”</option>';return;}
  var list=APRES[f]||[];
  // Separar canetas e ampolas em grupos
  var temCaneta=list.some(function(a){return a.tipo==='caneta';});
  var temAmpola=list.some(function(a){return a.tipo==='ampola'||a.tipo==='ampola_manual';});
  if(temCaneta){var og=document.createElement('optgroup');og.label='ğŸ–Šï¸ Canetas prÃ©-cheias (dose jÃ¡ medida)';
    list.forEach(function(a,i){if(a.tipo==='caneta'){var o=document.createElement('option');o.value=i;o.textContent=a.lbl;og.appendChild(o);}});s.appendChild(og);}
  if(temAmpola){var og2=document.createElement('optgroup');og2.label='ğŸ’‰ Frascos / Ampolas (calcular seringa)';
    list.forEach(function(a,i){if(a.tipo==='ampola'||a.tipo==='ampola_manual'){var o=document.createElement('option');o.value=i;o.textContent=a.lbl;og2.appendChild(o);}});s.appendChild(og2);}
}
function updateCalcTipo(){
  var f=el('calcFarm').value,ai=el('calcApres').value;
  el('calcAmpolaWrap').style.display='none';
  el('calcRes').innerHTML='<div class="calc-empty">Selecione a apresentaÃ§Ã£o acima.</div>';
  if(!f||ai==='') return;
  var ap=APRES[f][parseInt(ai)];if(!ap) return;
  if(ap.tipo==='caneta'){
    el('calcAmpolaWrap').style.display='none';
    el('calcRes').innerHTML='<div class="calc-result"><div style="font-size:40px;text-align:center;margin-bottom:12px">ğŸ–Šï¸</div>'
      +'<div class="calc-big-lbl" style="text-align:center;font-size:16px;color:#4ade80;font-weight:700;margin-bottom:8px">Caneta prÃ©-cheia â€” sem cÃ¡lculo necessÃ¡rio!</div>'
      +'<div style="background:rgba(74,222,128,.08);border:1px solid rgba(74,222,128,.2);border-radius:10px;padding:14px;margin-bottom:12px">'
      +'<div style="font-size:13px;color:rgba(255,255,255,.85);line-height:1.7">'
      +'<strong style="color:#4ade80">'+ap.marca+'</strong> jÃ¡ entrega a dose exata.<br>'
      +'Cada aplicaÃ§Ã£o = <strong style="color:#fff">'+ap.dose+'</strong>.<br><br>'
      +'<span style="color:rgba(255,255,255,.6)">'+ap.info+'</span></div></div>'
      +'<div style="background:rgba(255,255,255,.06);border-radius:8px;padding:12px;font-size:12px;color:rgba(255,255,255,.6);line-height:1.6">'
      +'âœ… Selecione a dose no dial da caneta conforme a prescriÃ§Ã£o.<br>'
      +'âœ… Aplique subcutaneamente conforme orientaÃ§Ã£o mÃ©dica.<br>'
      +'âœ… NÃ£o Ã© necessÃ¡rio seringa de insulina para esta apresentaÃ§Ã£o.'
      +'</div></div>'
      +'<div class="calc-warn">âš ï¸ Siga sempre as instruÃ§Ãµes do seu mÃ©dico e do manual da caneta.</div>';
  } else if(ap.tipo==='ampola'){
    // Frasco com concentraÃ§Ã£o conhecida â€” prÃ©-preenche mg e mL
    el('calcAmpolaWrap').style.display='block';
    var mgEl=el('calcMg'),mlEl=el('calcMl');
    mgEl.value=ap.mgTotal||'';mlEl.value=ap.vol||'';
    mgEl.readOnly=true;mlEl.readOnly=true;
    mgEl.style.opacity='0.6';mlEl.style.opacity='0.6';
    el('calcDose').value='';el('calcDose').focus();
    el('calcRes').innerHTML='<div class="calc-empty">Informe a dose prescrita abaixo para calcular.</div>';
    calcDil();
  } else if(ap.tipo==='ampola_manual'){
    // Frasco com valores a preencher pelo paciente
    el('calcAmpolaWrap').style.display='block';
    var mgEl=el('calcMg'),mlEl=el('calcMl');
    mgEl.value='';mlEl.value='';
    mgEl.readOnly=false;mlEl.readOnly=false;
    mgEl.style.opacity='1';mlEl.style.opacity='1';
    el('calcDose').value='';
    el('calcRes').innerHTML='<div class="calc-empty">Preencha as informaÃ§Ãµes do frasco e a dose prescrita.</div>';
  }
}
function calcDil(){
  var f=el('calcFarm').value,ai=el('calcApres').value;
  if(!f||ai==='') return;
  var ap=APRES[f][parseInt(ai)];if(!ap||ap.tipo==='caneta') return;
  var mgFrasco=nv(el('calcMg').value),mlFrasco=nv(el('calcMl').value),dose=nv(el('calcDose').value);
  // Mostrar concentraÃ§Ã£o calculada em tempo real
  var concEl=el('calcConcResult');
  if(mgFrasco>0&&mlFrasco>0){
    var conc=mgFrasco/mlFrasco;
    concEl.style.display='block';
    concEl.innerHTML='= <strong style="color:#4ade80">'+rd(conc,2)+' mg/mL</strong>';
  } else {
    concEl.style.display='none';
  }
  if(!mgFrasco||!mlFrasco||!dose){
    if(mgFrasco>0&&mlFrasco>0&&!dose) el('calcRes').innerHTML='<div class="calc-empty">Informe a dose prescrita abaixo.</div>';
    else if(!mgFrasco||!mlFrasco) el('calcRes').innerHTML='<div class="calc-empty">Preencha as informaÃ§Ãµes do frasco acima.</div>';
    return;
  }
  var conc=mgFrasco/mlFrasco;
  if(conc<=0){el('calcRes').innerHTML='<div class="calc-empty" style="color:#f87171">Valores invÃ¡lidos.</div>';return;}
  var vol=dose/conc,uni=Math.round(vol*100),uniR=Math.round(uni/5)*5;
  var avisoSer=uni>100?'<div style="margin-top:10px;padding:10px;background:rgba(220,38,38,.15);border:1px solid rgba(220,38,38,.3);border-radius:8px;font-size:12px;color:#fca5a5">ğŸš¨ <strong>AtenÃ§Ã£o:</strong> '+uni+' UI excede 100 UI (capacidade da seringa). Confirme os dados com seu mÃ©dico.</div>':'';
  var html='<div class="calc-result">'
    +'<div class="calc-big">'+uni+'</div>'
    +'<div class="calc-big-lbl">unidades na seringa de insulina U-100</div>'
    +'<div class="calc-row">'
    +'<div class="calc-det-item"><div class="calc-item-val">'+dose+' mg</div><div class="calc-item-lbl">Dose prescrita</div></div>'
    +'<div class="calc-det-item"><div class="calc-item-val">'+rd(conc,2)+' mg/mL</div><div class="calc-item-lbl">ConcentraÃ§Ã£o</div></div>'
    +'<div class="calc-det-item"><div class="calc-item-val">'+rd(vol,3)+' mL</div><div class="calc-item-lbl">Volume</div></div>'
    +'</div>';
  if(Math.abs(uni-uniR)>0) html+='<div style="margin-top:10px;font-size:12px;color:#a5b4fc;text-align:center">Arredondamento sugerido: <strong>'+uniR+' UI</strong></div>';
  html+=avisoSer+'</div>'
    +'<div class="calc-warn" style="margin-top:10px">âš ï¸ Unidades = (dose Ã· concentraÃ§Ã£o) Ã— 100 &nbsp;|&nbsp; Sempre confirme com seu mÃ©dico antes da aplicaÃ§Ã£o.</div>';
  el('calcRes').innerHTML=html;
}

/* â•â• COMO ESTOU â•â• */
var vozTxt='',vozAtiva=false;
function abrirCE(){el('ceOv').classList.add('open');document.body.style.overflow='hidden';buildCE();}
function fecharCE(){el('ceOv').classList.remove('open');document.body.style.overflow='';pararVoz();}
el('ceOv').addEventListener('click',function(e){if(e.target===this) fecharCE();});

function buildCE(){
  var M=calcMetrics(),ma=calcMA7(),rl=perdaSemana(ma),sw=S.profile.weightStartKg,cw=M?M.w:null;
  var perd=sw&&cw&&sw>cw?sw-cw:null,pd=proxDose(),dh=getDH(),sem=calcSemanas();
  var h=new Date().getHours(),s=h<12?'Bom dia':h<18?'Boa tarde':'Boa noite';
  el('ceTitle').textContent=M?s+(S.caneta.farmaco&&sem!==null?' â€” Semana '+sem+' de tratamento':''):'Configure seu perfil';
  el('ceSub').textContent=S.caneta.farmaco?(S.caneta.farmaco+(S.caneta.dose?' Â· '+S.caneta.dose:'')):'Tratamento nÃ£o configurado';
  var grid=el('ceGrid');grid.innerHTML='';
  var kpis=[];
  if(M&&S.weights.length){
    kpis.push({l:'Peso atual',v:rd(cw,1)+' kg',h:sw?'InÃ­cio: '+rd(sw,1)+' kg':'â€”',c:'ok'});
    kpis.push({l:'Perdido total',v:perd?'âˆ’'+rd(perd,1)+' kg':'â€”',h:perd?'Desde o inÃ­cio âœ“':'Registre peso inicial',c:perd?'ok':'warn'});
    var ritmoC='ok',ritmoV='â€”',ritmoH='Registre 8+ pesagens';
    if(rl!==null){ritmoV=rd(rl,2)+' kg/sem';if(rl>=0.3){ritmoC='ok';ritmoH='Ritmo dentro do esperado âœ“';}else if(rl>=-0.1){ritmoC='warn';ritmoH='PlatÃ´ â€” revise proteÃ­na e Ã¡gua';}else{ritmoC='danger';ritmoH='Revise sal, Ã¡lcool e sono';}}
    if(S.weights.length>=3) kpis.push({l:'Ritmo real',v:ritmoV,h:ritmoH,c:ritmoC});
    kpis.push({l:'Meta calÃ³rica',v:Math.round(M.meta)+' kcal',h:'DÃ©ficit ~'+Math.round(M.def)+' kcal/dia',c:'ok'});
    var aH=dh&&dh.waterMl?dh.waterMl:0,aP=Math.round((aH/M.agua)*100);
    kpis.push({l:'Ãgua hoje',v:aH?aH+' ml':'â€”',h:aP>=80?'Em dia âœ“':aH?aP+'% da meta':'NÃ£o registrado',c:aP>=80?'ok':aP>=50?'warn':'danger'});
    var pH=dh&&dh.proteinG?dh.proteinG:0,pP=Math.round((pH/M.pm)*100);
    kpis.push({l:'ProteÃ­na hoje',v:pH?pH+'g':'â€”',h:pP>=100?'Meta atingida âœ“':pH?pP+'% da meta ('+Math.round(M.pm)+'g)':'Meta: '+Math.round(M.pm)+'g',c:pP>=100?'ok':pP>=70?'warn':'danger'});
    if(pd){var pC=pd.diff<=0?'danger':pd.diff<=2?'warn':'ok';kpis.push({l:'PrÃ³xima dose',v:pd.diff<=0?'HOJE ğŸ’‰':pd.diff===1?'AmanhÃ£':'Em '+pd.diff+'d',h:pd.date,c:pC});}
    if(S.caneta.faseSac){var sv={ok:'Funcionando âœ“',comp:'Comprometida âš ï¸',sem:'Ausente ğŸš¨'};var sc={ok:'ok',comp:'warn',sem:'danger'};kpis.push({l:'Saciedade',v:sv[S.caneta.faseSac]||'â€”',h:'AvaliaÃ§Ã£o recente',c:sc[S.caneta.faseSac]||''});}
  }
  kpis.forEach(function(k){var d=document.createElement('div');d.className='ce-kpi'+(k.c?' '+k.c:'');d.innerHTML='<div class="ce-kl">'+k.l+'</div><div class="ce-kv">'+k.v+'</div><div class="ce-kh">'+k.h+'</div>';grid.appendChild(d);});
  var fm='',fs='';
  if(!M){fm='Configure seu perfil.';fs='Sem dados nÃ£o consigo calcular nada.';}
  else if(!dh){fm='FaÃ§a seu check-in de hoje.';fs='A aÃ§Ã£o mais importante do dia â€” menos de 1 minuto.';}
  else {
    var aguaHoje=dh&&dh.waterMl?dh.waterMl:0;
    var protHoje=dh&&dh.proteinG?dh.proteinG:0;
    var aguaFalta=Math.max(0,Math.round(M.agua-aguaHoje));
    var protFalta=Math.max(0,Math.round(M.pm-protHoje));
    var aguaPct=Math.min(100,Math.round((aguaHoje/M.agua)*100));
    var protPct=Math.min(100,Math.round((protHoje/M.pm)*100));
    var focos=[];
    if(pd&&pd.diff===0) focos.push('ğŸ’‰ Aplicar '+S.caneta.farmaco+' hoje');
    if(aguaPct<100) focos.push('ğŸ’§ Ãgua: '+aguaHoje+'ml de '+Math.round(M.agua)+'ml â€” faltam '+aguaFalta+'ml ('+aguaPct+'%)');
    if(protPct<100) focos.push('ğŸ¥© ProteÃ­na: '+protHoje+'g de '+Math.round(M.pm)+'g â€” faltam '+protFalta+'g ('+protPct+'%)');
    if(focos.length===0) focos.push('âœ… Metas batidas! Continue assim.');
    fm=focos[0];
    fs=focos.slice(1).join(' Â· ')||(rl!==null&&rl<-0.1?'Peso subiu â€” revise sal e Ã¡lcool.':'ConsistÃªncia Ã© o segredo do GLP-1.');
    if(S.caneta.faseSac==='sem'){fm='âš ï¸ Converse com seu mÃ©dico.';fs='VocÃª registrou ausÃªncia de saciedade. Requer avaliaÃ§Ã£o.';}
  }
  el('ceFocoMsg').textContent=fm;el('ceFocoSub').textContent=fs;
  var partes=[el('ceTitle').textContent+'.'];
  if(perd) partes.push('VocÃª perdeu '+rd(perd,1)+' quilos desde o inÃ­cio.');
  if(rl!==null) partes.push('Ritmo: '+rd(rl,2)+' quilos por semana.');
  if(pd) partes.push(pd.diff<=0?'AtenÃ§Ã£o: hoje Ã© dia da sua dose.':'PrÃ³xima dose em '+pd.diff+' dias.');
  partes.push(fm+' '+fs);
  vozTxt=partes.join(' ');
}
function toggleVoz(){
  if(vozAtiva){pararVoz();return;}
  if(!window.speechSynthesis){toast('Voz nÃ£o disponÃ­vel.');return;}
  pararVoz();
  var u=new SpeechSynthesisUtterance(vozTxt);u.lang='pt-BR';u.rate=0.93;
  var vv=window.speechSynthesis.getVoices();var pv=vv.find(function(v){return v.lang==='pt-BR';});if(pv) u.voice=pv;
  u.onstart=function(){vozAtiva=true;el('ceVBtn').classList.add('speaking');el('ceVIc').textContent='â¸';el('ceVTxt').textContent='Pausar';};
  u.onend=u.onerror=function(){vozAtiva=false;el('ceVBtn').classList.remove('speaking');el('ceVIc').textContent='ğŸ”Š';el('ceVTxt').textContent='Ouvir em voz alta';};
  window.speechSynthesis.speak(u);
}
function pararVoz(){window.speechSynthesis&&window.speechSynthesis.cancel();vozAtiva=false;var b=el('ceVBtn');if(b){b.classList.remove('speaking');el('ceVIc').textContent='ğŸ”Š';el('ceVTxt').textContent='Ouvir em voz alta';}}

/* â•â• SINTOMAS BUILD â•â• */
function buildSint(){
  var g=el('sintGrid');if(!g) return;g.innerHTML='';
  SINT.forEach(function(s){
    var c=document.createElement('div');c.className='sint-card '+s.cls;
    var lv=s.nv.filter(function(n){return n.tx;}).map(function(n){return '<div class="sint-level '+n.c+'"><div class="sl-ttl">'+(n.t||'')+'</div>'+n.tx+'</div>';}).join('');
    c.innerHTML='<div class="sint-ttl">'+s.ttl+'</div><div class="sint-cause">'+s.causa+'</div><div style="font-size:11px;color:var(--muted);margin-bottom:6px">â± '+s.quando+'</div><div class="sint-levels">'+lv+'</div>';
    g.appendChild(c);
  });
}

/* â•â• ALIMENTOS â€” PROTEÃNA â•â• */
var PROT_ALIMENTOS=[
  {id:'frango',   nm:'ğŸ— Frango/Peito cozido',       fator:0.31},
  {id:'carne',    nm:'ğŸ¥© Carne magra (patinho)',      fator:0.26},
  {id:'peixe',    nm:'ğŸŸ Peixe grelhado',             fator:0.25},
  {id:'atum_lata',nm:'ğŸ¥« Atum em lata',               fator:0.26},
  {id:'ovo',      nm:'ğŸ¥š Ovo inteiro',                fator:0.125},
  {id:'claras',   nm:'ğŸ¥š SÃ³ claras',                  fator:0.11},
  {id:'whey',     nm:'ğŸ¥› Whey protein (pÃ³)',          fator:0.80},
  {id:'cottage',  nm:'ğŸ§€ Cottage',                    fator:0.12},
  {id:'iogurte',  nm:'ğŸ¥› Iogurte grego',              fator:0.09},
  {id:'queijo',   nm:'ğŸ§€ Queijo minas frescal',       fator:0.17},
  {id:'camarao',  nm:'ğŸ¤ CamarÃ£o cozido',             fator:0.24},
  {id:'porco',    nm:'ğŸ¥“ Lombo de porco',             fator:0.27}
];

/* Chips rÃ¡pidos: porÃ§Ãµes do dia a dia jÃ¡ com peso prÃ©-definido */
var PROT_CHIPS=[
  {ic:'ğŸ—',nm:'Peito frango',sub:'100g',alim:'frango',g:100},
  {ic:'ğŸ—',nm:'Peito frango',sub:'200g',alim:'frango',g:200},
  {ic:'ğŸ¥š',nm:'1 ovo',sub:'~60g',alim:'ovo',g:60},
  {ic:'ğŸ¥š',nm:'3 ovos',sub:'~180g',alim:'ovo',g:180},
  {ic:'ğŸ¥›',nm:'1 scoop whey',sub:'30g',alim:'whey',g:30},
  {ic:'ğŸ¥«',nm:'1 lata atum',sub:'120g',alim:'atum_lata',g:120},
  {ic:'ğŸ§€',nm:'Cottage',sub:'100g',alim:'cottage',g:100},
  {ic:'ğŸ¥›',nm:'Iogurte grego',sub:'170g',alim:'iogurte',g:170},
  {ic:'ğŸ¥©',nm:'Carne magra',sub:'150g',alim:'carne',g:150},
  {ic:'ğŸŸ',nm:'Peixe',sub:'150g',alim:'peixe',g:150}
];

var protFoods=[];    // itens do modo peso real: [{alimId, grams}]
var protChipsAdded=[];  // itens do modo chips: [{chipIdx, qty}]

/* â”€â”€ Chips rÃ¡pidos â”€â”€ */
function buildProtChips(){
  var wrap=el('protChipsWrap');if(!wrap) return;
  wrap.innerHTML='';
  PROT_CHIPS.forEach(function(c,i){
    var btn=document.createElement('button');
    btn.id='pchip_'+i;
    btn.onclick=function(){toggleProtChip(i);};
    var qty=protChipsAdded.filter(function(x){return x.chipIdx===i;}).length;
    btn.style.cssText='padding:7px 12px;border-radius:999px;border:1.5px solid var(--cream3);background:'+(qty>0?'var(--g100)':'transparent')+';color:'+(qty>0?'var(--g700)':'var(--ink3)')+';font-family:var(--ss);font-size:12px;font-weight:600;cursor:pointer;transition:all .17s;display:flex;align-items:center;gap:5px';
    btn.innerHTML=c.ic+' '+c.nm+'<span style="color:var(--muted);font-weight:400"> '+c.sub+'</span>'+(qty>1?' <span style="background:var(--g600);color:#fff;border-radius:999px;padding:1px 6px;font-size:10px">Ã—'+qty+'</span>':'');
    wrap.appendChild(btn);
  });
}

function toggleProtChip(i){
  // Se jÃ¡ adicionado, remove o mais recente. SenÃ£o, adiciona.
  var existing=protChipsAdded.map(function(x,j){return x.chipIdx===i?j:-1;}).filter(function(j){return j>=0;});
  if(existing.length>0){
    protChipsAdded.splice(existing[existing.length-1],1);
  } else {
    protChipsAdded.push({chipIdx:i});
  }
  buildProtChips();
  calcProtTotal();
}

/* â”€â”€ Peso real (dropdown + gramas) â”€â”€ */
function addProtFood(){
  var idx=protFoods.length;
  protFoods.push({alimId:'frango',grams:''});
  renderProtFoods();
  setTimeout(function(){var g=document.getElementById('pfg_'+idx);if(g) g.focus();},50);
}
function removeProtFood(idx){
  protFoods.splice(idx,1);
  renderProtFoods();
  calcProtTotal();
}
function renderProtFoods(){
  var wrap=el('protFoodList');wrap.innerHTML='';
  protFoods.forEach(function(item,idx){
    var div=document.createElement('div');
    div.style.cssText='display:flex;gap:8px;align-items:center';
    var alimOpts=PROT_ALIMENTOS.map(function(a){
      return '<option value="'+a.id+'"'+(a.id===item.alimId?' selected':'')+'>'+a.nm+'</option>';
    }).join('');
    div.innerHTML=''
      +'<select onchange="protFoods['+idx+'].alimId=this.value;calcProtTotal()" '
      +'style="flex:1;padding:9px 10px;border-radius:9px;border:1.5px solid var(--cream3);background:var(--cream);color:var(--ink);font-family:var(--ss);font-size:13px;outline:none">'
      +alimOpts+'</select>'
      +'<div style="display:flex;align-items:center;gap:4px;flex-shrink:0">'
      +'<input id="pfg_'+idx+'" type="number" min="0" step="5" placeholder="g" value="'+(item.grams||'')+'" '
      +'oninput="protFoods['+idx+'].grams=this.value;calcProtTotal()" '
      +'style="width:72px;padding:9px 8px;border-radius:9px;border:1.5px solid var(--cream3);background:var(--cream);color:var(--ink);font-family:var(--ss);font-size:15px;font-weight:700;text-align:center;outline:none"/>'
      +'<span style="font-size:12px;color:var(--muted)">g</span>'
      +'</div>'
      +'<button onclick="removeProtFood('+idx+')" style="flex-shrink:0;width:28px;height:28px;border-radius:50%;border:none;background:var(--cream2);color:var(--muted);cursor:pointer;font-size:14px;display:flex;align-items:center;justify-content:center">âœ•</button>';
    wrap.appendChild(div);
  });
}

/* â”€â”€ CÃ¡lculo total combinado â”€â”€ */
function calcProtTotal(){
  var total=0;
  // De chips
  protChipsAdded.forEach(function(x){
    var c=PROT_CHIPS[x.chipIdx];
    var a=PROT_ALIMENTOS.find(function(a){return a.id===c.alim;});
    if(a) total+=Math.round(c.g*a.fator);
  });
  // De peso real
  protFoods.forEach(function(item){
    var alim=PROT_ALIMENTOS.find(function(a){return a.id===item.alimId;});
    var g=parseFloat(item.grams)||0;
    if(alim&&g>0) total+=Math.round(g*alim.fator);
  });
  el('protTotal').textContent=total+' g';
  el('ciProt').value=total>0?total:'';
  // Atualiza meta se disponÃ­vel
  var M=calcMetrics();
  var pm=el('protMeta');
  if(pm&&M){
    var pct=Math.round((total/M.pm)*100);
    var cor=pct>=100?'var(--g600)':pct>=70?'var(--warn)':'var(--red)';
    pm.innerHTML='<span style="color:'+cor+';font-weight:700">'+pct+'%</span> da meta ('+Math.round(M.pm)+'g)';
  }
}

function resetProtFoods(){
  protFoods=[];
  protChipsAdded=[];
  renderProtFoods();
  buildProtChips();
  el('protTotal').textContent='0 g';
  el('ciProt').value='';
  var pm=el('protMeta');if(pm) pm.textContent='â€”';
}

/* Inicializa chips ao carregar a aba */
function initProtChips(){
  if(el('protChipsWrap')&&el('protChipsWrap').childElementCount===0) buildProtChips();
}

/* â•â• CHECK-IN â•â• */
var ciSac=null,ciSint=[];
function setSac(v){ciSac=v;el('ciS1').className='ci-card'+(v==='saciado'?' good':'');el('ciS2').className='ci-card'+(v==='fome'?' bad':'');el('ciActFome').className='ci-act'+(v==='fome'?' show':'');}
function setSint(v){el('ciQ1').className='ci-card'+(v==='ok'?' good':'');el('ciQ2').className='ci-card'+(v==='sim'?' bad':'');el('sintWrap').style.display=v==='sim'?'block':'none';if(v==='ok'){ciSint=[];atuChips();}}
function toggleChip(id){var i=ciSint.indexOf(id);if(i>=0) ciSint.splice(i,1);else ciSint.push(id);atuChips();}
function atuChips(){
  var m={nausea:'chNA',vomito:'chVO',estomago:'chES',constipacao:'chCO',diarreia:'chDI',semapetite:'chSA',refluxo:'chRE',fadiga:'chFA',tontura:'chTO'};
  Object.keys(m).forEach(function(c){var on=ciSint.indexOf(c)>=0;var e=el(m[c]);if(e) e.className='chip'+(on?' on':'');var ca=el('ca-'+c);if(ca) ca.className='chip-act'+(on?' show':'');});
  el('alChips').style.display=ciSint.length>=2?'block':'none';
}
/* â•â• DICIONÃRIO DE TERMOS â•â• */
var DICIONARIO={
  TMB:{ic:'ğŸ˜´',titulo:'Metabolismo em repouso',txt:'Ã‰ a energia que seu corpo gasta sÃ³ para existir â€” respirar, coraÃ§Ã£o bater, manter temperatura. Mesmo deitado o dia todo, vocÃª gasta essa quantidade.'},
  GET:{ic:'ğŸƒ',titulo:'Energia no seu dia',txt:'Ã‰ o metabolismo em repouso somado a tudo que vocÃª faz: trabalhar, caminhar, treinar. Representa o total que vocÃª realmente gasta num dia.'},
  meta:{ic:'ğŸ¯',titulo:'Meta de calorias',txt:'Comer um pouco menos do que vocÃª gasta faz o corpo buscar energia na gordura armazenada. O GLP-1 facilita isso reduzindo a fome naturalmente.'},
  perda:{ic:'ğŸ“‰',titulo:'Perda esperada',txt:'Estimativa teÃ³rica baseada no seu dÃ©ficit calÃ³rico. O resultado real varia por retenÃ§Ã£o de Ã¡gua, ciclo hormonal, sono e outros fatores. Confie na tendÃªncia da semana.'},
  agua:{ic:'ğŸ’§',titulo:'HidrataÃ§Ã£o',txt:'Ãgua Ã© fundamental com GLP-1. DesidrataÃ§Ã£o imita fome e piora efeitos colaterais como nÃ¡usea e constipaÃ§Ã£o. Meta: 35ml por kg de peso.'},
  hidratacao:{ic:'ğŸ’§',titulo:'Ãgua & ProteÃ­na',txt:'Os dois pilares do sucesso com GLP-1. Ãgua previne efeitos colaterais. ProteÃ­na protege seus mÃºsculos enquanto vocÃª perde gordura.'},
  proteina:{ic:'ğŸ¥©',titulo:'ProteÃ­na',txt:'Com GLP-1 vocÃª come menos â€” por isso cada grama conta. ProteÃ­na protege mÃºsculo, aumenta saciedade e acelera metabolismo. Meta: 1,6 a 2,2g por kg de peso corporal.'},
  metabolismo:{ic:'âš¡',titulo:'Metabolismo & Metas',txt:'Esses nÃºmeros mostram quanto vocÃª gasta e quanto deve comer para perder peso de forma saudÃ¡vel e sustentÃ¡vel.'},
  prato:{ic:'ğŸ½ï¸',titulo:'Ordem do prato',txt:'ProteÃ­na primeiro â†’ ativa saciedade antes de calorias extras. Salada segundo â†’ fibras retardam absorÃ§Ã£o de carboidratos. Carboidrato por Ãºltimo â†’ vocÃª come menos naturalmente.'},
  farmaco:{ic:'ğŸ“Š',titulo:'NÃ­vel do remÃ©dio no sangue',txt:'Curva estimada baseada na farmacocinÃ©tica publicada do medicamento. A zona verde indica quando a saciedade Ã© mais intensa. ApÃ³s a dose, o nÃ­vel sobe, atinge o pico e cai gradualmente atÃ© a prÃ³xima aplicaÃ§Ã£o.'}
};

function mostrarDica(termo){
  var d=DICIONARIO[termo];if(!d) return;
  var modal=document.createElement('div');
  modal.style.cssText='position:fixed;inset:0;background:rgba(0,0,0,.5);z-index:2000;display:flex;align-items:center;justify-content:center;padding:20px';
  modal.innerHTML='<div style="background:#fff;border-radius:18px;padding:26px;max-width:380px;width:100%;box-shadow:0 12px 40px rgba(0,0,0,.2)">'
    +'<div style="font-size:32px;margin-bottom:10px">'+d.ic+'</div>'
    +'<div style="font-family:var(--fs);font-size:18px;color:var(--ink);margin-bottom:10px;font-weight:500">'+d.titulo+'</div>'
    +'<div style="font-size:14px;color:var(--ink3);line-height:1.7">'+d.txt+'</div>'
    +'<button onclick="document.body.removeChild(this.parentNode.parentNode)" style="margin-top:18px;width:100%;padding:12px;border-radius:10px;background:var(--g600);border:none;color:#fff;font-family:var(--ss);font-size:14px;font-weight:700;cursor:pointer">Entendi! âœ“</button>'
    +'</div>';
  modal.onclick=function(e){if(e.target===modal) modal.remove();};
  document.body.appendChild(modal);
}

function abrirAjuda(){
  var b=el('helpBubble');
  b.style.display=b.style.display==='none'?'block':'none';
}
function fecharAjuda(){el('helpBubble').style.display='none';}

function addAgua(ml){
  var c=nv(el('ciAgua').value,0);
  el('ciAgua').value=c+ml;
  var copos=Math.round((c+ml)/250);
  var disp=el('aguaCoposDisplay');
  if(disp) disp.textContent=copos+' copo'+(copos!==1?'s':'')+ ' ('+((c+ml)/1000).toFixed(1)+'L)';
}
function salvarCI(){
  var d=hoje();
  var entry={date:d,saciedade:ciSac,waterMl:nv(el('ciAgua').value,null),urine:el('ciUrina').value||null,symptom:ciSint.length?ciSint.join(','):'OK',intensity:ciSint.length>=2?2:ciSint.length>=1?1:0,proteinG:nv(el('ciProt').value,null)};
  var i=S.daily.findIndex(function(x){return x.date===d;});if(i>=0) S.daily[i]=entry;else S.daily.push(entry);
  ciSac=null;ciSint=[];el('ciAgua').value='';el('ciUrina').value='';var disp=el('aguaCoposDisplay');if(disp) disp.textContent='';
  resetProtFoods();
  el('ciS1').className='ci-card';el('ciS2').className='ci-card';el('ciQ1').className='ci-card';el('ciQ2').className='ci-card';el('ciActFome').className='ci-act';el('sintWrap').style.display='none';
  render();go('dashboard');toast('Check-in salvo! âœ…');
}

/* â•â• FASE â•â• */
function setFase(v){
  S.caneta.faseSac=v;
  el('foOk').className='fase-opt'+(v==='ok'?' ok':'');el('foComp').className='fase-opt'+(v==='comp'?' warn':'');el('foSem').className='fase-opt'+(v==='sem'?' danger':'');
  el('fbOk').className='fase-fb fb-ok'+(v==='ok'?' show':'');el('fbComp').className='fase-fb fb-warn'+(v==='comp'?' show':'');el('fbSem').className='fase-fb fb-danger'+(v==='sem'?' show':'');
  salvar();
}

/* â•â• FARMACOCINÃ‰TICA â•â• */
var chartPK=null;
var PK_PARAMS={
  Tirzepatida:{tmax:24,thalf:120,period:168,unit:'Semanal',
    desc:'Pico em ~24h Â· Meia-vida: 5 dias',
    zone:[35,100], // % acima = zona saciedade
    color:'#3b82f6',colorA:'rgba(59,130,246,'},
  Semaglutida:{tmax:24,thalf:168,period:168,unit:'Semanal',
    desc:'Pico em ~24h Â· Meia-vida: 7 dias',
    zone:[30,100],
    color:'#6366f1',colorA:'rgba(99,102,241,'},
  Liraglutida:{tmax:8,thalf:13,period:24,unit:'DiÃ¡ria',
    desc:'Pico em ~8h Â· Meia-vida: 13h',
    zone:[40,100],
    color:'#06b6d4',colorA:'rgba(6,182,212,'}
};

function pkLevel(t,p){
  var ke=Math.log(2)/p.thalf;
  var ka=Math.log(2)/1.5; // fast absorption
  if(Math.abs(ka-ke)<0.0001) return 0;
  var raw=(Math.exp(-ke*t)-Math.exp(-ka*t))/(ka-ke);
  return Math.max(0,raw);
}

function buildPKChart(){
  var farm=S.caneta.farmaco,ultima=S.caneta.ultima;
  var card=el('pkCard');
  if(!farm||!ultima||!PK_PARAMS[farm]){card.style.display='none';return;}
  card.style.display='block';
  var p=PK_PARAMS[farm],period=p.period;
  var step=farm==='Liraglutida'?1:4; // 1h for daily, 4h for weekly
  var pts=[],tArr=[];
  for(var t=0;t<=period;t+=step){pts.push(pkLevel(t,p));tArr.push(t);}
  var maxPK=Math.max.apply(null,pts);
  var pctArr=pts.map(function(v){return maxPK>0?(v/maxPK)*100:0;});

  // Time since last injection
  var lastDt=new Date(ultima+'T12:00:00');
  var now=new Date();
  var hoursEl=Math.max(0,(now.getTime()-lastDt.getTime())/(3600000));
  var curIdx=Math.round(Math.min(hoursEl,period)/step);
  var curPct=pctArr[curIdx]||0;
  var nextIdx=Math.round(period/step); // next dose at end

  // Labels
  var dias=['Dom','Seg','Ter','Qua','Qui','Sex','SÃ¡b'];
  var labels=tArr.map(function(t){
    if(farm==='Liraglutida') return t+'h';
    var d=new Date(lastDt.getTime()+t*3600000);
    return dias[d.getDay()]+(t%24===0?' '+(t===0?'Hoje':t===period?'PrÃ³x.':''):'');
  });

  // Zone band data
  var zoneLine=pctArr.map(function(v){return v>=p.zone[0]?v:null;});
  var zoneBase=pctArr.map(function(v){return v>=p.zone[0]?p.zone[0]:null;});

  // Current dot
  var curDots=new Array(pctArr.length).fill(null);
  curDots[curIdx]=curPct;

  // Next dose dot
  var nextDots=new Array(pctArr.length).fill(null);
  if(nextIdx<pctArr.length) nextDots[nextIdx]=pctArr[nextIdx];

  var ctx=el('chartPK');
  if(!ctx) return;
  var c=ctx.getContext('2d');
  var gradMain=c.createLinearGradient(0,0,0,220);
  gradMain.addColorStop(0,p.colorA+'0.35)');
  gradMain.addColorStop(1,p.colorA+'0.02)');
  var gradZone=c.createLinearGradient(0,0,0,220);
  gradZone.addColorStop(0,'rgba(34,197,94,0.25)');
  gradZone.addColorStop(1,'rgba(34,197,94,0.05)');

  var datasets=[
    {label:'NÃ­vel',data:pctArr,borderColor:p.color,backgroundColor:gradMain,fill:true,pointRadius:0,borderWidth:2.5,tension:0.45,order:2},
    {label:'Zona saciedade',data:zoneLine,borderColor:'rgba(34,197,94,0.6)',backgroundColor:gradZone,fill:'-1',pointRadius:0,borderWidth:1.5,tension:0.45,borderDash:[],order:3},
    {label:'Agora',data:curDots,borderColor:'#fff',backgroundColor:p.color,pointRadius:8,pointHoverRadius:10,borderWidth:3,fill:false,showLine:false,order:1},
    {label:'PrÃ³xima dose',data:nextDots,borderColor:'#f59e0b',backgroundColor:'#f59e0b',pointRadius:6,pointHoverRadius:8,borderWidth:2,fill:false,showLine:false,order:1,pointStyle:'triangle'}
  ];

  var opts={
    responsive:true,
    plugins:{
      legend:{display:false},
      tooltip:{
        callbacks:{
          label:function(ctx){
            if(ctx.dataset.label==='Agora') return 'NÃ­vel atual: '+Math.round(curPct)+'%';
            if(ctx.dataset.label==='PrÃ³xima dose') return 'PrÃ³xima dose';
            return '';
          }
        },
        backgroundColor:'rgba(10,30,20,.85)',titleColor:'#fff',bodyColor:'#86efac',borderColor:'rgba(74,222,128,.3)',borderWidth:1
      }
    },
    scales:{
      x:{ticks:{color:'rgba(255,255,255,.45)',font:{size:10},maxTicksLimit:8},grid:{color:'rgba(255,255,255,.05)'}},
      y:{min:0,max:100,ticks:{color:'rgba(255,255,255,.45)',font:{size:10},callback:function(v){return v+'%';},maxTicksLimit:5},grid:{color:'rgba(255,255,255,.05)'}}
    }
  };

  if(chartPK){chartPK.data.labels=labels;chartPK.data.datasets=datasets;chartPK.update();}
  else chartPK=new Chart(el('chartPK'),{type:'line',data:{labels:labels,datasets:datasets},options:opts});

  // KPIs
  var kpis=el('pkKpis');kpis.innerHTML='';
  var daysLeft=Math.max(0,(period-hoursEl)/24),daysLeftStr=daysLeft<1?'Hoje':daysLeft<2?'AmanhÃ£':Math.ceil(daysLeft)+'d';
  var phase=curPct>=80?{l:'Pico',c:'#4ade80'}:curPct>=p.zone[0]?{l:'Ativo',c:'#4ade80'}:curPct>=20?{l:'DeclÃ­nio',c:'#fbbf24'}:{l:'Trough',c:'#f87171'};
  var kData=[
    {l:'Fase atual',v:phase.l,h:Math.round(curPct)+'% do pico',c:phase.c},
    {l:'PrÃ³xima dose',v:daysLeftStr,h:ultima?'Ãšltima: '+ultima:'â€”'},
    {l:'Meia-vida',v:farm==='Liraglutida'?'13h':'~'+(farm==='Tirzepatida'?'5':'7')+'d',h:p.desc},
    {l:'FrequÃªncia',v:p.unit,h:farm==='Liraglutida'?'Mesmo horÃ¡rio todo dia':'Mesmo dia toda semana'}
  ];
  kData.forEach(function(k){
    var d=document.createElement('div');d.className='pk-kpi';
    d.innerHTML='<div class="pk-kl">'+k.l+'</div><div class="pk-kv" style="color:'+(k.c||'#fff')+'">'+k.v+'</div><div class="pk-kh">'+k.h+'</div>';
    kpis.appendChild(d);
  });

  // Alert
  var al=el('pkAlert');
  if(curPct<20&&hoursEl>period*0.7){al.textContent='âš ï¸ NÃ­vel prÃ³ximo ao trough â€” normal sentir mais fome agora. A prÃ³xima dose restaurarÃ¡ a saciedade.';al.classList.add('show');}
  else if(hoursEl>period){al.textContent='âš ï¸ Dose possivelmente atrasada. Atualize a data da Ãºltima aplicaÃ§Ã£o.';al.classList.add('show');}
  else al.classList.remove('show');
}

/* â•â• RENDER PROGRESSO HERO â•â• */
var MOTIS=[
  {min:0,  max:5,  t:'Cada dÃ©cimo conta.',                s:'O inÃ­cio Ã© sempre o mais difÃ­cil. VocÃª estÃ¡ aqui.'},
  {min:5,  max:15, t:'A mudanÃ§a jÃ¡ Ã© real.',               s:'Seus Ã³rgÃ£os jÃ¡ sentem a diferenÃ§a. Continue.'},
  {min:15, max:30, t:'VocÃª provou consistÃªncia.',          s:'15% concluÃ­do. Isso nÃ£o foi sorte â€” foi trabalho.'},
  {min:30, max:50, t:'Na metade do caminho.',              s:'O que vocÃª fez atÃ© aqui jÃ¡ tem impacto clÃ­nico real.'},
  {min:50, max:70, t:'Mais de 50% concluÃ­do.',             s:'Essa conquista Ã© permanente. Cada kg protege sua saÃºde.'},
  {min:70, max:90, t:'A meta estÃ¡ perto.',                 s:'VocÃª chegou longe de verdade. NÃ£o para agora.'},
  {min:90, max:101,t:'Chegando na meta!',                  s:'Fase de manutenÃ§Ã£o comeÃ§a aqui. Igualmente importante.'}
];

function renderProgresso(cw,sw,rl,dh,ma){
  if(!cw){
    el('progWeight').textContent='â€” kg';el('progDelta').textContent='';el('progMoti').textContent='Configure seu perfil para ver o progresso.';
    el('progRingPct').textContent='â€”';el('progNoGoal').style.display='none';el('progProj').style.display='none';
    el('pkPerd').textContent='â€”';el('pkFaltam').textContent='â€”';el('pkRitmo').textContent='â€”';
    el('pdStart').textContent='â€”';el('pdNow').textContent='â€”';el('pdGoal').textContent='â€”';
    el('progRingFill').style.strokeDashoffset='239';
    return;
  }
  var gw=S.profile.weightGoalKg;
  var perd=sw&&cw&&sw>cw?sw-cw:null;
  var total=sw&&gw?sw-gw:null;
  var pct=total&&perd?Math.min(100,Math.round((perd/total)*100)):null;

  // Peso atual
  el('progWeight').textContent=rd(cw,1)+' kg';

  // Delta
  if(perd&&perd>0) el('progDelta').innerHTML='<span style="color:#4ade80">âˆ’'+rd(perd,1)+' kg perdidos â–¼</span>';
  else if(perd&&perd<0) el('progDelta').innerHTML='<span style="color:#f87171">+'+rd(Math.abs(perd),1)+' kg â–²</span>';
  else el('progDelta').textContent='';

  // MotivaÃ§Ã£o
  var moti=MOTIS[0];
  if(pct!==null) MOTIS.forEach(function(m){if(pct>=m.min&&pct<m.max) moti=m;});
  el('progMoti').textContent=moti.s;
  el('progTag').textContent=moti.t;

  // Anel SVG
  var circumference=239;
  if(pct!==null){
    var offset=circumference-(pct/100)*circumference;
    el('progRingPct').textContent=pct+'%';
    setTimeout(function(){el('progRingFill').style.strokeDashoffset=offset;},50);
  }else{
    el('progRingPct').textContent=perd?'â€”':'0%';
    el('progRingFill').style.strokeDashoffset=circumference;
  }

  // Urina tag
  var ut=el('progUrineTag');ut.innerHTML='';
  if(dh&&dh.urine){
    var umap={Clara:{cls:'tg',txt:'ğŸ’§ Bem hidratado'},Media:{cls:'tw',txt:'âš ï¸ Beba mais Ã¡gua'},Escura:{cls:'tr',txt:'ğŸ”´ Desidratado'}};
    var um=umap[dh.urine];if(um) ut.innerHTML='<span class="prog-urine" style="'+(dh.urine==='Clara'?'border-color:rgba(74,222,128,.3);color:#4ade80':dh.urine==='Media'?'border-color:rgba(251,191,36,.3);color:#fbbf24':'border-color:rgba(248,113,113,.3);color:#f87171')+'">'+um.txt+'</span>';
  }

  // Barra de jornada
  el('pdStart').textContent=sw?rd(sw,1)+' kg':'â€”';
  el('pdNow').textContent=rd(cw,1)+' kg';
  el('pdGoal').textContent=gw?rd(gw,1)+' kg':'?';
  var roadPct=pct!==null?pct:sw&&cw?Math.min(100,Math.max(0,Math.round(((sw-cw)/(sw*(gw?1:0.15)))*100))):0;
  setTimeout(function(){el('progRoadFill').style.width=roadPct+'%';},80);

  // Marco intermediÃ¡rio (50%)
  if(total&&sw){
    var mid=sw-total*0.5;
    el('midMarkerWrap').style.display='flex';
    el('midMarkerDot').className='prog-dot'+(cw<=mid?' current':'');
    el('midMarkerLbl').textContent='50%';
    el('midMarkerVal').textContent=rd(mid,1)+' kg';
  }else el('midMarkerWrap').style.display='none';

  // KPIs
  el('pkPerd').textContent=perd&&perd>0?'âˆ’'+rd(perd,1)+' kg':'â€”';
  el('pkFaltam').textContent=gw&&cw?rd(Math.max(0,cw-gw),1)+' kg':'â€”';
  var maArr=ma||calcMA7();var rl2=rl!==null?rl:perdaSemana(maArr);
  el('pkRitmo').textContent=rl2!==null?rd(rl2,2)+' kg/sem':'â€”';

  // ProjeÃ§Ã£o para meta
  if(gw&&cw&&rl2&&rl2>0){
    var semanas=Math.ceil((cw-gw)/rl2);
    var dataProj=new Date();dataProj.setDate(dataProj.getDate()+semanas*7);
    var meses=['jan','fev','mar','abr','mai','jun','jul','ago','set','out','nov','dez'];
    el('progProj').style.display='block';
    el('progProj').textContent='ğŸ¯ Na tendÃªncia atual, vocÃª chega Ã  meta em ~'+semanas+' semanas ('+meses[dataProj.getMonth()]+'/'+dataProj.getFullYear()+')';
  }else el('progProj').style.display='none';

  // Sem meta
  el('progNoGoal').style.display=gw?'none':'block';
  el('progJourneyWrap').style.opacity=gw?'1':'0.4';
  el('progKpis').style.opacity=gw?'1':'0.7';
}

/* â•â• RENDER PRINCIPAL â•â• */
var chartM=null,chartC=null,chartSemanal=null;
function render(){
  S.weights.sort(porData);
  var ma=calcMA7(),M=calcMetrics(),ma_lbl=S.weights.map(function(x){return x.date;}),dw=S.weights.map(function(x){return x.weight;});
  var maMap={};ma.forEach(function(x){maMap[x.date]=x.avg;});
  var dm=ma_lbl.map(function(d){return maMap[d]||null;});
  var rl=perdaSemana(ma),rh=M?classificar(rl,M.perda):null;
  var sw=S.profile.weightStartKg,cw=M?M.w:null,lma=ma.length?ma[ma.length-1].avg:null;
  var perd=sw&&cw&&sw>cw?sw-cw:null,dh=getDH(),pd=proxDose();
  var streak=calcStreak();
  el('streakEl').style.display=streak>=2?'flex':'none';if(streak>=2) el('streakNum').textContent=streak;
  renderConquistas(perd);
  renderProxDose();
  renderCanaetaPainel();
  renderGuiaRapido();
  var ms=checkMS(perd);el('msEl').style.display=(ms&&perd>0)?'flex':'none';if(ms&&perd>0){el('msIc').textContent=ms.ic;el('msMsg').textContent=ms.msg;el('msSub').textContent=ms.sub;}
  var nr=buildNarr(M,rl,perd,dh,pd);var _nt=el('narrTag');if(_nt){_nt.textContent=nr.tag;el('narrMsg').textContent=nr.msg;el('narrDet').textContent=nr.det;el('narrBtn').style.display=nr.btn?'inline-flex':'none';}
  var _sb=el('stBar');if(_sb){if(rh){_sb.style.display='flex';_sb.className='sbar '+rh.bar;el('stLbl').textContent=rh.lbl;el('stMsg').textContent=rh.msg;el('stTag').className='tag '+rh.cls;el('stTag').textContent=rh.lbl;}else _sb.style.display='none';}
  var ld=S.daily.slice().sort(porData),lastD=ld.length?ld[ld.length-1]:null;
  el('alSint').style.display=(lastD&&(lastD.intensity||0)>=2)?'block':'none';
  el('alAgua').style.display=(!dh||!dh.waterMl)&&new Date().getHours()>=9?'block':'none';
  var al=el('alDose');
  if(pd&&pd.diff===0){al.textContent='ğŸ’‰ Hoje Ã© dia da sua dose de '+S.caneta.farmaco+'. NÃ£o esqueÃ§a!';al.style.display='block';al.className='alert alert-g';}
  else if(pd&&pd.diff===1){al.textContent='ğŸ’‰ AmanhÃ£ Ã© dia da sua dose de '+S.caneta.farmaco+'.';al.style.display='block';al.className='alert alert-g';}
  else if(S.caneta.ultima){
    var diasDesde=Math.round((Date.now()-new Date(S.caneta.ultima+'T12:00:00').getTime())/(24*3600*1000));
    if(diasDesde>=0&&diasDesde<=2){al.textContent='ğŸ’§ PÃ³s-dose: hidrataÃ§Ã£o extra importante! GLP-1 pode causar nÃ¡usea quando desidratado. Beba pelo menos '+Math.round((M?M.agua:2500)/1000*1.2)+' litros hoje.';al.style.display='block';al.className='alert alert-w';}
    else al.style.display='none';
  } else al.style.display='none';

  // PROGRESSO HERO
  renderProgresso(cw,sw,rl,dh,ma);

  if(M){
    el('kTMB').textContent=Math.round(M.tmb);el('kGET').textContent=Math.round(M.tdee);el('kMeta').textContent=Math.round(M.meta);el('kDefH').textContent='dÃ©ficit ~'+Math.round(M.def)+' kcal/dia';el('kPEst').textContent=rd(M.perda,2)+' kg';
    el('kPMin').textContent=Math.round(M.pm)+'g';el('kPIdeal').textContent=Math.round(M.pi1)+'â€“'+Math.round(M.pi2)+'g';el('kAgua').textContent=Math.round(M.agua);
    var _wml=dh&&dh.waterMl?dh.waterMl:0;var _copos=Math.round(_wml/250);
    el('kAguaH').textContent=_wml?_copos+' copo'+(_copos!==1?'s':''):'â€”';
    el('kAguaHH').textContent=_wml?_wml+' ml':'Registre no check-in';
    if(dh&&dh.waterMl){var ap2=Math.min(100,Math.round((dh.waterMl/M.agua)*100));el('aguaBarWrap').style.display='block';el('aguaPct').textContent=ap2+'%';el('aguaFill').style.width=ap2+'%';el('aguaFill').className='pbar-fill'+(ap2<50?' danger':ap2<80?' warn':'');}
    else el('aguaBarWrap').style.display='none';
    el('peqEl').innerHTML='<b>EquivalÃªncia proteica:</b><br>'+proteqiv(Math.round(M.pm));
    el('efTMB').innerHTML='Seu perfil â†’ <strong>TMB: '+Math.round(M.tmb)+' kcal/dia</strong>';el('efMeta').innerHTML='GET: '+Math.round(M.tdee)+' â†’ Meta: <strong>'+Math.round(M.meta)+' kcal/dia</strong>';el('efProt').innerHTML='Peso: '+rd(cw||0,1)+'kg â†’ MÃ­n: <strong>'+Math.round(M.pm)+'g</strong> | Ideal: <strong>'+Math.round(M.pi1)+'â€“'+Math.round(M.pi2)+'g</strong>';
    var diet=buildDiet(M);
    if(diet){el('dietCard').style.display='block';el('dietSub').textContent='Meta: ~'+Math.round(M.meta)+' kcal, ~'+Math.round(M.pm)+'g proteÃ­na.';var dm2=el('dietMeals');dm2.innerHTML='';diet.forEach(function(meal){var d=document.createElement('div');d.className='diet-meal';d.innerHTML='<div class="diet-time">'+meal.t+'</div><div><div class="diet-desc">'+meal.d+'</div><div class="diet-prot">'+meal.p+'</div></div>';dm2.appendChild(d);});}
    else el('dietCard').style.display='none';
  }else{['kTMB','kGET','kMeta','kPEst','kPMin','kPIdeal','kAgua','kAguaH'].forEach(function(id){el(id).textContent='â€”';});el('kDefH').textContent='â€”';el('kAguaHH').textContent='Configure seu perfil';el('aguaBarWrap').style.display='none';el('peqEl').textContent='Configure seu perfil.';el('dietCard').style.display='none';}
  if(S.caneta.farmaco){
    el('proxCard').style.display='block';
    buildPKChart();el('dFarm').textContent=S.caneta.farmaco;el('dDose').textContent=S.caneta.dose||'â€”';var sem2=calcSemanas();el('dSem').textContent=sem2!==null?'Semana '+sem2:'â€”';
    if(pd){var pv=pd.diff<=0?'Hoje! ğŸ’‰':pd.diff===1?'AmanhÃ£':'Em '+pd.diff+' dia'+(pd.diff>1?'s':'')+' ('+dataBR(pd.date)+')';el('proxVal').textContent=pv;el('proxTag').className=pd.diff<=0?'tag tr':pd.diff<=2?'tag tw':'tag tg';el('proxTag').textContent=pd.diff<=0?'Hoje':pd.diff<=2?'Em breve':'Aguardando';}
    el('chDrug').textContent=S.caneta.farmaco;el('chDose').textContent=S.caneta.dose?'Dose atual: '+S.caneta.dose:'Dose nÃ£o configurada';
    var crow=el('chRow');crow.innerHTML='';
    [{l:'FrequÃªncia',v:S.caneta.freq==='semanal'?'Semanal':'DiÃ¡ria'},{l:'Ãšltima aplicaÃ§Ã£o',v:S.caneta.ultima||'â€”'},{l:'PrÃ³xima',v:pd?pd.diff<=0?'Hoje':dataBR(pd.date):'â€”'}].forEach(function(k){var d=document.createElement('div');d.className='ch-kpi';d.innerHTML='<div class="ch-kl">'+k.l+'</div><div class="ch-kv">'+k.v+'</div>';crow.appendChild(d);});
    var doses2=DOSES[S.caneta.farmaco];
    if(doses2){el('escCard').style.display='block';el('escSub').textContent='Protocolo para '+S.caneta.farmaco+'.';var tl=el('escTL');tl.innerHTML='';doses2.forEach(function(d){var act=S.caneta.dose&&d.dose===S.caneta.dose;var step=document.createElement('div');step.className='tl-step'+(act?' active':'');step.innerHTML='<div class="tl-dose">'+d.dose+' <span style="font-size:11px;color:var(--muted);font-weight:400">â€” '+d.sem+'</span>'+(act?' <span class="tag tg" style="font-size:10px;padding:2px 7px">VocÃª estÃ¡ aqui</span>':'')+'</div><div class="tl-info">'+d.info+'</div>';tl.appendChild(step);});}else el('escCard').style.display='none';
    if(ESQ[S.caneta.farmaco]){el('esqCard').style.display='block';el('esqTxt').innerHTML=ESQ[S.caneta.farmaco];}else el('esqCard').style.display='none';
    if(S.caneta.faseSac) setFase(S.caneta.faseSac);
  }else el('proxCard').style.display='none';
  var maMapR={};ma.forEach(function(x){maMapR[x.date]=x.avg;});
  renderChartSemanal();
  var tp=el('tPesos');tp.innerHTML='';S.weights.slice().sort(porData).reverse().forEach(function(w){var tr=document.createElement('tr');tr.innerHTML='<td>'+w.date+'</td><td class="r">'+rd(w.weight,1)+'</td><td class="r">'+(maMapR[w.date]?rd(maMapR[w.date],1):'â€”')+'</td>';tp.appendChild(tr);});
  var td=el('tDias');td.innerHTML='';S.daily.slice().sort(porData).reverse().forEach(function(d){var tr=document.createElement('tr');var sl=d.saciedade==='saciado'?'ğŸ˜Œ Saciado':d.saciedade==='fome'?'ğŸ˜®â€ğŸ’¨ Fome':'â€”';tr.innerHTML='<td>'+d.date+'</td><td>'+sl+'</td><td class="r">'+(d.waterMl||'')+'</td><td>'+(d.urine||'')+'</td><td>'+(d.symptom||'')+'</td><td class="r">'+(d.proteinG||'')+'</td>';td.appendChild(tr);});
  el('sexo').value=S.profile.sex||'M';el('idade').value=S.profile.age||'';el('altura').value=S.profile.heightCm||'';el('peso').value=S.profile.weightKg||'';el('pesoI').value=S.profile.weightStartKg||'';el('pesoMeta').value=S.profile.weightGoalKg||'';el('ativ').value=S.profile.activityLevel||'Moderada';el('dtIni').value=S.profile.startDate||hoje();
  if(S.caneta.farmaco){
    el('cFarm').value=S.caneta.farmaco;
    updateDoses();
    if(S.caneta.dose) el('cDose').value=String(S.caneta.dose);
    el('cFreq').value=S.caneta.freq||'semanal';
    el('cIni').value=S.caneta.inicio||'';
    el('cUlt').value=S.caneta.ultima||'';
    el('cDia').value=String(S.caneta.diaSem||1);
    el('cObs').value=S.caneta.obs||'';
  }
  // TENDÃŠNCIA SEMANAL â€” substitui o grÃ¡fico

  buildProtChips();
  calcProtTotal();
  // Placar de proteÃ­na no hero
  if(M){
    var protHoje=dh&&dh.proteinG?dh.proteinG:0;
    var protMeta=Math.round(M.pm);
    var protPct=Math.min(100,Math.round((protHoje/protMeta)*100));
    el('protPlacarWrap').style.display='block';
    el('protPlacarVal').textContent=protHoje+'g';
    el('protPlacarMeta').textContent='/ '+protMeta+'g';
    el('protPlacarPct').textContent=protPct+'%';
    el('protPlacarBar').style.width=protPct+'%';
    el('protPlacarBar').style.background=protPct>=80?'linear-gradient(90deg,var(--g500),var(--g400))':protPct>=40?'linear-gradient(90deg,var(--warn),#fbbf24)':'linear-gradient(90deg,var(--red),#f87171)';
    el('protPlacarPct').style.color=protPct>=80?'var(--g400)':protPct>=40?'var(--warn)':'#f87171';
    var msgs=['Registre sua proteÃ­na no check-in','Bom comeÃ§o! Continue caprichando ğŸ’ª','Ã“timo! Quase na meta ğŸ¯','Meta batida! MÃºsculos protegidos âœ…'];
    var mi=protPct>=100?3:protPct>=70?2:protPct>=30?1:0;
    el('protPlacarMsg').textContent=msgs[mi];
  } else {
    el('protPlacarWrap').style.display='none';
  }
  var co2={responsive:true,plugins:{legend:{display:false}},scales:{x:{ticks:{color:'#6b8f77',font:{size:10}},grid:{color:'rgba(15,26,19,.05)'}},y:{ticks:{color:'#6b8f77',font:{size:10}},grid:{color:'rgba(15,26,19,.05)'}}}};
  var ds2=[{label:'Peso',data:dw,borderColor:'#16a34a',backgroundColor:'rgba(22,163,74,.07)',pointRadius:3,pointBackgroundColor:'#16a34a',borderWidth:2,tension:0.3},{label:'MÃ©dia 7d',data:dm,borderColor:'#2563eb',backgroundColor:'transparent',pointRadius:0,borderWidth:2,tension:0.4,spanGaps:true}];
  if(chartC){chartC.data.labels=ma_lbl;chartC.data.datasets[0].data=dw;chartC.data.datasets[1].data=dm;chartC.update();}
  else chartC=new Chart(el('chartCaneta'),{type:'line',data:{labels:ma_lbl,datasets:ds2},options:co2});
  salvar();
}

/* â•â• GUIA RÃPIDO â•â• */
function renderGuiaRapido(){
  var wrap=el('guiaRapidoWrap');if(!wrap) return;
  if(!S.profile.age){wrap.style.display='none';return;}
  wrap.style.display='block';

  var M=calcMetrics();
  var pd=proxDose();
  var hoje_date=hoje();
  var dh=S.daily.find(function(d){return d.date===hoje_date;})||{};
  var farm=S.caneta.farmaco||'';

  var itens=[];

  // Dose â€” sÃ³ aparece se for dia de dose
  if(pd){
    if(pd.diff===0){
      itens.push({ic:'ğŸ’‰',txt:'<strong>Hoje Ã© dia da dose!</strong> Aplique '+farm+(S.caneta.dose?' '+S.caneta.dose+' mg':'')+' e registre na aba Caneta.',cor:'rgba(239,68,68,.15)',brd:'rgba(239,68,68,.3)'});
    } else if(pd.diff===1){
      itens.push({ic:'â°',txt:'AmanhÃ£ Ã© dia da dose de '+farm+'. Verifique se a caneta estÃ¡ pronta.',cor:'rgba(251,191,36,.1)',brd:'rgba(251,191,36,.3)'});
    }
  }

  // HidrataÃ§Ã£o
  var aguaHoje=dh.waterMl||0;
  var aguaMeta=M?Math.round(M.agua):2000;
  var aguaPct=Math.min(100,Math.round((aguaHoje/aguaMeta)*100));
  var aguaFalta=Math.max(0,aguaMeta-aguaHoje);
  var aguaCopos=Math.round(aguaFalta/250);
  itens.push({
    ic:'ğŸ’§',
    txt:'HidrataÃ§Ã£o: <strong>'+aguaHoje+'ml</strong> de <strong>'+aguaMeta+'ml</strong> ('+aguaPct+'%)'+(aguaFalta>0?' â€” faltam <strong>'+aguaFalta+'ml</strong> ('+aguaCopos+' copos)':' âœ… Meta batida!'),
    cor:aguaPct>=100?'rgba(34,197,94,.1)':'rgba(59,130,246,.08)',
    brd:aguaPct>=100?'rgba(34,197,94,.3)':'rgba(59,130,246,.2)'
  });

  // ProteÃ­na
  var protHoje=dh.proteinG||0;
  var protMeta=M?Math.round(M.pm):120;
  var protPct=Math.min(100,Math.round((protHoje/protMeta)*100));
  var protFalta=Math.max(0,protMeta-protHoje);
  var protFaltaAlimento=Math.round(protFalta/0.26);
  itens.push({
    ic:'ğŸ¥©',
    txt:'ProteÃ­na: <strong>'+protHoje+'g</strong> de <strong>'+protMeta+'g</strong> ('+protPct+'%)'+(protFalta>0?' â€” faltam <strong>'+protFalta+'g</strong> â‰ˆ '+protFaltaAlimento+'g de carne':' âœ… Meta batida!'),
    cor:protPct>=100?'rgba(34,197,94,.1)':'rgba(251,191,36,.08)',
    brd:protPct>=100?'rgba(34,197,94,.3)':'rgba(251,191,36,.2)'
  });

  var hojeDiv=el('guiaHojeItems');hojeDiv.innerHTML='';
  itens.forEach(function(it){
    var d=document.createElement('div');
    d.style.cssText='display:flex;align-items:flex-start;gap:10px;padding:10px 12px;border-radius:10px;background:'+it.cor+';border:1px solid '+(it.brd||'transparent');
    d.innerHTML='<span style="font-size:16px;flex-shrink:0;margin-top:1px">'+it.ic+'</span>'
      +'<span style="font-size:12px;line-height:1.6;color:rgba(255,255,255,.9)">'+it.txt+'</span>';
    hojeDiv.appendChild(d);
  });

  // BotÃ£o check-in: aparece sempre
  var btn=el('guiaCheckinBtn');
  if(btn) btn.style.display='block';
}
/* â•â• PRÃ“XIMA DOSE â•â• */
function renderProxDose(){
  var card=el('proxDoseCard');
  if(!card) return;
  var f=S.caneta.farmaco;
  var ultima=S.caneta.ultima;
  if(!f||!ultima){card.style.display='none';return;}
  var freq=S.caneta.freq||'semanal';
  var diasCiclo=freq==='diaria'?1:7;
  var dtUlt=new Date(ultima+'T12:00:00');
  var dtProx=new Date(dtUlt.getTime()+diasCiclo*24*3600*1000);
  var agora=new Date();
  var diffMs=dtProx.getTime()-agora.getTime();
  var diffH=Math.round(diffMs/3600000);
  var diffD=Math.ceil(diffMs/(24*3600*1000));
  var inner=el('proxDoseInner');
  var tag=el('proxDoseTag');
  var ttl=el('proxDoseTtl');
  var sub=el('proxDoseSub');
  var ic=el('proxDoseIc');
  card.style.display='block';
  if(diffMs<0){
    // Atrasada
    var atrasH=Math.abs(Math.round(diffMs/3600000));
    var atrasD=Math.floor(atrasH/24);
    inner.style.cssText='cursor:pointer;border-radius:var(--rlg);padding:16px 18px;display:flex;align-items:center;gap:14px;background:var(--red-bg);border:1.5px solid var(--red-brd)';
    ic.textContent='ğŸš¨';
    tag.style.color='var(--red)';tag.textContent='APLICAÃ‡ÃƒO ATRASADA';
    ttl.style.color='var(--ink)';ttl.textContent=atrasD>0?atrasD+' dia'+(atrasD>1?'s':'')+ ' de atraso':atrasH+'h de atraso';
    sub.style.color='var(--red)';sub.textContent='Aplique '+f+' agora e registre na aba Caneta';
  } else if(diffH<=24){
    // Hoje ou amanhÃ£ cedo
    inner.style.cssText='cursor:pointer;border-radius:var(--rlg);padding:16px 18px;display:flex;align-items:center;gap:14px;background:var(--warn-bg);border:1.5px solid var(--warn-brd)';
    ic.textContent='â°';
    tag.style.color='var(--warn)';tag.textContent=diffH<=4?'DOSE HOJE â€” AGORA':'DOSE HOJE';
    ttl.style.color='var(--ink)';ttl.textContent='Aplicar '+f+(S.caneta.dose?' '+S.caneta.dose+' mg':'');
    sub.style.color='var(--warn)';sub.textContent='Previsto para hoje Â· '+dtProx.toLocaleDateString('pt-BR');
  } else if(diffD<=2){
    // AmanhÃ£
    inner.style.cssText='cursor:pointer;border-radius:var(--rlg);padding:16px 18px;display:flex;align-items:center;gap:14px;background:var(--blue-bg);border:1.5px solid var(--blue-brd)';
    ic.textContent='ğŸ’‰';
    tag.style.color='var(--blue)';tag.textContent='PRÃ“XIMA DOSE â€” AMANHÃƒ';
    ttl.style.color='var(--ink)';ttl.textContent=f+(S.caneta.dose?' '+S.caneta.dose+' mg':'');
    sub.style.color='var(--blue)';sub.textContent=dtProx.toLocaleDateString('pt-BR',{weekday:'long',day:'numeric',month:'long'});
  } else {
    // Dias normais
    inner.style.cssText='cursor:pointer;border-radius:var(--rlg);padding:16px 18px;display:flex;align-items:center;gap:14px;background:var(--g50);border:1px solid var(--g200)';
    ic.textContent='ğŸ’‰';
    tag.style.color='var(--g600)';tag.textContent='PRÃ“XIMA DOSE â€” EM '+diffD+' DIAS';
    ttl.style.color='var(--ink)';ttl.textContent=f+(S.caneta.dose?' '+S.caneta.dose+' mg':'');
    sub.style.color='var(--muted)';sub.textContent=dtProx.toLocaleDateString('pt-BR',{weekday:'long',day:'numeric',month:'long'});
  }
}

/* â•â• CANETA NO PAINEL â•â• */
function renderCanaetaPainel(){
  var wrap=el('canaetaPainelWrap');if(!wrap) return;
  var f=S.caneta.farmaco;
  var dose=S.caneta.dose;
  var ultima=S.caneta.ultima;
  if(!f){wrap.style.display='none';return;}
  wrap.style.display='block';
  el('caPainelFarm').textContent=f;
  el('caPainelDose').textContent=dose?'Dose atual: '+dose+' mg'+(S.caneta.freq==='diaria'?' Â· DiÃ¡rio':' Â· Semanal'):'Dose nÃ£o configurada';
  if(!ultima){
    el('caPainelProxTag').textContent='';
    el('caPainelProxVal').textContent='Registre a Ãºltima dose';
    el('caPainelBar').style.width='0%';
    el('caPainelCiclo').textContent='';
    return;
  }
  var freq=S.caneta.freq||'semanal';
  var diasCiclo=freq==='diaria'?1:7;
  var dtUlt=new Date(ultima+'T12:00:00');
  var dtProx=new Date(dtUlt.getTime()+diasCiclo*24*3600*1000);
  var agora=new Date();
  var diffMs=dtProx.getTime()-agora.getTime();
  var diffD=Math.ceil(diffMs/(24*3600*1000));
  var passadoMs=agora.getTime()-dtUlt.getTime();
  var pct=Math.min(100,Math.round((passadoMs/(diasCiclo*24*3600*1000))*100));
  el('caPainelBar').style.width=pct+'%';
  el('caPainelBar').style.background=pct>85?'linear-gradient(90deg,#f59e0b,#ef4444)':pct>60?'linear-gradient(90deg,#f59e0b,#fbbf24)':'linear-gradient(90deg,var(--g500),var(--g400))';
  if(diffMs<0){
    el('caPainelProxTag').style.color='#ef4444';el('caPainelProxTag').textContent='DOSE ATRASADA';
    el('caPainelProxVal').style.color='#ef4444';el('caPainelProxVal').textContent='Aplicar agora';
    el('caPainelCiclo').textContent='Registre a aplicaÃ§Ã£o na aba Caneta';
  } else if(diffD===0){
    el('caPainelProxTag').style.color='#f59e0b';el('caPainelProxTag').textContent='DOSE HOJE';
    el('caPainelProxVal').style.color='#f59e0b';el('caPainelProxVal').textContent='Aplicar hoje';
    el('caPainelCiclo').textContent=dtProx.toLocaleDateString('pt-BR',{weekday:'long'});
  } else {
    el('caPainelProxTag').style.color='rgba(255,255,255,.5)';el('caPainelProxTag').textContent='PRÃ“XIMA DOSE';
    el('caPainelProxVal').style.color='var(--g400)';var diasSemana=['Dom','Seg','Ter','Qua','Qui','Sex','SÃ¡b'];el('caPainelProxVal').textContent='em '+diffD+' dia'+(diffD>1?'s':'')+' â€” '+diasSemana[dtProx.getDay()];
    el('caPainelCiclo').textContent=dtProx.toLocaleDateString('pt-BR',{weekday:'long',day:'numeric',month:'short'});
  }
}

/* â•â• RESUMO MÃ‰DICO â•â• */
function abrirResumo(){
  var ov=el('resumoOv');if(!ov) return;
  // Dados bÃ¡sicos
  var nome=S.profile.nome||'Paciente';
  var sex=S.profile.sex==='M'?'Masc.':'Fem.';
  var idade=S.profile.age?S.profile.age+' anos':'â€”';
  var altura=S.profile.heightCm?S.profile.heightCm+' cm':'â€”';
  var cw=ultimoPeso()||S.profile.weightKg;
  var sw=S.profile.weightStartKg;
  var meta=S.profile.weightGoalKg;
  var perd=sw&&cw&&sw>cw?rd(sw-cw,1):null;
  var sem=calcSemanas();
  var pd=proxDose();

  el('resumoNome').textContent=nome;
  el('resumoInfo').textContent=sex+' Â· '+idade+' Â· '+altura;
  el('resumoPeso').textContent=cw?rd(cw,1)+' kg':'â€”';
  el('resumoPerda').textContent=perd?perd+' kg':'â€”';
  el('resumoMeta').textContent=meta?meta+' kg':'â€”';
  el('resumoSemanas').textContent=sem!==null?sem+'Âª':'â€”';

  // Medicamento
  var medHtml='';
  if(S.caneta.farmaco){
    medHtml+='<b>FÃ¡rmaco:</b> '+S.caneta.farmaco+'<br>';
    medHtml+='<b>Dose atual:</b> '+(S.caneta.dose||'â€”')+' mg<br>';
    medHtml+='<b>FrequÃªncia:</b> '+(S.caneta.freq==='semanal'?'Semanal':'DiÃ¡ria')+'<br>';
    medHtml+='<b>InÃ­cio:</b> '+(S.caneta.inicio?dataBR(S.caneta.inicio):'â€”')+'<br>';
    medHtml+='<b>Ãšltima dose:</b> '+(S.caneta.ultima?dataBR(S.caneta.ultima):'â€”')+'<br>';
    if(pd) medHtml+='<b>PrÃ³xima dose:</b> '+dataBR(pd.date)+'<br>';
  } else {
    medHtml='Medicamento nÃ£o configurado.';
  }
  el('resumoMed').innerHTML=medHtml;

  // EvoluÃ§Ã£o peso â€” Ãºltimas 8 pesagens
  var pesos=S.weights.slice().sort(porData);
  var pesosHtml='';
  if(pesos.length===0){
    pesosHtml='Nenhuma pesagem registrada.';
  } else {
    var ultimos=pesos.slice(-8);
    ultimos.forEach(function(w,i){
      var prev=i>0?ultimos[i-1]:null;
      var delta=prev?rd(w.weight-prev.weight,1):null;
      var seta=delta?( parseFloat(delta)<0?'â†“':'â†‘'):'';
      var cor=delta?(parseFloat(delta)<0?'#16a34a':'#ef4444'):'#6b7280';
      pesosHtml+='<span style="color:#6b7280">'+dataBR(w.date)+'</span>  '
        +'<b>'+rd(w.weight,1)+' kg</b>'
        +(delta?' <span style="color:'+cor+';font-size:12px">'+seta+' '+Math.abs(delta)+' kg</span>':'')
        +'<br>';
    });
    if(sw) pesosHtml='<span style="color:#6b7280">Peso inicial do tratamento: </span><b>'+sw+' kg</b><br><br>'+pesosHtml;
  }
  el('resumoPesos').innerHTML=pesosHtml;

  // HÃ¡bitos Ãºltimos 7 dias
  var seteDias=[];
  for(var i=6;i>=0;i--){
    var d=new Date();d.setDate(d.getDate()-i);
    var iso=d.toISOString().slice(0,10);
    var reg=S.daily.find(function(x){return x.date===iso;});
    if(reg) seteDias.push(reg);
  }
  var habitosHtml='';
  if(seteDias.length===0){
    habitosHtml='Nenhum check-in registrado nos Ãºltimos 7 dias.';
  } else {
    var mediaAgua=Math.round(seteDias.reduce(function(s,d){return s+(d.waterMl||0);},0)/seteDias.length);
    var mediaProt=Math.round(seteDias.reduce(function(s,d){return s+(d.proteinG||0);},0)/seteDias.length);
    var checkins=seteDias.length;
    var M=calcMetrics();
    habitosHtml='<b>Check-ins:</b> '+checkins+'/7 dias<br>';
    habitosHtml+='<b>MÃ©dia hÃ­drica:</b> '+mediaAgua+' ml/dia'+(M?' (meta: '+Math.round(M.agua)+' ml)':'')+'<br>';
    habitosHtml+='<b>MÃ©dia proteÃ­na:</b> '+mediaProt+' g/dia'+(M?' (meta: '+Math.round(M.pm)+' g)':'')+'<br>';
  }
  el('resumoHabitos').innerHTML=habitosHtml;

  // Sintomas
  var sintHtml='';
  var comSint=S.daily.filter(function(d){return d.symptom&&d.symptom.length>0;});
  if(comSint.length===0){
    sintHtml='Nenhum sintoma registrado.';
  } else {
    var ultSint=comSint.slice().sort(porData).slice(-5);
    ultSint.forEach(function(d){
      sintHtml+='<span style="color:#6b7280">'+dataBR(d.date)+':</span> '+d.symptom+'<br>';
    });
  }
  el('resumoSintomas').innerHTML=sintHtml;

  // Data do relatÃ³rio
  var agora=new Date();
  el('resumoData').textContent='RelatÃ³rio gerado em '+agora.toLocaleDateString('pt-BR',{weekday:'long',day:'numeric',month:'long',year:'numeric'})+' Ã s '+agora.toLocaleTimeString('pt-BR',{hour:'2-digit',minute:'2-digit'})+' Â· Equilibra 5.0';

  ov.style.display='block';
  document.body.style.overflow='hidden';
}

function fecharResumo(){
  el('resumoOv').style.display='none';
  document.body.style.overflow='';
}

function compartilharResumo(){
  var nome=S.profile.nome||'Paciente';
  var cw=ultimoPeso()||S.profile.weightKg;
  var sw=S.profile.weightStartKg;
  var perd=sw&&cw&&sw>cw?rd(sw-cw,1):null;
  var sem=calcSemanas();
  var nl='\n';var txt='*RelatÃ³rio Equilibra* â€” '+nome+nl+nl;txt+='Peso atual: '+(cw?rd(cw,1)+' kg':'â€”')+nl;txt+='Perdido: '+(perd?perd+' kg':'â€”')+nl;txt+='Meta: '+(S.profile.weightGoalKg?S.profile.weightGoalKg+' kg':'â€”')+nl;txt+=S.caneta.farmaco+' '+(S.caneta.dose||'')+'mg â€” Semana '+(sem||'â€”')+nl+nl;txt+='Gerado pelo Equilibra 5.0';
  if(navigator.share){
    navigator.share({title:'RelatÃ³rio Equilibra â€” '+nome,text:txt})
      .catch(function(){});
  } else {
    var ta=document.createElement('textarea');ta.value=txt;document.body.appendChild(ta);ta.select();document.execCommand('copy');document.body.removeChild(ta);
    toast('Resumo copiado! Cole no WhatsApp ou e-mail.');
  }
}

function imprimirResumo(){
  window.print();
}

/* â•â• CONQUISTAS â•â• */
var CONQUISTAS_DEF=[
  {kg:1, ic:'â­',msg:'1 kg perdido!',sub:'A jornada comeÃ§a com um passo.',detalhe:'Cada grama perdido Ã© resultado de escolhas. VocÃª deu o primeiro passo â€” e isso muda tudo.'},
  {kg:3, ic:'ğŸ¥‰',msg:'3 kg â€” vocÃª estÃ¡ indo!',sub:'Disciplina visÃ­vel.',detalhe:'3 kg Ã© o equivalente a 3 potes de manteiga saindo do seu corpo. Sua determinaÃ§Ã£o estÃ¡ funcionando.'},
  {kg:5, ic:'ğŸ¥ˆ',msg:'5 kg â€” meio caminho!',sub:'Resultado concreto e real.',detalhe:'Estudos mostram que perder 5% do peso jÃ¡ melhora pressÃ£o, glicose e sono. VocÃª jÃ¡ estÃ¡ colhendo benefÃ­cios invisÃ­veis.'},
  {kg:10,ic:'ğŸ¥‡',msg:'10 kg â€” conquista extraordinÃ¡ria!',sub:'TransformaÃ§Ã£o de saÃºde real.',detalhe:'10 kg a menos significa articulaÃ§Ãµes mais saudÃ¡veis, coraÃ§Ã£o trabalhando menos e energia muito maior. Orgulhe-se.'},
  {kg:15,ic:'ğŸ†',msg:'15 kg â€” elite!',sub:'Menos de 5% chegam aqui.',detalhe:'VocÃª estÃ¡ no grupo de pacientes que mais se beneficiam do tratamento. Sua consistÃªncia Ã© o que chegou atÃ© aqui.'},
  {kg:20,ic:'ğŸ’',msg:'20 kg â€” lenda!',sub:'SaÃºde transformada para sempre.',detalhe:'20 kg perdidos com saÃºde e mÃ©todo. Isso nÃ£o Ã© dieta â€” Ã© uma mudanÃ§a permanente de vida. VocÃª chegou lÃ¡.'}
];
var _ultimaConquista=null;
function renderConquistas(perdido){
  if(!perdido||perdido<=0){el('msEl').style.display='none';return;}
  var todas=CONQUISTAS_DEF.filter(function(c){return perdido>=c.kg;});
  if(!todas.length){el('msEl').style.display='none';return;}
  var ultima=todas[todas.length-1];
  _ultimaConquista=ultima;
  el('msEl').style.display='flex';
  el('msIc').textContent=ultima.ic;
  el('msMsg').textContent=perdido.toFixed(1)+' kg perdidos â€” '+ultima.msg.split('â€”')[1]||ultima.msg;
  el('msSub').textContent=ultima.sub;
}
function abrirConquista(){
  if(!_ultimaConquista) return;
  var c=_ultimaConquista;
  el('modalConquistaIc').textContent=c.ic;
  el('modalConquistaTtl').textContent=c.msg;
  el('modalConquistaSub').textContent=c.sub;
  el('modalConquistaBody').textContent=c.detalhe;
  el('modalConquista').classList.add('open');
}

/* â•â• ROTEIRO PRIMEIROS PASSOS â•â• */
function renderChartSemanal(){
  var canvas=el('chartPesoSemanal');if(!canvas) return;
  if(!S.weights.length){if(chartSemanal){chartSemanal.destroy();chartSemanal=null;}return;}
  // Group weights by week from startDate
  var inicio=S.profile.startDate?new Date(S.profile.startDate+'T12:00:00'):null;
  var sorted=S.weights.slice().sort(porData);
  var weeks={};
  sorted.forEach(function(w){
    var dt=new Date(w.date+'T12:00:00');
    var semNum=inicio?Math.floor((dt-inicio)/(7*24*3600*1000))+1:1;
    if(semNum<1) semNum=1;
    if(!weeks[semNum]) weeks[semNum]=[];
    weeks[semNum].push(w.weight);
  });
  var semNums=Object.keys(weeks).map(Number).sort(function(a,b){return a-b;});
  var labels=semNums.map(function(n){return 'Sem '+n;});
  var values=semNums.map(function(n){
    var arr=weeks[n];
    return rd(arr.reduce(function(s,x){return s+x;},0)/arr.length,1);
  });
  // Color bars: green if falling, orange if same, red if rising
  var colors=values.map(function(v,i){
    if(i===0) return 'rgba(34,197,94,0.7)';
    return v<values[i-1]?'rgba(34,197,94,0.7)':v===values[i-1]?'rgba(251,191,36,0.7)':'rgba(239,68,68,0.7)';
  });
  var borderColors=colors.map(function(c){return c.replace('0.7','1');});
  var data={
    labels:labels,
    datasets:[{
      label:'MÃ©dia semanal (kg)',
      data:values,
      backgroundColor:colors,
      borderColor:borderColors,
      borderWidth:2,
      borderRadius:6,
      borderSkipped:false
    }]
  };
  var opts={
    responsive:true,maintainAspectRatio:false,
    plugins:{legend:{display:false},tooltip:{callbacks:{label:function(ctx){return ctx.parsed.y+' kg';}}}},
    scales:{
      x:{grid:{display:false},ticks:{font:{size:10},color:'#6b8f77'}},
      y:{grid:{color:'rgba(0,0,0,0.05)'},ticks:{font:{size:10},color:'#6b8f77',callback:function(v){return v+'kg';}},
         suggestedMin:function(){return Math.min.apply(null,values)-2;}()}
    }
  };
  if(chartSemanal){chartSemanal.data=data;chartSemanal.update();}
  else chartSemanal=new Chart(canvas,{type:'bar',data:data,options:opts});
}


/* â•â• FAQ â•â• */
var FAQ=[
  {cat:'ğŸ’‰ MedicaÃ§Ã£o',ic:'ğŸ’‰',q:'Esqueci de tomar a dose semanal. O que faÃ§o?',a:'Se lembrou no mesmo dia ou no dia seguinte: aplique normalmente. Se jÃ¡ passou mais de 2 dias: pule essa dose e aplique na prÃ³xima data prevista. Nunca tome duas doses para compensar.'},
  {cat:'ğŸ’‰ MedicaÃ§Ã£o',ic:'ğŸ’‰',q:'Posso mudar o dia da aplicaÃ§Ã£o semanal?',a:'Sim. VocÃª pode mudar o dia desde que mantenha pelo menos 4 dias de intervalo entre as doses. ApÃ³s a mudanÃ§a, mantenha o novo dia fixo toda semana.'},
  {cat:'ğŸ’‰ MedicaÃ§Ã£o',ic:'ğŸ’‰',q:'Posso tomar com outros remÃ©dios?',a:'Informe sempre ao seu mÃ©dico todos os medicamentos em uso. AtenÃ§Ã£o especial com: insulina, antidiabÃ©ticos orais, anticoagulantes e remÃ©dios para tireoide. O GLP-1 pode alterar a absorÃ§Ã£o de medicamentos orais.'},
  {cat:'ğŸ’‰ MedicaÃ§Ã£o',ic:'ğŸ’‰',q:'Por quanto tempo vou precisar usar o GLP-1?',a:'O tratamento Ã© geralmente de longo prazo. Estudos mostram que interromper sem mudanÃ§a de hÃ¡bitos leva Ã  recuperaÃ§Ã£o de peso em atÃ© 12 meses. Converse com seu mÃ©dico sobre a duraÃ§Ã£o ideal para vocÃª.'},
  {cat:'ğŸ’‰ MedicaÃ§Ã£o',ic:'ğŸ’‰',q:'Posso tomar Ã¡lcool durante o tratamento?',a:'Ãlcool Ã© permitido com moderaÃ§Ã£o, mas pode piorar nÃ¡usea e tontura. AlÃ©m disso, bebidas alcoÃ³licas sÃ£o calÃ³ricas e podem comprometer os resultados. Se tomar, prefira nas refeiÃ§Ãµes e hidrate bem.'},
  {cat:'ğŸ’‰ MedicaÃ§Ã£o',ic:'ğŸ’‰',q:'O remÃ©dio precisa de geladeira?',a:'Sim. Frascos e canetas nÃ£o abertos: guardar entre 2Â°C e 8Â°C na geladeira. ApÃ³s abrir: pode ficar em temperatura ambiente (atÃ© 30Â°C) por atÃ© 28 dias. Nunca congele. Proteja da luz solar.'},
  {cat:'ğŸ¤¢ Efeitos colaterais',ic:'ğŸ¤¢',q:'NÃ¡usea intensa â€” Ã© normal? Quanto tempo dura?',a:'NÃ¡usea Ã© o efeito colateral mais comum, especialmente nas primeiras semanas ou apÃ³s aumento de dose. Dicas: coma devagar, volumes menores, proteÃ­na primeiro, nÃ£o deite apÃ³s comer. Geralmente melhora em 2 a 4 semanas. Se persistir intensa por mais de 7 dias, avise seu mÃ©dico.'},
  {cat:'ğŸ¤¢ Efeitos colaterais',ic:'ğŸ¤¢',q:'Estou com constipaÃ§Ã£o (intestino preso). O que faÃ§o?',a:'Aumente a ingestÃ£o de Ã¡gua imediatamente â€” esse Ã© o passo mais importante. Adicione fibras gradualmente (frutas, legumes, aveia). Ameixa, mamÃ£o e kiwi ajudam. Se passar de 5 dias sem evacuar, avise seu mÃ©dico. NÃ£o use laxantes sem orientaÃ§Ã£o.'},
  {cat:'ğŸ¤¢ Efeitos colaterais',ic:'ğŸ¤¢',q:'Estou sem apetite nenhum. Preciso comer mesmo assim?',a:'Sim! AusÃªncia de fome Ã© efeito do GLP-1, mas vocÃª precisa comer o mÃ­nimo de proteÃ­na diÃ¡ria para proteger seus mÃºsculos. Foque em: ovos, cottage, iogurte grego, whey protein â€” alimentos proteicos de fÃ¡cil ingestÃ£o mesmo sem fome. Avise seu mÃ©dico se nÃ£o conseguir comer.'},
  {cat:'ğŸ¤¢ Efeitos colaterais',ic:'ğŸ¤¢',q:'Sinto tontura. O que pode ser?',a:'Pode ser desidrataÃ§Ã£o (beba mais Ã¡gua), queda de pressÃ£o ao levantar rÃ¡pido (levante devagar), ou hipoglicemia se usar insulina concomitantemente. Tontura intensa com suor frio â†’ procure emergÃªncia imediatamente.'},
  {cat:'ğŸ¤¢ Efeitos colaterais',ic:'ğŸ¤¢',q:'Estou com refluxo e azia. O que faÃ§o?',a:'O GLP-1 retarda o esvaziamento gÃ¡strico, o que pode causar refluxo. Dicas: nÃ£o deite por 2 a 3 horas apÃ³s comer, refeiÃ§Ãµes menores e mais frequentes, evite cafÃ© e alimentos gordurosos Ã  noite, eleve a cabeceira da cama. Se persistente, avise seu mÃ©dico.'},
  {cat:'âš–ï¸ Sobre o peso',ic:'âš–ï¸',q:'Parei de emagrecer. O que estÃ¡ acontecendo?',a:'PlatÃ´s sÃ£o normais e esperados â€” o corpo se adapta. Verifique: proteÃ­na estÃ¡ na meta? Ãgua em dia? Sono de qualidade? Atividade fÃ­sica? Ã€s vezes o platÃ´ coincide com aumento de dose. NÃ£o entre em pÃ¢nico â€” continue os hÃ¡bitos e o peso voltarÃ¡ a cair.'},
  {cat:'âš–ï¸ Sobre o peso',ic:'âš–ï¸',q:'Engordei um pouco essa semana. Errei?',a:'NÃ£o necessariamente. VariaÃ§Ãµes de 1 a 2 kg no dia a dia sÃ£o normais e refletem Ã¡gua, sal, intestino e ciclo menstrual. Confie na tendÃªncia de 7 a 14 dias, nÃ£o no peso de um Ãºnico dia. Pesar sempre no mesmo horÃ¡rio (manhÃ£, em jejum) dÃ¡ mais consistÃªncia.'},
  {cat:'âš–ï¸ Sobre o peso',ic:'âš–ï¸',q:'Posso pesar todo dia?',a:'Pode, mas com cautela emocional. Pesar diariamente ajuda a ver tendÃªncias, mas variaÃ§Ãµes normais podem gerar ansiedade desnecessÃ¡ria. Se te afeta emocionalmente, pese 2 a 3 vezes por semana, sempre no mesmo horÃ¡rio e condiÃ§Ãµes.'},
  {cat:'ğŸ½ï¸ AlimentaÃ§Ã£o',ic:'ğŸ½ï¸',q:'Preciso fazer dieta restritiva junto com o GLP-1?',a:'NÃ£o precisa de dieta radical. O GLP-1 reduz a fome naturalmente. Foque em: proteÃ­na em toda refeiÃ§Ã£o, comer devagar, volumes menores. Evite ultra-processados e excesso de aÃ§Ãºcar. A meta calÃ³rica do app jÃ¡ estÃ¡ calculada para vocÃª.'},
  {cat:'ğŸ½ï¸ AlimentaÃ§Ã£o',ic:'ğŸ½ï¸',q:'Posso fazer jejum intermitente junto?',a:'Ã‰ possÃ­vel, mas nÃ£o Ã© necessÃ¡rio e pode ser contraproducente com GLP-1 â€” vocÃª jÃ¡ come menos naturalmente. Se optar pelo jejum, garanta que a janela de alimentaÃ§Ã£o seja suficiente para atingir a meta de proteÃ­na. Converse com seu mÃ©dico antes.'},
  {cat:'ğŸ½ï¸ AlimentaÃ§Ã£o',ic:'ğŸ½ï¸',q:'Preciso tomar suplementos?',a:'Com alimentaÃ§Ã£o reduzida, os mais relevantes sÃ£o: proteÃ­na (whey se nÃ£o atingir a meta), vitamina D (a maioria tem deficiÃªncia), B12 (se vegetariano ou dieta muito restrita), magnÃ©sio (ajuda no sono e energia). Converse com seu mÃ©dico para solicitar exames.'},
  {cat:'ğŸƒ ExercÃ­cio',ic:'ğŸƒ',q:'Preciso malhar para emagrecer com GLP-1?',a:'NÃ£o Ã© obrigatÃ³rio para emagrecer, mas Ã© fundamental para preservar mÃºsculo. Com GLP-1 vocÃª perde gordura E mÃºsculo se nÃ£o se exercitar. MusculaÃ§Ã£o 2 a 3x por semana Ã© o ideal. Se nÃ£o pode malhar, caminhadas diÃ¡rias jÃ¡ ajudam muito.'},
  {cat:'ğŸƒ ExercÃ­cio',ic:'ğŸƒ',q:'Qual o melhor exercÃ­cio para fazer junto com GLP-1?',a:'MusculaÃ§Ã£o Ã© o mais importante â€” preserva mÃºsculo durante a perda de peso. Combine com cardio moderado (caminhada, bike) para saÃºde cardiovascular. Evite exercÃ­cio intenso nas primeiras semanas se tiver nÃ¡usea.'},
  {cat:'ğŸ’Š Posologia',ic:'ğŸ’Š',q:'Posso aumentar a dose por conta prÃ³pria?',a:'Nunca. A progressÃ£o de dose Ã© mÃ©dica e individual. Aumentar sem orientaÃ§Ã£o pode causar efeitos colaterais intensos e desnecessÃ¡rios. A dose ideal Ã© a menor que garante saciedade â€” nÃ£o Ã© sempre a mÃ¡xima.'},
  {cat:'ğŸ’Š Posologia',ic:'ğŸ’Š',q:'Qual a diferenÃ§a entre Ozempic, Wegovy e Saxenda?',a:'Ozempic e Wegovy tÃªm o mesmo princÃ­pio ativo (semaglutida), mas Wegovy tem doses mais altas aprovadas para obesidade. Saxenda usa liraglutida, de aplicaÃ§Ã£o DIÃRIA. Mounjaro usa tirzepatida, com aÃ§Ã£o dupla (GLP-1 e GIP) e geralmente maior perda de peso.'},
  {cat:'ğŸ’Š Posologia',ic:'ğŸ’Š',q:'Saxenda Ã© diÃ¡rio ou semanal?',a:'DIÃRIO. Saxenda (liraglutida) Ã© aplicado uma vez por dia, sempre no mesmo horÃ¡rio. Ã‰ diferente de Ozempic, Wegovy e Mounjaro que sÃ£o semanais. NÃ£o confunda a posologia â€” aplicar semanalmente o Saxenda compromete o tratamento.'},
];

var _faqAbertos={};
function buildFAQ(){
  var wrap=el('faqLista');if(!wrap) return;
  wrap.innerHTML='';
  var cats={};
  FAQ.forEach(function(f,i){if(!cats[f.cat]) cats[f.cat]=[];cats[f.cat].push({...f,idx:i});});
  Object.keys(cats).forEach(function(cat){
    var sec=document.createElement('div');
    sec.style.cssText='margin-bottom:14px';
    sec.innerHTML='<div style="font-size:11px;font-weight:700;text-transform:uppercase;letter-spacing:.5px;color:var(--muted);margin-bottom:8px;padding:0 2px">'+cat+'</div>';
    var list=document.createElement('div');
    list.style.cssText='border:1px solid var(--cream3);border-radius:12px;overflow:hidden;background:#fff';
    cats[cat].forEach(function(f,ci){
      var item=document.createElement('div');
      item.setAttribute('data-faq',f.idx);
      item.style.cssText='border-top:'+(ci>0?'1px solid var(--cream2)':'none');
      item.innerHTML='<button onclick="toggleFAQ('+f.idx+')" style="width:100%;padding:14px 16px;text-align:left;border:none;background:none;font-family:var(--ss);font-size:13px;font-weight:600;color:var(--ink);cursor:pointer;display:flex;justify-content:space-between;align-items:center;gap:10px"><span>'+f.q+'</span><span id="faq-arr-'+f.idx+'" style="flex-shrink:0;font-size:11px;color:var(--muted);transition:transform .2s">â–¾</span></button>'
        +'<div id="faq-body-'+f.idx+'" style="display:none;padding:0 16px 14px;font-size:13px;color:var(--ink3);line-height:1.7">'+f.a+'</div>';
      list.appendChild(item);
    });
    sec.appendChild(list);
    wrap.appendChild(sec);
  });
}
function toggleFAQ(idx){
  var body=el('faq-body-'+idx);
  var arr=el('faq-arr-'+idx);
  var open=body.style.display!=='none'&&body.style.display!=='';
  // Close all
  FAQ.forEach(function(f,i){
    var b=el('faq-body-'+i);var a=el('faq-arr-'+i);
    if(b){b.style.display='none';}if(a){a.style.transform='';}
  });
  if(!open){body.style.display='block';arr.style.transform='rotate(180deg)';}
}
function filtrarFAQ(q){
  q=q.toLowerCase().trim();
  var wrap=el('faqLista');
  if(!q){buildFAQ();el('faqNenhum').style.display='none';return;}
  var found=FAQ.filter(function(f){return f.q.toLowerCase().includes(q)||f.a.toLowerCase().includes(q)||f.cat.toLowerCase().includes(q);});
  if(!found.length){wrap.innerHTML='';el('faqNenhum').style.display='block';return;}
  el('faqNenhum').style.display='none';
  wrap.innerHTML='';
  var list=document.createElement('div');
  list.style.cssText='border:1px solid var(--cream3);border-radius:12px;overflow:hidden;background:#fff';
  found.forEach(function(f,ci){
    var idx=FAQ.indexOf(f);
    var item=document.createElement('div');
    item.style.cssText='border-top:'+(ci>0?'1px solid var(--cream2)':'none');
    item.innerHTML='<button onclick="toggleFAQ('+idx+')" style="width:100%;padding:14px 16px;text-align:left;border:none;background:none;font-family:var(--ss);font-size:13px;font-weight:600;color:var(--ink);cursor:pointer;display:flex;justify-content:space-between;align-items:center;gap:10px"><span>'+f.q+'</span><span id="faq-arr-'+idx+'" style="flex-shrink:0;font-size:11px;color:var(--muted)">â–¾</span></button>'
      +'<div id="faq-body-'+idx+'" style="display:none;padding:0 16px 14px;font-size:13px;color:var(--ink3);line-height:1.7">'+f.a+'</div>';
    list.appendChild(item);
  });
  wrap.appendChild(list);
}

/* â•â• MANUAL â•â• */
var PASSOS_CANETA=[
  {n:1,ic:'ğŸ§Š',t:'Retire da geladeira',d:'Retire a caneta da geladeira 30 minutos antes. Aplicar fria aumenta o desconforto.'},
  {n:2,ic:'ğŸ”',t:'Verifique a validade',d:'Confira a data de validade e o aspecto do lÃ­quido. Deve ser transparente e incolor. NÃ£o use se turvo ou com partÃ­culas.'},
  {n:3,ic:'ğŸ§´',t:'Higienize as mÃ£os',d:'Lave as mÃ£os com Ã¡gua e sabÃ£o por pelo menos 20 segundos antes de manusear a caneta.'},
  {n:4,ic:'ğŸ©¹',t:'Escolha o local',d:'AbdÃ´men (preferencial), coxa ou parte superior do braÃ§o. Limpe com Ã¡lcool 70% e aguarde secar completamente.'},
  {n:5,ic:'ğŸ”©',t:'Encaixe a agulha',d:'Retire a tampa externa da caneta. Encaixe uma agulha nova girando no sentido horÃ¡rio atÃ© firmar. Retire as tampas da agulha.'},
  {n:6,ic:'ğŸ’‰',t:'Prime (purga de ar)',d:'Aponte a caneta para cima. Pressione o botÃ£o atÃ© aparecer uma gota de lÃ­quido. Isso remove o ar e confirma que a caneta estÃ¡ funcionando.'},
  {n:7,ic:'ğŸ«´',t:'FaÃ§a a prega (se necessÃ¡rio)',d:'Em pessoas mais magras, faÃ§a uma prega na pele com os dedos. Em abdÃ´men com gordura suficiente, nÃ£o Ã© necessÃ¡rio.'},
  {n:8,ic:'â–¶ï¸',t:'Aplique',d:'Insira a agulha em Ã¢ngulo de 90Â°. Pressione e segure o botÃ£o atÃ© o contador chegar a 0. Mantenha pressionado por 10 segundos apÃ³s.'},
  {n:9,ic:'ğŸ—‘ï¸',t:'Descarte com seguranÃ§a',d:'Recoloque a tampa externa da agulha sem reencapar com a mÃ£o. Remova a agulha e descarte em recipiente rÃ­gido (pode de plÃ¡stico grosso). Nunca no lixo comum.'}
];
var PASSOS_AMPOLA=[
  {n:1,ic:'ğŸ§Š',t:'Retire da geladeira',d:'Retire o frasco 30 minutos antes para atingir temperatura ambiente. Isso facilita a aspiraÃ§Ã£o.'},
  {n:2,ic:'ğŸ§´',t:'Higienize as mÃ£os',d:'Lave as mÃ£os com Ã¡gua e sabÃ£o por pelo menos 20 segundos.'},
  {n:3,ic:'ğŸ”',t:'Confira a calculadora',d:'Veja na aba Caneta â†’ Calculadora quantas unidades de insulina vocÃª precisa aspirar para sua dose em mg.'},
  {n:4,ic:'ğŸ©º',t:'Limpe a tampa do frasco',d:'Limpe a tampa de borracha com Ã¡lcool 70% e deixe secar por 15 a 30 segundos.'},
  {n:5,ic:'ğŸ’¨',t:'Aspire ar na seringa',d:'Puxe o Ãªmbolo aspirando a mesma quantidade de ar que vai aspirar de lÃ­quido (ex: 50 unidades de ar para 50 UI de lÃ­quido).'},
  {n:6,ic:'â¬‡ï¸',t:'Injete ar no frasco',d:'Insira a agulha no frasco e injete o ar. Isso cria pressÃ£o positiva facilitando a aspiraÃ§Ã£o do lÃ­quido.'},
  {n:7,ic:'ğŸ”„',t:'Inverta o frasco',d:'Com a agulha ainda inserida, inverta o frasco. Aspire lentamente atÃ© a dose marcada na seringa.'},
  {n:8,ic:'ğŸ«§',t:'Elimine bolhas de ar',d:'Com a agulha apontada para cima, dÃª leves batidinhas na seringa. Pressione levemente o Ãªmbolo para expulsar as bolhas. Reajuste a dose se necessÃ¡rio.'},
  {n:9,ic:'ğŸ©¹',t:'Escolha e limpe o local',d:'AbdÃ´men (preferencial), coxa ou braÃ§o. Limpe com Ã¡lcool 70% e aguarde secar completamente.'},
  {n:10,ic:'ğŸ’‰',t:'Aplique',d:'FaÃ§a uma prega na pele. Insira a agulha em 90Â° (ou 45Â° em pessoas muito magras). Injete lentamente. Segure 10 segundos antes de retirar.'},
  {n:11,ic:'ğŸ—‘ï¸',t:'Descarte com seguranÃ§a',d:'Descarte a seringa usada em recipiente rÃ­gido (coletor de perfurocortantes ou cano PVC tampado). Nunca no lixo comum.'}
];
function buildPassos(passos, wrId){
  var wrap=el(wrId);if(!wrap) return;
  wrap.innerHTML='';
  passos.forEach(function(p){
    var div=document.createElement('div');
    div.style.cssText='display:flex;gap:12px;padding:12px 0;border-bottom:1px solid var(--cream2)';
    div.innerHTML='<div style="width:28px;height:28px;border-radius:50%;background:var(--g600);color:#fff;font-size:12px;font-weight:700;display:flex;align-items:center;justify-content:center;flex-shrink:0">'+p.n+'</div>'
      +'<div><div style="font-size:13px;font-weight:700;color:var(--ink);margin-bottom:3px">'+p.ic+' '+p.t+'</div><div style="font-size:12px;color:var(--ink3);line-height:1.6">'+p.d+'</div></div>';
    wrap.appendChild(div);
  });
}
function mostrarManual(tipo){
  el('manualCaneta').style.display=tipo==='caneta'?'block':'none';
  el('manualAmpola').style.display=tipo==='ampola'?'block':'none';
  el('manBtn1').className='btn '+(tipo==='caneta'?'bp':'bg2');
  el('manBtn2').className='btn '+(tipo==='ampola'?'bp':'bg2');
}

/* â•â• AÃ‡Ã•ES â•â• */
function salvarPerfil(){
  var age=nv(el('idade').value),h=nv(el('altura').value),w=nv(el('peso').value);
  if(!age||!h||!w){alert('Preencha idade, altura e peso.');return;}
  S.profile.sex=el('sexo').value;S.profile.age=age;S.profile.heightCm=h;S.profile.activityLevel=el('ativ').value;S.profile.startDate=el('dtIni').value||hoje();S.profile.weightKg=w;
  var pi=nv(el('pesoI').value);if(pi) S.profile.weightStartKg=pi;if(!S.profile.weightStartKg) S.profile.weightStartKg=w;
  var pg=nv(el('pesoMeta').value);if(pg) S.profile.weightGoalKg=pg;
  if(!S.weights.length) S.weights.push({date:hoje(),weight:w});
  render();go('dashboard');toast('Perfil salvo! ğŸ¯');
}
function salvarCaneta(){
  var f=el('cFarm').value;if(!f){alert('Selecione o fÃ¡rmaco.');return;}
  S.caneta.farmaco=f;S.caneta.dose=el('cDose').value;S.caneta.freq=el('cFreq').value;S.caneta.inicio=el('cIni').value;S.caneta.ultima=el('cUlt').value;S.caneta.diaSem=nv(el('cDia').value,1);S.caneta.obs=el('cObs').value;
  render();toast('Tratamento salvo! ğŸ’‰');
}
function updateDoses(){
  var f=el('cFarm').value,s=el('cDose');s.innerHTML='<option value="">â€” selecione a dose â€”</option>';
  if(!f) return;(DOSES[f]||[]).forEach(function(d){var o=document.createElement('option');o.value=d.dose;o.textContent=d.dose+' ('+d.sem+')';s.appendChild(o);});
  el('cFreq').value=f==='Liraglutida'?'diaria':'semanal';el('diaSemW').style.display=f==='Liraglutida'?'none':'block';
}
function addPeso(){
  var date=el('pData').value||hoje(),w=nv(el('pVal').value);if(!w){alert('Digite um peso.');return;}
  var i=S.weights.findIndex(function(x){return x.date===date;});if(i>=0) S.weights[i].weight=w;else S.weights.push({date:date,weight:w});
  S.profile.weightKg=w;if(!S.profile.weightStartKg) S.profile.weightStartKg=w;
  el('pVal').value='';render();toast('Peso salvo âœ…');
}
function delPeso(){
  if(!S.weights.length){alert('Sem pesagens.');return;}if(!confirm('Apagar Ãºltima pesagem?')) return;
  S.weights.sort(porData);S.weights.pop();render();
}
function exportar(){var a=document.createElement('a');a.href='data:application/json;charset=utf-8,'+encodeURIComponent(JSON.stringify(Object.assign({},S,{exportedAt:new Date().toISOString()}),null,2));a.download='equilibra_v5.json';a.click();}
function importar(){var i=document.createElement('input');i.type='file';i.accept='application/json';i.onchange=function(e){var f=e.target.files[0];if(!f) return;var r=new FileReader();r.onload=function(ev){try{var d=JSON.parse(ev.target.result);if(!d.profile) throw new Error('JSON invÃ¡lido.');S={profile:d.profile,caneta:d.caneta||{farmaco:'',dose:'',freq:'semanal',faseSac:'',inicio:'',ultima:'',diaSem:1,obs:''},weights:d.weights||[],daily:d.daily||[]};if(!S.caneta.faseSac) S.caneta.faseSac='';render();toast('Importado! âœ…');}catch(err){alert('Falha: '+err.message);}};r.readAsText(f);};i.click();}
function abrirReset(){el('modalReset').classList.add('open');}
function refazerAnamnese(){
  el('modalAna').classList.add('open');
}
function confirmarRefazer(){
  el('modalAna').classList.remove('open');
  var bkpW=S.weights.slice();var bkpD=S.daily.slice();
  S.profile={sex:'M',age:null,heightCm:null,activityLevel:'Moderada',startDate:'',weightStartKg:null,weightKg:null};
  S.caneta={farmaco:'',dose:'',freq:'semanal',faseSac:'',inicio:'',ultima:'',diaSem:1,obs:''};
  S.weights=bkpW;S.daily=bkpD;
  ANA.step=0;ANA.data={};
  el('anaMsgs').innerHTML='';el('anaInput').innerHTML='';
  el('anaFill').style.width='0%';
  var ov=el('anaOv');
  ov.style.position='fixed';ov.style.inset='0';ov.style.zIndex='900';
  ov.style.background='#030f06';ov.style.display='flex';
  ov.style.flexDirection='column';ov.style.overflow='hidden';
  el('mainHdr').style.display='none';
  el('mainWrap').style.display='none';
  el('ceFab').style.display='none';
  anaInit();
}
function fecharReset(){el('modalReset').classList.remove('open');}
function confirmarReset(){localStorage.removeItem(LS);location.reload();}
el('modalReset').addEventListener('click',function(e){if(e.target===this) fecharReset();});

/* â•â• NAV â•â• */
function toggleExp(id,btn){var b=el(id);var o=b.classList.contains('open');b.classList.toggle('open',!o);btn.classList.toggle('open',!o);}
function popularPerfil(){
  if(el('sexo')) el('sexo').value=S.profile.sex||'M';
  if(el('idade')) el('idade').value=S.profile.age||'';
  if(el('altura')) el('altura').value=S.profile.heightCm||'';
  if(el('peso')) el('peso').value=S.profile.weightKg||'';
  if(el('pesoI')) el('pesoI').value=S.profile.weightStartKg||'';
  if(el('pesoMeta')) el('pesoMeta').value=S.profile.weightGoalKg||'';
  if(el('ativ')) el('ativ').value=S.profile.activityLevel||'Moderada';
  if(el('dtIni')) el('dtIni').value=S.profile.startDate||'';
}
function popularCaneta(){
  var cf=el('cFarm');if(!cf) return;
  if(S.caneta.farmaco){
    cf.value=S.caneta.farmaco;
    if(typeof updateDoses==='function') updateDoses();
    // dose deve ser setada DEPOIS de updateDoses popular as opÃ§Ãµes
    if(S.caneta.dose){
      var cd=el('cDose');
      if(cd) cd.value=String(S.caneta.dose);
    }
  }
  if(el('cFreq')&&S.caneta.freq) el('cFreq').value=S.caneta.freq;
  if(el('cIni')&&S.caneta.inicio) el('cIni').value=S.caneta.inicio;
  if(el('cUlt')&&S.caneta.ultima) el('cUlt').value=S.caneta.ultima;
  if(el('cDia')&&S.caneta.diaSem!=null) el('cDia').value=String(S.caneta.diaSem);
  if(el('cObs')&&S.caneta.obs) el('cObs').value=S.caneta.obs;
}
function go(id){
  document.querySelectorAll('.sec').forEach(function(s){s.classList.remove('on');});
  document.querySelectorAll('.tb').forEach(function(b){b.classList.remove('on');});
  var sec=el('sec-'+id);if(sec) sec.classList.add('on');
  var tb=el('nb-'+id);if(tb) tb.classList.add('on');
  window.scrollTo({top:0,behavior:'smooth'});
  if(id==='checkin'){
    initProtChips();
    var av=nv(el('ciAgua').value,0);
    var disp=el('aguaCoposDisplay');
    if(disp&&av>0){var copos=Math.round(av/250);disp.textContent=copos+' copo'+(copos!==1?'s':'')+' ('+(av/1000).toFixed(1)+'L)';}
  }
  if(id==='perfil') popularPerfil();
  if(id==='caneta') popularCaneta();
}
function abrirMais(){el('maisOv').style.display='block';document.body.style.overflow='hidden';}
function fecharMais(){el('maisOv').style.display='none';document.body.style.overflow='';}
function toast(msg){var t=el('toastEl');if(!t){t=document.createElement('div');t.id='toastEl';t.style.cssText='position:fixed;bottom:90px;left:50%;transform:translateX(-50%);background:var(--g700);color:#fff;padding:10px 20px;border-radius:999px;font-size:14px;font-weight:600;z-index:999;box-shadow:0 4px 20px rgba(0,0,0,.2);transition:opacity .3s';document.body.appendChild(t);}t.textContent=msg;t.style.opacity='1';clearTimeout(t._t);t._t=setTimeout(function(){t.style.opacity='0';},2500);}

/* â•â• INIT â•â• */
window.addEventListener('DOMContentLoaded',function(){
// Sempre limpar e abrir anamnese â€” versÃ£o de validaÃ§Ã£o
try{localStorage.clear();}catch(e){}
carregar();
if(el('pData')) el('pData').value=hoje();
if(el('anaOv')){el('anaOv').style.display='flex';anaInit();}
});</script>
</body>
</html>
